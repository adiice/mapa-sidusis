<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>SIDUSIS – Dashboard KPI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --card-bg:#fff; --card-br:#e5e7eb; --muted:#6b7280; --ink:#111827; --accent:#374151;
  }
  html,body{margin:0;padding:0;font-family:system-ui, Segoe UI, Roboto, Arial;background:#f3f4f6;color:var(--ink)}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 16px}
  .bar{display:flex;gap:8px;align-items:end;flex-wrap:wrap;margin-bottom:16px}
  .bar .f{display:flex;flex-direction:column}
  .bar input,.bar select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;font:inherit;background:#fff}
  .bar button{padding:9px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#eef2ff;cursor:pointer}
  .status{margin-top:10px;font-size:12px;color:var(--muted)}
  .cards{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px;margin:18px 0}
  .card{background:var(--card-bg);border:1px solid var(--card-br);border-radius:14px;padding:16px}
  .card h3{margin:0 0 8px;font-size:14px;color:var(--accent);font-weight:600}
  .big{font-size:28px;font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .error{background:#fff3f3;border:1px solid #fca5a5;color:#991b1b;border-radius:10px;padding:10px;display:none}
  .credit{
    position:fixed; right:10px; bottom:8px; z-index:9999;
    background:#ffffffd9; backdrop-filter: blur(4px);
    border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; color:#374151;
  }
  @media (max-width:900px){ .cards{grid-template-columns:1fr} }
  
  .credit{
  position:fixed; right:10px; bottom:8px; z-index:9999;
  background:#ffffffd9; backdrop-filter: blur(4px);
  border:1px solid #e5e7eb; border-radius:999px;
  padding:6px 10px; font-size:12px; color:#374151;
}
  
</style>

<!-- MSAL loader (z fallbackiem) -->
<script>
  function loadScriptSequential(urls){
    return new Promise((resolve,reject)=>{
      let i=0; const next=()=>{
        if(i>=urls.length) return reject(new Error("Nie udało się załadować msal-browser."));
        const s=document.createElement('script'); s.src=urls[i++]; s.async=true;
        s.onload=()=>resolve(); s.onerror=()=>next(); document.head.appendChild(s);
      }; next();
    });
  }
  const MSAL_CDNS=[
    'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
    'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
  ];
</script>
</head>

<body>
<div class="wrap">
  <h1>SIDUSIS – Dashboard KPI</h1>

  <!-- Pasek filtrów (PH + zakres dat po dacie zgłoszenia) -->
  <div class="bar">
    <div class="f">
      <label>PH</label>
      <select id="fPH"><option value="">(wszyscy)</option></select>
    </div>
    <div class="f">
      <label>Zakres od</label>
      <input type="date" id="fFrom">
    </div>
    <div class="f">
      <label>…do</label>
      <input type="date" id="fTo">
    </div>
    <div class="f">
      <button id="btnReload">Odśwież z Excela</button>
    </div>
  </div>

  <!-- Kafelki KPI – średnie czasy -->
  <div class="cards">
    <div class="card"><h3>Lead → Wycena</h3><div class="big" id="kpiL2E">–</div><div class="muted" id="kpiL2Einfo">–</div></div>
    <div class="card"><h3>Wycena → Oferta</h3><div class="big" id="kpiE2O">–</div><div class="muted" id="kpiE2Oinfo">–</div></div>
    <div class="card"><h3>Oferta → Zamknięcie</h3><div class="big" id="kpiO2C">–</div><div class="muted" id="kpiO2Cinfo">–</div></div>
  </div>

  <div class="error" id="errorBox"></div>
  <div class="status" id="statusBox">Gotowe.</div>
</div>

<!-- Dyskretna stopka z autorem (możesz przenieść/usunąć) -->
<div class="credit">Autor: Adrian Daniel</div>

<script>
(async function main(){
  /* ======================== KONFIG + STAN ======================== */
  const CONFIG = {
    clientId: "2c5a0274-30c0-4efa-b13c-7ce1e0768cf9",
    tenantId: "e44d0310-65ed-4096-a024-dac77110765a",
    spHost: "internetunion.sharepoint.com",
    spSitePath: "PHTheNetwork",
    filePath: "/General/Kopia pliku Lista - SIDUSIS - PEŁNA - od 08-2025 - kopia do mapy.xlsx",
    dataSheet: "Dane",
    logSheet: "AuditLog"
  };

  // wyłączone z KPI / czasów / konwersji:
  const EXCLUDED_STATUS = new Set(["KPO","Poza Zasięgiem","MOICO","Duplikat","SEEV"]);
  const STATUS_TARGETS = {
    est: "Wycena Inwestycji",
    offer: "Oferta wysłana",
    won: "Akceptacja klienta",
    lost: "Odmowa klienta"
  };

  let account=null, siteId=null, fileId=null;
  let rows=[];            // wiersze z "Dane"
  let logs=[];            // wiersze z "AuditLog"
  let byAddrCurrent={};   // adres_norm -> bieżący status (z "Dane")
  let phSet=new Set();    // unikalne PH do filtra

  const $ = s=>document.querySelector(s);
  const statusBox=$("#statusBox"), errBox=$("#errorBox");

  const esc = s => String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const norm = s => String(s||"").toLowerCase().replace(/\s+/g," ").trim();

  function toDate(v){
    if(v==null || v==="") return null;
    if(typeof v==="number"){ const d = new Date(Date.UTC(1899,11,30)); d.setUTCDate(d.getUTCDate()+Math.floor(v)); return d; }
    const s=String(v).trim(); const d1 = new Date(s); if(!isNaN(d1)) return d1;
    const m = s.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
    if(m){ const [_,dd,mm,yy]=m; return new Date(Number(yy.length===2?("20"+yy):yy), Number(mm)-1, Number(dd)); }
    return null;
  }
  const diffDays = (a,b)=> (b-a)/(1000*60*60*24);
  const fmtDays = d => isFinite(d) ? (d>=1 ? d.toFixed(1)+" dnia" : (d*24).toFixed(0)+" h") : "–";

  function setStatus(s){ statusBox.textContent = s; }
  function showError(e){ errBox.textContent = String(e||"Błąd"); errBox.style.display="block"; setTimeout(()=>errBox.style.display="none", 7000); }

  /* ======================== MSAL/GRAPH ======================== */
  try { await loadScriptSequential(MSAL_CDNS); } 
  catch(e){ alert("Brak msal-browser."); console.error(e); return; }
  if(typeof msal==='undefined' || !msal.PublicClientApplication){ alert("MSAL niedostępny."); return; }

  const msalApp = new msal.PublicClientApplication({
    auth:{ clientId:CONFIG.clientId, authority:"https://login.microsoftonline.com/"+CONFIG.tenantId,
           redirectUri: window.location.origin + window.location.pathname },
    cache:{ cacheLocation:"localStorage", storeAuthStateInCookie:false }
  });
  /* const graphScopes=["openid","profile","offline_access","Files.Read.All","Files.ReadWrite.All","Sites.Read.All"]; */
  const graphScopes = ["openid","profile","offline_access","Files.ReadWrite.All","Sites.Read.All"];


  async function ensureLogin(){
    const accs = msalApp.getAllAccounts();
    if(accs.length){ account=accs[0]; return; }
    const r = await msalApp.loginPopup({ scopes: graphScopes }); account=r.account;
  }
  async function getToken(){
    await ensureLogin();
    try{ const r=await msalApp.acquireTokenSilent({ scopes:graphScopes, account }); return r.accessToken; }
    catch{ const r=await msalApp.acquireTokenPopup({ scopes:graphScopes }); return r.accessToken; }
  }
  async function gfetch(method, url, body){
    const token = await getToken();
    const resp = await fetch(url,{
      method,
      headers:{ "Authorization":"Bearer "+token, "Accept":"application/json", "Content-Type":"application/json" },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!resp.ok){
      const txt=await resp.text().catch(()=>String(resp.status));
      throw new Error(`${method} ${url} -> ${resp.status} ${txt}`);
    }
    return resp.status===204 ? null : resp.json();
  }
  async function getSiteId(){
    if(siteId) return siteId;
    const js = await gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${CONFIG.spHost}:/sites/${CONFIG.spSitePath}`);
    siteId = js.id; return siteId;
  }
  async function getFileItemId(){
    if(fileId) return fileId;
    const sid=await getSiteId();
    const js = await gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${sid}/drive/root:${encodeURI(CONFIG.filePath)}`);
    fileId = js.id; return fileId;
  }
  async function usedRange(wsName){
    const [sid,iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const wsq = wsName.replace(/'/g,"''");
    return gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/usedRange(valuesOnly=true)`);
  }

  /* ======================== ŁADOWANIE DANYCH ======================== */
  function pickHeader(headers, keywords){
    const lc=headers.map(h=>String(h||"").toLowerCase());
    for(const t of keywords){ const i=lc.findIndex(n=>n.includes(t)); if(i>=0) return headers[i]; }
    return null;
  }

  async function loadData(){
    setStatus("Ładowanie danych…");
    const usedData = await usedRange(CONFIG.dataSheet);
    const V = usedData.values || [];
    if(!V.length){ rows=[]; phSet.clear(); setStatus("Arkusz „Dane” pusty."); return; }

    const headers = (V[0]||[]).map(h=>String(h||"").trim());
    const body = V.slice(1);

    const H = {
      created: headers[0], // kol. A – „Data zgłoszenia”
      ph:   pickHeader(headers,["ph"]),
      st:   pickHeader(headers,["status"]),
      msc:  pickHeader(headers,["miejscowość","miejscowosc","miasto"]),
      ulica:pickHeader(headers,["ulica","adres"]),
      nr:   pickHeader(headers,["nr budynku","nr domu","numer","nr"]),
      adr:  pickHeader(headers,["adres_pelny","adres pełny","adres pelny"])
    };

    rows = body.map(r=>{
      const get=(c)=>{ const i=headers.indexOf(c); return i>=0 ? r[i] : ""; };
      let adr = get(H.adr)||"";
      if(!adr){
        const u=String(get(H.ulica)||"").trim();
        const n=String(get(H.nr)||"").trim();
        const m=String(get(H.msc)||"").trim();
        adr = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
      }
      const PH = String(get(H.ph)||"").trim();
      const Status = String(get(H.st)||"").trim();
      const createdAt = toDate(get(H.created));
      if(PH) phSet.add(PH);
      return {
        createdAt,
        PH,
        Status,
        adres_pelny: adr,
        addr_norm: norm(adr)
      };
    });

    // mapy pomocnicze: aktualny status per adres
    byAddrCurrent = {};
    rows.forEach(r=>{ byAddrCurrent[r.addr_norm] = r.Status; });

    // PH do filtra
    const sel=$("#fPH"); sel.innerHTML = `<option value="">(wszyscy)</option>` + [...phSet].sort().map(ph=>`<option>${esc(ph)}</option>`).join("");

    // Wczytaj logi
    const usedLog = await usedRange(CONFIG.logSheet);
    const L = usedLog.values || [];
    const hdr = (L[0]||[]).map(h=>String(h||"").trim());
    const bdy = L.slice(1);

    const I = {
      ts:  hdr.indexOf("ts"),
      act: hdr.indexOf("action"),
      addr: hdr.indexOf("adres_pelny"),
      old: hdr.indexOf("old"),
      neu: hdr.indexOf("new")
    };

    logs = bdy.map(r=>{
      const ts = new Date(String(r[I.ts]||""));
      const act = String(r[I.act]||"");
      const addr = String(r[I.addr]||"");
      const neu = String(r[I.neu]||""); // format: newPH|newStatus|reason
      let newStatus = "";
      const parts = neu.split("|");
      if(parts.length>=2) newStatus = parts[1].trim();
      return {
        ts, action: act, addr, addr_norm: norm(addr), newStatus
      };
    }).filter(x=> x.ts && !isNaN(x.ts) && x.action==="UpdatePHStatus");

    setStatus(`Załadowano: Dane=${rows.length}, Logi=${logs.length}.`);
  }

  /* ====== KPI: średnie czasy (Lead→Wycena, Wycena→Oferta, Oferta→Zamknięcie) ====== */
  function computeAverages(){
    // Filtry z UI
    const wantPH = $("#fPH").value.trim();
    const dFrom  = $("#fFrom").value ? new Date($("#fFrom").value+"T00:00:00") : null;
    const dTo    = $("#fTo").value   ? new Date($("#fTo").value  +"T23:59:59") : null;

    // Index logów: po adresie
    const byAddrLogs = new Map();
    for(const l of logs){
      if(!byAddrLogs.has(l.addr_norm)) byAddrLogs.set(l.addr_norm, []);
      byAddrLogs.get(l.addr_norm).push(l);
    }
    for(const arr of byAddrLogs.values()){ arr.sort((a,b)=>a.ts-b.ts); }

    // Zbierz czasy
    const deltasL2E=[], deltasE2O=[], deltasO2C=[];
    let nLead=0, nAfterExclude=0;

    for(const r of rows){
      // Wykluczenia wg aktualnego statusu
      if(EXCLUDED_STATUS.has(r.Status)) continue;

      // Filtr PH (jeśli ustawiony)
      if(wantPH && r.PH !== wantPH) continue;

      // Filtr zakresu po dacie zgłoszenia (kol. A)
      if(dFrom || dTo){
        if(!r.createdAt) continue;
        if(dFrom && r.createdAt < dFrom) continue;
        if(dTo   && r.createdAt > dTo)   continue;
      }

      nLead++;

      const arr = byAddrLogs.get(r.addr_norm) || [];

      // szukamy pierwszych wystąpień poszczególnych statusów
      const t_est   = arr.find(x=>x.newStatus===STATUS_TARGETS.est)?.ts || null;
      const t_offer = arr.find(x=>x.newStatus===STATUS_TARGETS.offer)?.ts || null;
      const t_close = arr.find(x=>x.newStatus===STATUS_TARGETS.won || x.newStatus===STATUS_TARGETS.lost)?.ts || null;

      if(r.createdAt && t_est){
        deltasL2E.push(diffDays(r.createdAt, t_est));
      }
      if(t_est && t_offer){
        deltasE2O.push(diffDays(t_est, t_offer));
      }
      if(t_offer && t_close){
        deltasO2C.push(diffDays(t_offer, t_close));
      }
    }

    // średnie
    const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;
    const aL2E = avg(deltasL2E);
    const aE2O = avg(deltasE2O);
    const aO2C = avg(deltasO2C);

    // prezentacja
    $("#kpiL2E").textContent = fmtDays(aL2E);
    $("#kpiE2O").textContent = fmtDays(aE2O);
    $("#kpiO2C").textContent = fmtDays(aO2C);

    $("#kpiL2Einfo").textContent = deltasL2E.length ? `na podstawie ${deltasL2E.length} spraw` : "brak pełnych danych";
    $("#kpiE2Oinfo").textContent = deltasE2O.length ? `na podstawie ${deltasE2O.length} spraw` : "brak pełnych danych";
    $("#kpiO2Cinfo").textContent = deltasO2C.length ? `na podstawie ${deltasO2C.length} spraw` : "brak pełnych danych";

    setStatus(`Policzono KPI. Uwzględniono ${nLead} leadów (po wykluczeniach i filtrach).`);
  }

  /* ======================== ZDARZENIA ======================== */
  $("#btnReload").addEventListener("click", async ()=>{
    try{
      await ensureLogin(); await getSiteId(); await getFileItemId();
      await loadData();
      computeAverages();
    }catch(e){ console.error(e); showError(e.message||e); }
  });

  // Autostart: nie ładuję automatycznie — klik „Odśwież” po zalogowaniu
  setStatus("Kliknij „Odśwież z Excelem”.");
  msalApp.handleRedirectPromise().catch(e=>console.warn("MSAL redirect:", e));
})();
</script>
<div class="credit">Autor: Adrian Daniel</div>
</body>
</html>

