<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>SIDUSIS – Dashboard KPI (ONLINE)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --card:#fff; --muted:#64748b; --line:#e5e7eb; --bg:#f6f7fb;
    --ink:#0f172a; --chip:#eef2ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1280px;margin:20px auto;padding:0 16px}
  .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .auth{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
  .auth button,.linkbtn{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .filters{display:flex;flex-wrap:wrap;gap:14px;align-items:end}
  .filters .f{display:flex;flex-direction:column;font-size:13px}
  .filters input,.filters select{padding:9px 11px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font:inherit}
  .filters button{padding:10px 13px;border:1px solid #cbd5e1;border-radius:10px;background:var(--chip);cursor:pointer}

  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
  .tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;overflow:hidden;min-width:0} /* <-- ważne */
  .tile .k{font-size:28px;font-weight:800;margin-top:6px}
  .tile .l{font-size:12px;color:var(--muted)}

  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .charts-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}

  /* Stabilna wysokość kontenerów wykresów */
  .chartbox{height:280px}
  .chartbox--sm{height:240px}
  .chartbox canvas{display:block;width:100%;height:100%}

  .status{margin-top:12px;font-size:12px;color:var(--muted)}
  .error{position:fixed;left:0;right:0;top:0;background:#fff3f3;border-bottom:1px solid #f0caca;color:#8b0000;padding:10px 14px;display:none;z-index:9999}
  .tablewrap{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:right}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:700;background:#f8fafc}
  .chip{display:inline-block;background:var(--chip);border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
  @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} .charts,.charts-2{grid-template-columns:1fr} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .credit{
    position:fixed; right:10px; bottom:8px; z-index:9999;
    background:#ffffffd9; backdrop-filter: blur(4px);
    border:1px solid #e5e7eb; border-radius:999px;
    padding:6px 10px; font-size:12px; color:#374151;
  }
</style>

<!-- MSAL (3 CDN fallbacki) -->
<script>
  function loadScriptSequential(urls){
    return new Promise((res,rej)=>{
      let i=0;
      const go=()=>{
        if(i>=urls.length) return rej(new Error('MSAL nie wstał z żadnego CDN.'));
        const s=document.createElement('script'); s.src=urls[i++]; s.async=true;
        s.onload=()=>res(); s.onerror=()=>go(); document.head.appendChild(s);
      }; go();
    });
  }
  const MSAL_CDNS=[
    'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
    'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
  ];
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>
<body>
<div class="error" id="errorBar"></div>

<div class="wrap">
  <div class="topbar">
    <h2 style="margin:0">SIDUSIS – Dashboard KPI</h2>
    <div class="auth">
      <span id="who">Nie zalogowano.</span>
      <button id="btnLogin">Zaloguj</button>
      <button id="btnLogout">Wyloguj</button>
      <a href="mapa_test.html" class="linkbtn" style="text-decoration:none">↩︎ Mapa</a>
    </div>
  </div>

  <div class="panel">
    <div class="filters">
      <div class="f">
        <label>Zakres od</label>
        <input type="date" id="fFrom">
      </div>
      <div class="f">
        <label>…do</label>
        <input type="date" id="fTo">
      </div>
      <div class="f">
        <label>PH</label>
        <select id="fPH" multiple size="4" style="min-width:220px"></select>
        <span class="l" style="margin-top:4px;color:#64748b">Wskazówka: Ctrl/⌘ aby zaznaczać wiele</span>
      </div>
      <div class="f">
        <label>Status</label>
        <select id="fStatus" multiple size="4" style="min-width:220px"></select>
      </div>
      <div class="f">
        <button id="btnApply">Zastosuj filtry</button>
      </div>
      <div class="f" style="margin-left:auto">
        <button id="btnReload">Odśwież dane z Excela</button>
      </div>
    </div>
    <div class="status" id="status">Załaduj dane…</div>
  </div>

  <!-- KPI tiles -->
  <div class="grid">
    <div class="tile"><div class="l">Leady (okres)</div><div class="k" id="kLeads">–</div></div>
    <div class="tile"><div class="l">Przypisane PH</div><div class="k"><span id="kPH">–</span> <span class="l">/ nieprzypisane: <span class="chip" id="kUnassigned">–</span></span></div></div>
    <div class="tile"><div class="l">Wyceny (pierwsze wystąpienia)</div><div class="k" id="kQuotes">–</div></div>
    <div class="tile"><div class="l">Oferty wysłane</div><div class="k" id="kOffers">–</div></div>
    <div class="tile"><div class="l">Zamknięcia (Akc/Odr)</div><div class="k" id="kClosed">–</div><div class="l">Akc: <span id="kAcc">–</span> / Odr: <span id="kRej">–</span></div></div>
    <div class="tile"><div class="l">Śr. czas: Lead → Wycena</div><div class="k" id="kT01">–</div></div>
    <div class="tile"><div class="l">Śr. czas: Wycena → Oferta</div><div class="k" id="kT02">–</div></div>
    <div class="tile"><div class="l">Śr. czas: Oferta → Zamknięcie</div><div class="k" id="kT03">–</div></div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="tile">
      <h4 style="margin:0 0 8px 0">Trend tygodniowy</h4>
      <div class="chartbox"><canvas id="chTrend"></canvas></div>
    </div>
    <div class="tile">
      <h4 style="margin:0 0 8px 0">PH × Status (stack)</h4>
      <div class="chartbox"><canvas id="chPH"></canvas></div>
    </div>
  </div>
  <div class="charts-2">
    <div class="tile">
      <h4 style="margin:0 0 8px 0">Powody odmowy</h4>
      <div class="chartbox--sm"><canvas id="chReasons"></canvas></div>
    </div>
    <div class="tile">
      <h4 style="margin:0 0 8px 0">Leady wg PH i Statusu</h4>
      <div style="overflow:auto;max-height:380px">
        <table id="tblPH"></table>
      </div>
    </div>
  </div>
</div>

<script>
(async function main(){
/* =========================== KONFIG =========================== */
const CONFIG = {
  clientId: "2c5a0274-30c0-4efa-b13c-7ce1e0768cf9",
  tenantId: "e44d0310-65ed-4096-a024-dac77110765a",
  spHost:   "internetunion.sharepoint.com",
  spSitePath: "PHTheNetwork",
  filePath: "/General/Kopia pliku Lista - SIDUSIS - PEŁNA - od 08-2025 - kopia do mapy.xlsx",
  dataSheet: "Dane",
  logSheet:  "AuditLog",
};

// Statusy – kanon + aliasy
const STATUS_ALIASES = {
  "zapytanie o wycenę":"Wycena Inwestycji",
  "zapytanie o wycene":"Wycena Inwestycji",
  "wycena inwestycji":"Wycena Inwestycji",
  "oferta wysłana":"Oferta wysłana",
  "odmowa klienta":"Odmowa klienta",
  "akceptacja klienta":"Akceptacja klienta",
  "poza zasięgiem":"Poza Zasięgiem",
  "kpo":"KPO",
  "duplikat":"Duplikat",
  "moico":"MOICO",
  "seev":"SEEV"
};
function canonStatus(s){
  const k=String(s||"").toLowerCase().trim();
  return STATUS_ALIASES[k] || (s||"");
}
const STATUS_LIST = ["Wycena Inwestycji","Oferta wysłana","Odmowa klienta","Akceptacja klienta","Poza Zasięgiem","KPO"];
const EXCLUDED_STATUSES = new Set(["KPO","Poza Zasięgiem","MOICO","Duplikat","SEEV"]);

const PH_ALL = "(Wszyscy PH)";
const PH_NONE = "(Brak PH)";

/* =========================== UTYLITY/UI =========================== */
const $ = s => document.querySelector(s);
const statusBox = $("#status");
const who = $("#who"); const errorBar=$("#errorBar");
function setStatus(t){ statusBox.textContent = t; }
function showError(t){ errorBar.textContent=t; errorBar.style.display='block'; setTimeout(()=>errorBar.style.display='none',7000); }
function toDate(v){
  if(v==null || v==="") return null;
  if(typeof v==="number"){ const d = new Date(Date.UTC(1899,11,30)); d.setUTCDate(d.getUTCDate()+Math.floor(v)); return d; }
  const s=String(v).trim(); const d1 = new Date(s); if(!isNaN(d1)) return d1;
  const m = s.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
  if(m){ const [_,dd,mm,yy]=m; return new Date(Number(yy.length===2?("20"+yy):yy), Number(mm)-1, Number(dd)); }
  return null;
}
function fmtDays(n){ return (n!=null && isFinite(n))? (n.toFixed(1)+" d") : "–"; }
function diffDays(a,b){ return (b-a)/86400000; }
function normAddr(s){
  return String(s||"").toLowerCase()
    .replace(/\s+/g,' ')
    .replace(/^\s*(ul\.?\s*){2,}/i,'ul. ')
    .replace(/^\s*ul\b\.?/i,'ul. ')
    .replace(/\s*,\s*/g,', ').trim();
}

/* =========================== MSAL / GRAPH =========================== */
await loadScriptSequential(MSAL_CDNS);
if(typeof msal==='undefined' || !msal.PublicClientApplication){ alert('MSAL nie wstał.'); return; }

const msalApp = new msal.PublicClientApplication({
  auth:{ clientId:CONFIG.clientId, authority:"https://login.microsoftonline.com/"+CONFIG.tenantId,
         redirectUri: window.location.origin + window.location.pathname },
  cache:{ cacheLocation:"localStorage", storeAuthStateInCookie:false }
});
const graphScopes=["openid","profile","offline_access","Files.ReadWrite.All","Sites.Read.All"];
let account=null, siteId=null, fileId=null;

async function ensureLogin(){
  const accs=msalApp.getAllAccounts();
  if(accs.length){ account=accs[0]; who.textContent="Zalogowano: "+(account.username||account.homeAccountId); return; }
  const r = await msalApp.loginPopup({ scopes:graphScopes });
  account=r.account; who.textContent="Zalogowano: "+(account.username||account.homeAccountId);
}
async function getToken(){
  await ensureLogin();
  try{ const r=await msalApp.acquireTokenSilent({scopes:graphScopes,account}); return r.accessToken; }
  catch{ const r=await msalApp.acquireTokenPopup({scopes:graphScopes}); return r.accessToken; }
}
async function gfetch(method, url){
  const token = await getToken();
  const resp = await fetch(url,{method,headers:{Authorization:"Bearer "+token,Accept:"application/json"}});
  if(!resp.ok){ const txt=await resp.text().catch(()=>String(resp.status)); throw new Error(`${method} ${url} -> ${resp.status} ${txt}`); }
  return resp.status===204?null:resp.json();
}
async function getSiteId(){
  if(siteId) return siteId;
  const js = await gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${CONFIG.spHost}:/sites/${CONFIG.spSitePath}`);
  siteId = js.id; return siteId;
}
async function getFileItemId(){
  if(fileId) return fileId;
  const sid = await getSiteId();
  const js = await gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${sid}/drive/root:${encodeURI(CONFIG.filePath)}`);
  fileId = js.id; return fileId;
}
async function usedRange(wsName){
  const [sid,iid]=await Promise.all([getSiteId(), getFileItemId()]);
  const wsq=wsName.replace(/'/g,"''");
  return gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/usedRange(valuesOnly=true)`);
}

/* =========================== DANE =========================== */
let ROWS=[], LOGS=[]; // surowe
let PH_LIST=[];       // do filtra

function pickHeader(headers, tokens){
  const lc=headers.map(h=>String(h||"").toLowerCase());
  for(const t of tokens){ const i=lc.findIndex(n=>n.includes(t)); if(i>=0) return headers[i]; }
  return null;
}

function parseDane(values){
  if(!values || !values.length) return [];
  const H = values[0].map(h=>String(h||"").trim());
  const body = values.slice(1);
  const COL = {
    created: H[0],
    ph:      pickHeader(H,["ph"]),
    status:  pickHeader(H,["status"]),
    reason:  pickHeader(H,["powód","powod","reason","powód odmowy","powod odmowy"]),
    addr:    pickHeader(H,["adres_pelny","adres pełny","adres pelny"]),
    ulica:   pickHeader(H,["ulica","adres"]),
    nr:      pickHeader(H,["nr budynku","numer","nr","nr domu"]),
    msc:     pickHeader(H,["miejscowość","miejscowosc","miasto"])
  };

  const idx = name => H.indexOf(name);
  const out = body.map(r=>{
    let adres = COL.addr ? String(r[idx(COL.addr)]||"") : "";
    if(!adres){
      const u = COL.ulica ? String(r[idx(COL.ulica)]||"").trim() : "";
      const n = COL.nr    ? String(r[idx(COL.nr)]||"").trim()    : "";
      const m = COL.msc   ? String(r[idx(COL.msc)]||"").trim()   : "";
      adres = (u&&n&&m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
    }
    const st = canonStatus(COL.status ? (r[idx(COL.status)]||"") : "");
    return {
      createdAt: toDate(r[idx(COL.created)]),
      PH: String(COL.ph ? (r[idx(COL.ph)]||"") : ""),
      Status: st,
      Reason: (st==="Odmowa klienta" && COL.reason) ? String(r[idx(COL.reason)]||"") : "",
      adres_pelny: adres,
      key: normAddr(adres)
    };
  }).filter(o=>o.adres_pelny);

  PH_LIST = [...new Set(out.map(o=>(o.PH||"")))].sort();
  if(!PH_LIST.includes("")) PH_LIST.unshift("");
  return out;
}

function parseLog(values){
  if(!values || !values.length) return [];
  const H = values[0].map(h=>String(h||"").trim());
  const body = values.slice(1);
  const idxTs   = H.indexOf("ts");
  const idxAct  = H.indexOf("action");
  const idxAddr = H.indexOf("adres_pelny");
  const idxOld  = H.indexOf("old");
  const idxNew  = H.indexOf("new");

  return body.map(r=>{
    const ts = new Date(String(r[idxTs]||""));
    const addr = normAddr(String(r[idxAddr]||""));
    const old = String(r[idxOld]||"");
    const nw  = String(r[idxNew]||"");
    const partsOld = old.split("|");
    const partsNew = nw.split("|");
    const oldStatus = canonStatus(partsOld[1]||"");
    const newStatus = canonStatus(partsNew[1]||"");
    const newReason = (newStatus==="Odmowa klienta") ? (partsNew[2]||"") : "";
    return { ts, addr, action:String(r[idxAct]||""), oldStatus, newStatus, newReason };
  }).filter(x=>x.addr && !isNaN(x.ts));
}

/* =========================== KPI =========================== */
function applyFilters(allRows, from, to, selPH, selST){
  const inRange = r => (!from || r.createdAt>=from) && (!to || r.createdAt<=to);
  const phOk = r => {
    if(!selPH.length) return true;
    const wanted = selPH.map(x=> x===PH_NONE ? "" : x);
    return wanted.includes(r.PH||"");
  };
  const stOk = r => !selST.length || selST.includes(r.Status||"");
  return allRows.filter(r=>inRange(r)&&phOk(r)&&stOk(r));
}
function firstStatusTsByAddr(logs, status){
  const map=new Map(); const target = s=>String(s||"").toLowerCase().trim()===status.toLowerCase();
  const sorted=[...logs].sort((a,b)=>a.ts-b.ts);
  for(const e of sorted){ if(target(e.newStatus) && !map.has(e.addr)) map.set(e.addr,e.ts); }
  return map;
}
function firstStatusWithReasonByAddr(logs, status){
  const map=new Map(); const target = s=>String(s||"").toLowerCase().trim()===status.toLowerCase();
  const sorted=[...logs].sort((a,b)=>a.ts-b.ts);
  for(const e of sorted){ if(target(e.newStatus) && !map.has(e.addr)) map.set(e.addr,{ts:e.ts,reason:e.newReason||""}); }
  return map;
}
function weeklyKey(d){
  const dt=new Date(d.getFullYear(),d.getMonth(),d.getDate());
  const onejan=new Date(dt.getFullYear(),0,1);
  const w=Math.ceil((((dt-onejan)/86400000)+onejan.getDay()+1)/7);
  return `${dt.getFullYear()}-W${String(w).padStart(2,'0')}`;
}
function computeKPI(rows, logs, from, to, selPH, selST){
  const filteredFull = applyFilters(rows, from, to, selPH, selST);
  const filteredKPI  = filteredFull.filter(r=>!EXCLUDED_STATUSES.has(r.Status));

  const firstQuote  = firstStatusTsByAddr(logs,"Wycena Inwestycji");
  const firstOffer  = firstStatusTsByAddr(logs,"Oferta wysłana");
  const firstAccept = firstStatusTsByAddr(logs,"Akceptacja klienta");
  const firstReject = firstStatusWithReasonByAddr(logs,"Odmowa klienta");

  let nLeads=filteredKPI.length;
  let nPHassigned=filteredKPI.filter(r=> (r.PH||"").trim()).length;
  let nUnassigned = nLeads - nPHassigned;

  let nQuote=0, nOffer=0, nClosed=0, nAcc=0, nRej=0;
  let tLeadQuote=[], tQuoteOffer=[], tOfferClose=[];

  for(const r of filteredKPI){
    const key=r.key;
    const tsQuote  = firstQuote.get(key)||null;
    const tsOffer  = firstOffer.get(key)||null;
    const tsAccept = firstAccept.get(key)||null;
    const rejObj   = firstReject.get(key)||null;
    const tsReject = rejObj ? rejObj.ts : null;

    const tsClose = tsAccept && tsReject ? (tsAccept < tsReject ? tsAccept : tsReject)
                  : tsAccept || tsReject || null;

    if(tsQuote) nQuote++;
    if(tsOffer) nOffer++;
    if(tsClose){ nClosed++; if(tsAccept && tsAccept===tsClose) nAcc++; if(tsReject && tsReject===tsClose) nRej++; }

    if(r.createdAt && tsQuote && tsQuote>=r.createdAt){ tLeadQuote.push(diffDays(r.createdAt, tsQuote)); }
    if(tsQuote && tsOffer && tsOffer>=tsQuote){ tQuoteOffer.push(diffDays(tsQuote, tsOffer)); }
    if(tsOffer && tsClose && tsClose>=tsOffer){ tOfferClose.push(diffDays(tsOffer, tsClose)); }
  }
  const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;

  const trend = {};
  for(const r of filteredKPI){
    if(!r.createdAt) continue;
    const k=weeklyKey(r.createdAt);
    trend[k]=(trend[k]||{leads:0,quotes:0,offers:0,closes:0});
    trend[k].leads++;
    if(firstQuote.get(r.key)) trend[k].quotes++;
    if(firstOffer.get(r.key)) trend[k].offers++;
    if(firstAccept.get(r.key) || firstReject.get(r.key)) trend[k].closes++;
  }

  const phCatsRaw = [...new Set(filteredFull.map(r=> (r.PH||"") ))].sort();
  const phCats = phCatsRaw.map(x=> x||PH_NONE);
  const stCats = ["Wycena Inwestycji","Oferta wysłana","Odmowa klienta","Akceptacja klienta","Poza Zasięgiem","KPO"];
  const phMatrix = phCatsRaw.map(()=> stCats.map(()=>0));
  const phTotals = phCatsRaw.map(()=>0);
  for(const r of filteredFull){
    const pi = phCatsRaw.indexOf(r.PH||"");
    const si = stCats.indexOf(r.Status||"");
    if(pi>=0){ phTotals[pi]++; if(si>=0) phMatrix[pi][si]++; }
  }

  const reasonsMap = new Map();
  for(const r of filteredKPI){
    const key=r.key;
    let reason="";
    const fr = firstReject.get(key);
    if(fr) reason = fr.reason || "";
    else if(r.Status==="Odmowa klienta") reason = r.Reason || "";
    reason = String(reason||"Brak powodu").trim();
    const n = reasonsMap.get(reason)||0; reasonsMap.set(reason, n+1);
  }

  return {
    counts:{
      leads:nLeads, phPct: nLeads? Math.round(nPHassigned/nLeads*100):0, unassigned:nUnassigned,
      quotes:nQuote, offers:nOffer, closed:nClosed, acc:nAcc, rej:nRej,
      tLeadQuote: avg(tLeadQuote), tQuoteOffer: avg(tQuoteOffer), tOfferClose: avg(tOfferClose)
    },
    trend, phCats, stCats, phMatrix, phTotals, reasons: reasonsMap
  };
}

/* =========================== WYKRESY/TABLE =========================== */
let chartTrend=null, chartPH=null, chartReasons=null;
function renderCharts(kpi){
  // Uspokojenie resize'ów
  if(window.Chart){
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    Chart.defaults.animation = false;
    Chart.defaults.devicePixelRatio = Math.min(window.devicePixelRatio||1, 1.5);
  }

  // Trend
  const keys = Object.keys(kpi.trend).sort();
  const leads  = keys.map(k=>kpi.trend[k].leads);
  const quotes = keys.map(k=>kpi.trend[k].quotes);
  const offers = keys.map(k=>kpi.trend[k].offers);
  const closes = keys.map(k=>kpi.trend[k].closes);
  if(chartTrend) chartTrend.destroy();
  chartTrend = new Chart(document.getElementById('chTrend'),{
    type:'line',
    data:{ labels:keys, datasets:[
      { label:'Leady', data:leads, tension:.3 },
      { label:'Wyceny', data:quotes, tension:.3 },
      { label:'Oferty', data:offers, tension:.3 },
      { label:'Zamknięcia', data:closes, tension:.3 },
    ]},
    options:{ plugins:{legend:{position:'bottom'}} }
  });

  // PH x Status
  if(chartPH) chartPH.destroy();
  chartPH = new Chart(document.getElementById('chPH'),{
    type:'bar',
    data:{
      labels:kpi.phCats,
      datasets: kpi.stCats.map((st,idx)=>({
        label: st,
        data: kpi.phMatrix.map(row=>row[idx]),
        stack:'st'
      }))
    },
    options:{ plugins:{legend:{position:'bottom'}}, scales:{x:{stacked:true}, y:{stacked:true}} }
  });

  // Powody odmowy
  const labels = [...kpi.reasons.keys()];
  const data   = labels.map(l=>kpi.reasons.get(l));
  if(chartReasons) chartReasons.destroy();
  chartReasons = new Chart(document.getElementById('chReasons'),{
    type:'doughnut',
    data:{ labels, datasets:[{ data }] },
    options:{ plugins:{legend:{position:'bottom'}} }
  });
}

function renderTable(kpi){
  const tbl=document.getElementById('tblPH');
  const head = `<tr>
    <th>PH</th>
    <th>Razem</th>
    ${kpi.stCats.map(s=>`<th>${s}</th>`).join("")}
  </tr>`;
  const rows = kpi.phCats.map((phDisp, i)=>{
    const total = kpi.phTotals[i];
    const cells = kpi.stCats.map((_,j)=> `<td>${kpi.phMatrix[i][j]}</td>`).join("");
    return `<tr><td>${phDisp}</td><td>${total}</td>${cells}</tr>`;
  }).join("");
  const totalRow = (()=> {
    const colTotals = kpi.stCats.map((_,j)=> kpi.phMatrix.reduce((a,row)=>a+row[j],0));
    const all = kpi.phTotals.reduce((a,b)=>a+b,0);
    return `<tr><td><b>Suma</b></td><td><b>${all}</b></td>${colTotals.map(n=>`<td><b>${n}</b></td>`).join("")}</tr>`;
  })();
  tbl.innerHTML = `<thead>${head}</thead><tbody>${rows}</tbody><tfoot>${totalRow}</tfoot>`;
}

/* =========================== UI / LOGIKA =========================== */
let FROM=null, TO=null, SEL_PH=[], SEL_ST=[];

function fillFilters(){
  const phSel=document.getElementById('fPH'); phSel.innerHTML="";
  const mk = (v,t)=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; return o; };
  phSel.appendChild(mk(PH_ALL, PH_ALL));
  for(const ph of PH_LIST.filter(x=>x)){ phSel.appendChild(mk(ph, ph)); }
  phSel.appendChild(mk(PH_NONE, PH_NONE));
  phSel.options[0].selected = true;

  const stSel=document.getElementById('fStatus'); stSel.innerHTML="";
  for(const st of STATUS_LIST){ const opt=document.createElement('option'); opt.value=st; opt.textContent=st; stSel.appendChild(opt); }

  const today=new Date(); const from=new Date(today); from.setDate(today.getDate()-30);
  document.getElementById('fFrom').value = from.toISOString().slice(0,10);
  document.getElementById('fTo').value   = today.toISOString().slice(0,10);
}
function readFilters(){
  FROM = document.getElementById('fFrom').value ? new Date(document.getElementById('fFrom').value+"T00:00:00") : null;
  TO   = document.getElementById('fTo').value   ? new Date(document.getElementById('fTo').value+"T23:59:59") : null;
  const sel = [...document.getElementById('fPH').selectedOptions].map(o=>o.value);
  SEL_PH = (!sel.length || sel.includes(PH_ALL)) ? [] : sel;
  SEL_ST = [...document.getElementById('fStatus').selectedOptions].map(o=>o.value);
}
function renderTiles(kpi){
  document.getElementById('kLeads').textContent = kpi.counts.leads;
  document.getElementById('kPH').textContent    = `${kpi.counts.phPct}%`;
  document.getElementById('kUnassigned').textContent = kpi.counts.unassigned;
  document.getElementById('kQuotes').textContent = kpi.counts.quotes;
  document.getElementById('kOffers').textContent = kpi.counts.offers;
  document.getElementById('kClosed').textContent = kpi.counts.closed;
  document.getElementById('kAcc').textContent    = kpi.counts.acc;
  document.getElementById('kRej').textContent    = kpi.counts.rej;
  document.getElementById('kT01').textContent    = fmtDays(kpi.counts.tLeadQuote);
  document.getElementById('kT02').textContent    = fmtDays(kpi.counts.tQuoteOffer);
  document.getElementById('kT03').textContent    = fmtDays(kpi.counts.tOfferClose);
}

async function loadAll(){
  try{
    setStatus("Ładowanie danych (Graph)…");
    await ensureLogin();
    const [d1,d2] = await Promise.all([ usedRange(CONFIG.dataSheet), usedRange(CONFIG.logSheet) ]);
    ROWS = parseDane(d1.values||[]);
    LOGS = parseLog(d2.values||[]);
    fillFilters();
    readFilters();
    const kpi = computeKPI(ROWS, LOGS, FROM, TO, SEL_PH, SEL_ST);
    renderTiles(kpi);
    renderCharts(kpi);
    renderTable(kpi);
    setStatus(`Wiersze: Dane=${ROWS.length}, AuditLog=${LOGS.length}. Filtry aktywne.`);
  }catch(err){ console.error(err); showError(err.message); }
}

document.getElementById('btnLogin').addEventListener('click', ()=>ensureLogin().catch(e=>showError(e.message)));
document.getElementById('btnLogout').addEventListener('click', async ()=>{
  try{ const acc=msalApp.getAllAccounts()[0]; if(acc) await msalApp.logoutPopup({account:acc}); who.textContent="Nie zalogowano."; }
  catch(e){ showError(e.message); }
});
document.getElementById('btnReload').addEventListener('click', loadAll);
document.getElementById('btnApply').addEventListener('click', ()=>{
  readFilters();
  const kpi = computeKPI(ROWS, LOGS, FROM, TO, SEL_PH, SEL_ST);
  renderTiles(kpi); renderCharts(kpi); renderTable(kpi);
});

msalApp.handleRedirectPromise().catch(()=>{});
loadAll();

})();
</script>
  <div class="credit">Autor: Adrian Daniel</div>
</body>
</html>
