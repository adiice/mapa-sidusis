<!-- --- START: dashboard_ph.html (PH dashboard w stylistyce dashboard_test) --- -->
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>SIDUSIS – PH Dashboard (ONLINE)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --card:#fff; --muted:#6b7280; --line:#e5e7eb; --bg:#f6f7fb; }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);}
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px;}
  .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .auth{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
  .auth button{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:end}
  .filters .f{display:flex;flex-direction:column;font-size:13px}
  .filters input,.filters select{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font:inherit}
  .filters button{padding:9px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#eef2ff;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
  .tile .k{font-size:28px;font-weight:700;margin-top:6px}
  .tile .l{font-size:12px;color:var(--muted)}
  .error{position:fixed;left:0;right:0;top:0;background:#fff3f3;border-bottom:1px solid #f0caca;color:#8b0000;padding:10px 14px;display:none;z-index:9999}
  .tablewrap{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
  th:nth-child(1), td:nth-child(1){white-space:nowrap}
  td.nowrap{white-space:nowrap}
  .right{ text-align:right }
  .btn{padding:6px 8px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer;font-size:12px}
  .btn.primary{background:#eef2ff}
  .row-actions{display:flex;gap:6px;flex-wrap:wrap}
  .muted{color:#64748b}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} }
</style>
<script>
  function loadScriptSequential(urls){return new Promise((res,rej)=>{let i=0;const go=()=>{if(i>=urls.length) return rej(new Error('MSAL nie wstał')); const s=document.createElement('script'); s.src=urls[i++]; s.async=true; s.onload=()=>res(); s.onerror=()=>go(); document.head.appendChild(s);}; go();});}
  const MSAL_CDNS=['https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js','https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js','https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'];
</script>
</head>
<body>
<div class="error" id="errorBar"></div>
<div class="wrap">
  <div class="topbar">
    <h2 style="margin:0">SIDUSIS – Dashboard PH</h2>
    <div class="auth">
      <span id="who">Nie zalogowano.</span>
      <button id="btnLogin">Zaloguj</button>
      <button id="btnLogout">Wyloguj</button>
      <a href="mapa_test.html" style="margin-left:6px;text-decoration:none;border:1px solid #d1d5db;border-radius:10px;padding:8px 10px;background:#fff">↩︎ Mapa</a>
    </div>
  </div>

  <div class="panel">
    <div class="filters">
      <div class="f"><label>Zakres od</label><input type="date" id="fFrom"></div>
      <div class="f"><label>…do</label><input type="date" id="fTo"></div>
      <div class="f"><label>PH</label><select id="fPH"></select></div>
      <div class="f"><label>Status (wiele)</label><select id="fStatus" multiple size="4" style="min-width:220px"></select></div>
      <div class="f"><button id="btnApply">Zastosuj</button></div>
      <div class="f" style="margin-left:auto"><button id="btnReload">Odśwież dane</button></div>
    </div>
    <div class="grid">
      <div class="tile"><div class="l">Moje leady (po filtrze)</div><div class="k" id="kLeads">–</div></div>
      <div class="tile"><div class="l">Nieprzydzielone w filtrze</div><div class="k" id="kUnassigned">–</div></div>
      <div class="tile"><div class="l">Nadchodzące kontakty ≤ 7 dni</div><div class="k" id="kUpcoming">–</div></div>
    </div>
  </div>

  <div class="tablewrap">
    <div class="tile">
      <h3 style="margin:0 0 10px 0">Moje leady</h3>
      <div style="overflow:auto">
        <table id="tbl"><thead></thead><tbody></tbody></table>
      </div>
      <div class="muted" style="margin-top:8px">„OptOut” wyłącza przypomnienia/automaty. „Zapisz” utrwala zmiany (NextContactAt, OptOut) i ustawia LastTouchAt.</div>
    </div>
  </div>
</div>

<script>
(async function(){
  /* === KONFIG (jak w mapie/KPI) === */
  const CONFIG={ clientId:"2c5a0274-30c0-4efa-b13c-7ce1e0768cf9", tenantId:"e44d0310-65ed-4096-a024-dac77110765a", spHost:"internetunion.sharepoint.com", spSitePath:"PHTheNetwork", filePath:"/General/Kopia pliku Lista - SIDUSIS - PEŁNA - od 08-2025 - kopia do mapy.xlsx", dataSheet:"Dane", logSheet:"AuditLog" };
  const STATUS_LIST=["Wycena Inwestycji","Oferta wysłana","Odmowa klienta","Akceptacja klienta","Poza Zasięgiem","KPO","Duplikat","MOICO","SEEV"];
  const PH_LIST=["(tylko ja)","(wszyscy)","Adrian Daniel","Robert Kaźmierczak","Mariusz Kielczyk","Inga Kaźmierczak","Jacek Trybuchowski","Tomasz Józefowicz","Duplikat","MOICO","SEEV"];

  /* === UI helpers === */
  const $=s=>document.querySelector(s); const who=$("#who"), err=$("#errorBar");
  function showError(t){ err.textContent=t; err.style.display='block'; setTimeout(()=>err.style.display='none',7000); }
  function toDate(v){ if(v==null||v==="") return null; if(typeof v==="number"){ const d=new Date(Date.UTC(1899,11,30)); d.setUTCDate(d.getUTCDate()+Math.floor(v)); return d; } const s=String(v).trim(); const d1=new Date(s); if(!isNaN(d1))return d1; const m=s.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/); if(m){ const[_,dd,mm,yy]=m; return new Date(Number(yy.length===2?("20"+yy):yy), Number(mm)-1, Number(dd)); } return null; }
  function normAddr(s){ return String(s||"").toLowerCase().replace(/\s+/g,' ').replace(/^\s*(ul\.?\s*){2,}/i,'ul. ').replace(/^\s*ul\b\.?/i,'ul. ').replace(/\s*,\s*/g,', ').trim(); }

  /* === MSAL === */
  await loadScriptSequential(MSAL_CDNS);
  if(typeof msal==='undefined'||!msal.PublicClientApplication){ alert('MSAL nie wstał.'); return; }
  const app=new msal.PublicClientApplication({auth:{clientId:CONFIG.clientId,authority:"https://login.microsoftonline.com/"+CONFIG.tenantId,redirectUri:window.location.origin+window.location.pathname},cache:{cacheLocation:"localStorage"}});
  const scopes=["openid","profile","offline_access","Files.ReadWrite.All","Sites.Read.All"];
  let account=null, siteId=null, fileId=null;
  async function ensureLogin(){ const accs=app.getAllAccounts(); if(accs.length){ account=accs[0]; who.textContent="Zalogowano: "+(account.username||account.homeAccountId); return; } const r=await app.loginPopup({scopes}); account=r.account; who.textContent="Zalogowano: "+(account.username||account.homeAccountId); }
  async function getToken(){ await ensureLogin(); try{ const r=await app.acquireTokenSilent({scopes,account}); return r.accessToken; }catch{ const r=await app.acquireTokenPopup({scopes}); return r.accessToken; } }
  async function gfetch(method,url,body){ const token=await getToken(); const resp=await fetch(url,{method,headers:{Authorization:"Bearer "+token,Accept:"application/json","Content-Type":"application/json"}, body: body? JSON.stringify(body):undefined}); if(!resp.ok){ const txt=await resp.text().catch(()=>String(resp.status)); throw new Error(`${method} ${url} -> ${resp.status} ${txt}`); } return resp.status===204? null : resp.json(); }
  async function gBatch(requests){ const token=await getToken(); const resp=await fetch("https://graph.microsoft.com/v1.0/$batch",{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({requests})}); const js=await resp.json(); if(!resp.ok) throw new Error((js.error&&js.error.message)||"Batch error"); const bad=(js.responses||[]).find(r=>r.status<200||r.status>=300); if(bad) throw new Error("Batch subrequest failed: "+bad.status); return js; }
  async function site(){ if(siteId) return siteId; siteId=(await gfetch("GET",`https://graph.microsoft.com/v1.0/sites/${CONFIG.spHost}:/sites/${CONFIG.spSitePath}`)).id; return siteId; }
  async function file(){ if(fileId) return fileId; const sid=await site(); fileId=(await gfetch("GET",`https://graph.microsoft.com/v1.0/sites/${sid}/drive/root:${encodeURI(CONFIG.filePath)}`)).id; return fileId; }
  async function usedRange(ws){ const [sid,iid]=await Promise.all([site(),file()]); const wsq=ws.replace(/'/g,"''"); return gfetch("GET",`https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/usedRange(valuesOnly=true)`); }
  async function patchRange(ws,a1,values){ const [sid,iid]=await Promise.all([site(),file()]); const wsq=ws.replace(/'/g,"''"); return gfetch("PATCH",`https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${a1}')`,{values}); }

  /* === Dane === */
  let ROWS=[];
  function pickHeader(headers,tokens){ const lc=headers.map(h=>String(h||"").toLowerCase()); for(const t of tokens){ const i=lc.findIndex(n=>n.includes(t)); if(i>=0) return headers[i]; } return null; }
  function parse(values){
    if(!values||!values.length) return [];
    const H=(values[0]||[]).map(h=>String(h||"").trim()); const body=values.slice(1);
    const C={
      created:H[0],
      ph: pickHeader(H,["ph"]),
      st: pickHeader(H,["status"]),
      addr: pickHeader(H,["adres_pelny","adres pełny","adres pelny"]),
      ulica: pickHeader(H,["ulica","adres"]),
      nr: pickHeader(H,["nr budynku","numer","nr","nr domu"]),
      msc: pickHeader(H,["miejscowość","miejscowosc","miasto"]),
      nazwa: pickHeader(H,["zgłaszający","zglaszajacy","nazwa","imię","imie","nazwisko","klient","firma"]),
      mail: pickHeader(H,["email","e-mail","mail"]),
      tel: pickHeader(H,["telefon","tel"]),
      next: pickHeader(H,["nextcontactat"]),
      last: pickHeader(H,["lasttouchat"]),
      opt:  pickHeader(H,["optout"]),
    };
    const idx=n=>H.indexOf(n);
    const out=body.map((r,i)=>{
      let adres = C.addr? String(r[idx(C.addr)]||""):"";
      if(!adres){ const u=C.ulica?String(r[idx(C.ulica)]||"").trim():""; const n=C.nr?String(r[idx(C.nr)]||"").trim():""; const m=C.msc?String(r[idx(C.msc)]||"").trim():""; adres=(u&&n&&m)? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim()||m; }
      return {
        _row1: i+2, createdAt: toDate(r[idx(C.created)]),
        PH: String(C.ph? (r[idx(C.ph)]||""):""), Status: String(C.st? (r[idx(C.st)]||""):""),
        nazwa: String(C.nazwa? (r[idx(C.nazwa)]||""):""), adres_pelny: adres,
        email: String(C.mail? (r[idx(C.mail)]||""):""), telefon: String(C.tel? (r[idx(C.tel)]||""):""),
        NextContactAt: C.next? String(r[idx(C.next)]||"") : "",
        LastTouchAt:   C.last? String(r[idx(C.last)]||"") : "",
        OptOut: String(C.opt? (r[idx(C.opt)]||""):"").toLowerCase()==="true" || String(C.opt? (r[idx(C.opt)]||""):"").toLowerCase()==="x",
        _H: H
      };
    });
    return out;
  }

  /* === Mail === */
  function mailTemplates(rec){ /* to samo co w mapie (skrócone treści) */ 
    const nazwa=rec.nazwa||""; const miasto=""; let adres=(rec.adres_pelny||"").trim(); const tel=rec.telefon||""; const email=rec.email||"";
    const subj_inv=`Zapytanie o wycenę - ${adres} - SIDUSIS`;
    const subj_cli=`Internet światłowodowy - The Network - ${adres}`;
    const body_inv=`Proszę o wycenę podłączenia klienta:\nNazwa: ${nazwa}\nAdres: ${adres}\nTelefon: ${tel}\nE-mail: ${email}\n`;
    const body_cli=`Dzień dobry ${nazwa},\n\nDziękujemy za zgłoszenie – wrócę z informacją.\n`;
    const body_std=`Dzień dobry,\n\nOferta standard…\n`;
    const body_dev=`Dzień dobry,\n\nOferta deweloperska…\n`;
    return { INV:{to:"inwestycje@internetunion.pl",subject:subj_inv,body:body_inv}, CLI:{to:email,subject:subj_cli,body:body_cli}, STD:{to:email,subject:subj_cli,body:body_std}, DEV:{to:email,subject:subj_cli,body:body_dev} };
  }
  function composeAndSend(to,subject,body){ const base="mailto:"+encodeURIComponent(to||"")+"?subject="+encodeURIComponent(subject||""); const full=base+"&body="+encodeURIComponent(body||""); if(full.length<=1500){ location.href=full; } else if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(body).then(()=>{ location.href=base; alert("Treść zbyt długa – skopiowano do schowka."); }); } else { location.href=base; } }

  /* === UI/Filtry === */
  let FROM=null, TO=null, SEL_PH="(tylko ja)", SEL_ST=[];
  function fillFilters(){
    const today=new Date(); const from=new Date(today); from.setDate(today.getDate()-30);
    $("#fFrom").value=from.toISOString().slice(0,10); $("#fTo").value=today.toISOString().slice(0,10);
    const ph=$("#fPH"); ph.innerHTML=PH_LIST.map(v=>`<option>${v}</option>`).join(""); ph.value="(tylko ja)";
    const st=$("#fStatus"); st.innerHTML=STATUS_LIST.map(v=>`<option>${v}</option>`).join("");
  }
  function readFilters(){
    FROM=$("#fFrom").value? new Date($("#fFrom").value+"T00:00:00"):null;
    TO=$("#fTo").value? new Date($("#fTo").value+"T23:59:59"):null;
    SEL_PH=$("#fPH").value;
    SEL_ST=[...$("#fStatus").selectedOptions].map(o=>o.value);
  }
  function applyFilters(all){
    const me=(account&&(account.name||""))||"";
    return all.filter(r=>{
      if(FROM && r.createdAt && r.createdAt<FROM) return false;
      if(TO   && r.createdAt && r.createdAt>TO)   return false;
      if(SEL_PH==="(tylko ja)" && (r.PH||"")!==me) return false;
      if(SEL_PH!=="(tylko ja)" && SEL_PH!=="(wszyscy)" && (r.PH||"")!==SEL_PH) return false;
      if(SEL_ST.length && !SEL_ST.includes(r.Status||"")) return false;
      return true;
    });
  }

  /* === Render tabeli === */
  function renderTable(data){
    const thead=$("#tbl thead"); const tbody=$("#tbl tbody");
    thead.innerHTML=`<tr><th>Data</th><th>Klient / Adres</th><th>Status</th><th>Nast. kontakt</th><th>OptOut</th><th class="right">Akcje</th></tr>`;
    tbody.innerHTML="";
    data.forEach((r,i)=>{
      const tr=document.createElement('tr');
      const nextVal = r.NextContactAt ? new Date(r.NextContactAt).toISOString().slice(0,16) : "";
      tr.innerHTML=`<td class="nowrap">${r.createdAt? r.createdAt.toISOString().slice(0,10):""}</td>
        <td><b>${r.nazwa||""}</b><br><span class="muted">${r.adres_pelny||""}</span></td>
        <td>${r.Status||""}</td>
        <td><input type="datetime-local" value="${nextVal}" data-k="next" style="width:210px"></td>
        <td><input type="checkbox" data-k="opt" ${r.OptOut?'checked':''}></td>
        <td class="right">
          <div class="row-actions">
            <button class="btn" data-mail="INV">INV</button>
            <button class="btn" data-mail="CLI">CLI</button>
            <button class="btn" data-mail="STD">STD</button>
            <button class="btn" data-mail="DEV">DEV</button>
            <button class="btn primary" data-save>Zapisz</button>
          </div>
        </td>`;
      const inputs=tr.querySelectorAll('input');
      tr.querySelectorAll('button[data-mail]').forEach(b=>{
        b.addEventListener('click',()=>{ const t=mailTemplates(r)[b.getAttribute('data-mail')]; composeAndSend(t.to,t.subject,t.body); });
      });
      tr.querySelector('button[data-save]').addEventListener('click', async ()=>{
        const next=tr.querySelector('input[data-k="next"]').value || "";
        const opt = tr.querySelector('input[data-k="opt"]').checked;
        try{ await saveFollowup(r, next, opt); alert("Zapisano."); }catch(e){ showError(e.message); }
      });
      tbody.appendChild(tr);
    });
  }

  /* === Zapis follow-up (Excel) === */
  async function saveFollowup(rec, nextAtStr, optOut){
    const used=await usedRange(CONFIG.dataSheet); const headers=(used.values?.[0]||[]).map(h=>String(h||"").trim()); const body=(used.values||[]).slice(1);
    const must=(name)=>{ let i=headers.findIndex(h=>String(h).toLowerCase().trim()===name.toLowerCase()); if(i<0){ i=headers.length; headers.push(name); await patchRange(CONFIG.dataSheet,`A1:${colLetter(headers.length)}1`,[headers]); } return i; };
    function colLetter(n){ let s="",x=n; while(x>0){x--; s=String.fromCharCode(65+(x%26))+s; x=Math.floor(x/26);} return s; }
    const idxNext=must("NextContactAt"), idxOpt=must("OptOut"), idxLast=must("LastTouchAt");
    let row1=Number(rec._row1)||-1, row=row1>0? body[row1-2]:null;
    if(row1<0){ const iAddr=headers.findIndex(h=>String(h).toLowerCase().trim()==="adres_pelny"); const want=normAddr(rec.adres_pelny||""); for(let r=0;r<body.length;r++){ const adr=iAddr>=0? String((body[r]||[])[iAddr]||""):""; if(adr && normAddr(adr)===want){ row1=r+2; row=body[r]; break; } } if(row1<0) throw new Error("Nie znaleziono rekordu."); rec._row1=row1; }
    const nowIso=new Date().toISOString(); const [sid,iid]=await Promise.all([site(),file()]); const wsq=CONFIG.dataSheet.replace(/'/g,"''");
    await gBatch([
      {id:"next",method:"PATCH",url:`/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${colLetter(idxNext+1)}${row1}')`,headers:{"Content-Type":"application/json"},body:{values:[[ nextAtStr || "" ]]}},
      {id:"opt", method:"PATCH",url:`/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${colLetter(idxOpt+1)}${row1}')`, headers:{"Content-Type":"application/json"},body:{values:[[ optOut? "TRUE":"FALSE" ]]}},
      {id:"last",method:"PATCH",url:`/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${colLetter(idxLast+1)}${row1}')`,headers:{"Content-Type":"application/json"},body:{values:[[ nowIso ]]}}
    ]);
  }

  /* === Kolumna index helper do colLetter === */
  function colLetter(n){ let s="",x=n; while(x>0){x--; s=String.fromCharCode(65+(x%26))+s; x=Math.floor(x/26);} return s; }

  /* === Ładowanie === */
  async function loadAll(){
    try{
      await ensureLogin();
      const used = await usedRange(CONFIG.dataSheet);
      ROWS = parse(used.values||[]);
      fillFilters(); readFilters();
      const data = applyFilters(ROWS);
      // KPI
      const me=(account&&(account.name||""))||"";
      $("#kLeads").textContent = data.length;
      $("#kUnassigned").textContent = data.filter(r=>!r.PH).length;
      const soon = new Date(); soon.setDate(soon.getDate()+7);
      $("#kUpcoming").textContent = data.filter(r=> r.NextContactAt && new Date(r.NextContactAt)<=soon && !r.OptOut).length;
      // tabela
      renderTable(data);
    }catch(e){ showError(e.message); }
  }

  $("#btnLogin").addEventListener('click', ()=>ensureLogin().catch(e=>showError(e.message)));
  $("#btnLogout").addEventListener('click', async ()=>{ try{ const acc=app.getAllAccounts()[0]; if(acc) await app.logoutPopup({account:acc}); who.textContent="Nie zalogowano."; }catch(e){ showError(e.message);} });
  $("#btnReload").addEventListener('click', loadAll);
  $("#btnApply").addEventListener('click', ()=>{ readFilters(); const data=applyFilters(ROWS); renderTable(data); const soon=new Date(); soon.setDate(soon.getDate()+7); $("#kLeads").textContent=data.length; $("#kUnassigned").textContent=data.filter(r=>!r.PH).length; $("#kUpcoming").textContent=data.filter(r=> r.NextContactAt && new Date(r.NextContactAt)<=soon && !r.OptOut).length; });

  app.handleRedirectPromise().catch(()=>{});
  loadAll();
})();
</script>
</body>
</html>
<!-- --- END: dashboard_ph.html --- -->
