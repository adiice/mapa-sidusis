<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>SIDUSIS ‚Äì Dashboard PH (ONLINE: MSAL + Graph + Excel)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    /* DARK (domy≈õlny) */
    --bg:#0b1220; --panel:#11182a; --panel-2:#0d1424; --muted:#7f8aa3; --text:#e6ecff;
    --green:#27ae60; --red:#e74c3c; --amber:#f39c12; --blue:#3498db; --card:#0f1730;
    --line:#1b2540; --gradFrom:#050b18; --gradTo:#0a1122; --br:14px;
    --btn:#15224a; --btn-b:#2a3a73; --btn2:#21316a; --btn2-b:#3951a6; --btn-ghost-b:#29406f;
  }
  /* LIGHT */
  [data-theme="light"]{
    --bg:#f6f8ff; --panel:#ffffff; --panel-2:#f3f5fb; --muted:#5d6b88; --text:#0d1321;
    --green:#1e8e5a; --red:#c0392b; --amber:#b5740c; --blue:#2563eb; --card:#ffffff;
    --line:#d7deef; --gradFrom:#ffffff; --gradTo:#eef3ff;
    --btn:#e8ecfb; --btn-b:#c8d2f2; --btn2:#dfe6ff; --btn2-b:#b8c6fb; --btn-ghost-b:#c8d2f2;
  }

  *{ box-sizing:border-box }
  html,body{
    height:100%; margin:0; color:var(--text);
    background:linear-gradient(180deg,var(--gradFrom) 0%,var(--gradTo) 100%);
    background-attachment: fixed; /* FIX: bez ‚Äûodcinania‚Äù przy scrollu */
  }
  a{ color:#9cc4ff; text-decoration:none } [data-theme="light"] a{ color:#1d4ed8; }
  a:hover{ text-decoration:underline }

  .toolbar{
    position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(6px);
    background:color-mix(in oklab, var(--panel) 88%, transparent);
    border-bottom:1px solid var(--line);
  }
  .toolbar .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:10px 14px; }
  .toolbar select,.toolbar input,.toolbar button{
    background:var(--panel-2); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font:inherit;
  }
  .toolbar button{ cursor:pointer }
  .who{ font-size:12px; color:var(--muted) }

  .wrap{ max-width:1200px; margin:16px auto; padding:0 14px }
  .cards{ display:grid; grid-template-columns:repeat(3,minmax(220px,1fr)); gap:12px; }
  .card{
    background:linear-gradient(180deg,var(--card) 0%, var(--panel-2) 100%);
    border:1px solid var(--line); border-radius:var(--br);
    padding:14px; min-height:96px; box-shadow:0 10px 30px rgba(0,0,0,.12), inset 0 1px 0 color-mix(in oklab, var(--line) 40%, transparent);
  }
  .card h3{ margin:0 0 6px; font-size:14px; color:color-mix(in oklab, var(--muted) 90%, var(--text)) }
  .kpi{ font-size:28px; font-weight:700; letter-spacing:.3px }
  .kpi.bad{ color:var(--amber) } .kpi.verybad{ color:var(--red) } .kpi.good{ color:var(--green) }

  /* Kafelki dla mened≈ºera */
  .cards-manager{ display:grid; grid-template-columns:repeat(3,minmax(220px,1fr)); gap:12px; margin-top:12px }
  .badge{ position:absolute; top:10px; right:10px; border-radius:999px; padding:2px 8px; font-size:12px; font-weight:600; border:1px solid var(--line) }
  .badge.red{ border-color:#6b2330; background:#2a0f16; color:#ffc9c9 }
  .badge.amber{ border-color:#5a4930; background:#2a200f; color:#ffd89c }
  .badge.green{ border-color:#285a3b; background:#0f2a1a; color:#a6f3c4 }

  .panel{ margin-top:16px; background:linear-gradient(180deg,var(--card) 0%, var(--panel-2) 100%); border:1px solid var(--line); border-radius:var(--br); }
  .panel .hd{ padding:12px 14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center }
  .panel .hd h2{ margin:0; font-size:16px; color:color-mix(in oklab, var(--text) 86%, white) }
  /* quick chips */
  .chips{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-left:12px; opacity:.95 }
  .quick-chip{ padding:4px 10px; border-radius:999px; background:var(--panel-2); color:var(--text); border:1px solid var(--line); cursor:pointer }
  .quick-chip:hover{ filter:brightness(1.08) }
  .quick-chip.active{ outline:2px solid var(--btn2-b) }
  .panel .hd .tools{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .panel .bd{ padding:12px 14px }

  .table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  .table th{ text-align:left; font-size:12px; color:color-mix(in oklab, var(--muted) 90%, var(--text)); font-weight:600; padding:0 8px 6px }
  .table td{ background:var(--card); border:1px solid var(--line); padding:8px; vertical-align:top; }
  .table tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
  .table tr td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px;
         border:1px solid color-mix(in oklab, var(--line) 90%, black); background:var(--panel-2); color:color-mix(in oklab, var(--text) 86%, white) }
  .pill.red{ border-color:#5a2630; background:#2a0f16; color:#ffb3b3 }
  .pill.amber{ border-color:#5a4930; background:#2a200f; color:#ffd89c }
  .pill.green{ border-color:#285a3b; background:#0f2a1a; color:#a6f3c4 }

  .muted{ color:var(--muted) } .small{ font-size:12px }
  .statusbar{ margin:10px 14px 0; font-size:12px; color:var(--muted) }
  .error{ display:none; margin:10px 14px 0; padding:10px 12px; border:1px solid #6b2330; background:#2a0f16; color:#ffc9c9; border-radius:10px }

  .controls input,.controls select, .controls button{ background:var(--panel-2); color:var(--text); border:1px solid var(--line); border-radius:8px; padding:6px 8px; font:inherit; }
  .controls{ display:flex; gap:8px; flex-wrap:wrap }
  .btn{ background:var(--btn); border-color:var(--btn-b) } .btn:hover{ filter:brightness(1.08) }
  .btn-primary{ background:var(--btn2); border-color:var(--btn2-b) }
  .btn-danger{ background:#3b1a22; border-color:#6b2330; color:#ffe6e6 }
  .btn-ghost{ background:transparent; border-color:var(--btn-ghost-b) }

  /* Kafelki mened≈ºera */
  .cards-manager{ display:grid; grid-template-columns:repeat(3,minmax(220px,1fr)); gap:12px; margin-top:12px }
  .badge{ position:absolute; top:10px; right:10px; border-radius:999px; padding:2px 8px; font-size:12px; font-weight:600; border:1px solid var(--line) }
  .badge.red{ border-color:#6b2330; background:#2a0f16; color:#ffc9c9 }
  .badge.amber{ border-color:#5a4930; background:#2a200f; color:#ffd89c }
  .badge.green{ border-color:#285a3b; background:#0f2a1a; color:#a6f3c4 }

  /* Dropdown z checkboxami (statusy) */
  .dropdown{ position:relative }
  .dropdown-toggle{ display:flex; align-items:center; gap:6px; cursor:pointer }
  .dropdown-menu{
    position:absolute; top:100%; left:0; z-index:60; min-width:260px; margin-top:6px;
    background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:8px;
    box-shadow:0 10px 30px rgba(0,0,0,.2);
    display:none;
  }
  .dropdown.open .dropdown-menu{ display:block }
  .dd-grid{ display:grid; grid-template-columns:1fr 1fr; gap:6px 12px; align-items:center; }
  .dd-actions{ display:flex; justify-content:space-between; gap:8px; margin-top:8px }
  .dd-actions button{ padding:6px 8px }

  @media (max-width:980px){ .cards{ grid-template-columns:repeat(2,minmax(220px,1fr)) } }
  @media (max-width:640px){ .cards{ grid-template-columns:1fr } .dd-grid{ grid-template-columns:1fr } }
</style>

<!-- MSAL dynamic loader -->
<script>
  function loadScriptSequential(urls) {
    return new Promise((resolve, reject) => {
      let i = 0;
      const tryNext = () => {
        if (i >= urls.length) return reject(new Error('Nie uda≈Ço siƒô za≈Çadowaƒá msal-browser.'));
        const s = document.createElement('script');
        s.src = urls[i++]; s.async = true; s.onload = resolve; s.onerror = tryNext;
        document.head.appendChild(s);
      };
      tryNext();
    });
  }
  const MSAL_CDNS = [
    'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
    'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
  ];
</script>
</head>
<body>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="row">
    <strong>SIDUSIS ‚Äì Dashboard PH</strong>
    <span class="who" id="who"></span>
    <span style="flex:1"></span>

    <!-- prze≈ÇƒÖcznik motywu -->
    <button id="btnTheme" class="btn" title="Prze≈ÇƒÖcz motyw">üåô Tryb ciemny</button>

    <label class="small muted">≈πr√≥d≈Ço danych:</label>
    <select id="dsSelect" title="assets/datasources.json (opcjonalnie) ‚Äì wyb√≥r bazy"></select>
    <button id="btnLogin" class="btn">Zaloguj</button>
    <button id="btnLogout" class="btn">Wyloguj</button>
    <button id="btnReload" class="btn btn-primary">Od≈õwie≈º</button>
  </div>
</div>

<div class="wrap">
  <!-- KPI CARDS -->
  <div class="cards">
    <div class="card"><h3>Nieprzydzielone leady (wykl. KPO/MOICO/itd.)</h3><div class="kpi" id="kpiUnassigned">‚Äî</div><div class="small muted">Kliknij ‚ÄûOd≈õwie≈º‚Äù, aby przeliczyƒá.</div></div>
    <div class="card"><h3>Nowe nieprzydzielone ‚Äì poprzedni tydzie≈Ñ</h3><div class="kpi" id="kpiNewPrev">‚Äî</div><div class="small muted" id="prevRangeLabel"></div></div>
    <div class="card"><h3>Moje pilne (przeterminowane / dzi≈õ)</h3><div class="kpi" id="kpiMyDue">‚Äî</div><div class="small muted" id="myNameLabel"></div></div>
  </div>

  <!-- MANAGER CARDS (dynamicznie) -->
  <div class="cards cards-manager" id="cardsManager"></div>

  <!-- MY QUEUE -->
  <div class="panel">
    <div class="hd">
      <h2>Moje leady</h2>
      <div class="chips" id="quickChips"></div>
      <div class="tools controls">
        <!-- ZAKRES -->
        <label class="small muted">Zakres:</label>
        <!-- SCALONY ZAKRES: jedna kontrolka -->
        <select id="fltScopeUnified" title="Zakres danych (scalony)"></select>

        <!-- STATUS: kompaktowy dropdown z checkboxami -->
        <div class="dropdown" id="ddStatus">
          <button class="dropdown-toggle" id="fltStatusBtn" type="button">Statusy: (wszystkie) ‚ñº</button>
          <div class="dropdown-menu" id="fltStatusMenu">
            <div class="dd-grid" id="fltStatusGrid"></div>
            <div class="dd-actions">
              <button class="btn btn-ghost" id="stClear">Wyczy≈õƒá</button>
              <button class="btn btn-primary" id="stAll">Zaznacz wszystkie</button>
            </div>
          </div>
        </div>

        <!-- WYSZUKIWANIE -->
        <input type="text" id="fltQuery" placeholder="szukaj: miasto / ulica / nazwa" />

        <!-- DATA ZG≈ÅOSZENIA -->
        <label class="small muted">Data zg≈Çoszenia:</label>
        <input type="date" id="fltCreatedFrom" title="od">
        <input type="date" id="fltCreatedTo" title="do">

        <!-- NAST. KONTAKT -->
        <label class="small muted">Nast. kontakt:</label>
        <input type="date" id="fltNextFrom" title="od">
        <input type="date" id="fltNextTo" title="do">

        <button id="btnApply" class="btn">Filtruj</button>
        <a class="btn btn-ghost" href="mapa_test.html" target="_blank">Przejd≈∫ do mapy ‚Üí</a>
      </div>
    </div>
    <div class="bd">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Data zg≈Ç.</th><th>Klient / adres</th><th class="small">Kontakt</th>
            <th>Status</th><th>Next contact</th><th>OptOut</th><th>PH</th><th>Uwagi</th><th>Akcje</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="small muted" id="countInfo"></div>
    </div>
  </div>

  <div class="statusbar" id="statusbar">Kliknij ‚ÄûZaloguj‚Äù, a potem ‚ÄûOd≈õwie≈º‚Äù.</div>
  <div class="error" id="errorBar"></div>
</div>

<script>
(async function main(){
  /* ========== THEME ========== */
  const THEME_KEY='phdash_theme';
  const rootEl=document.documentElement; // ustaw atrybut na <html> dla poprawnego t≈Ça
  function applyTheme(theme){
    rootEl.setAttribute('data-theme', theme);
    document.getElementById('btnTheme').textContent = (theme==='light') ? '‚òÄÔ∏è Tryb jasny' : 'üåô Tryb ciemny';
    localStorage.setItem(THEME_KEY, theme);
  }
  (function initTheme(){
    const saved=localStorage.getItem(THEME_KEY);
    if(saved){ applyTheme(saved); }
    else{
      const prefersLight = window.matchMedia?.('(prefers-color-scheme: light)').matches;
      applyTheme(prefersLight ? 'light' : 'dark');
    }
    document.getElementById('btnTheme').addEventListener('click', ()=>{
      applyTheme(rootEl.getAttribute('data-theme')==='light' ? 'dark' : 'light');
    });
  })();

  /* ========== CONFIG ========== */
  const CONFIG = {
    clientId: "2c5a0274-30c0-4efa-b13c-7ce1e0768cf9",
    tenantId: "e44d0310-65ed-4096-a024-dac77110765a",
    spHost: "internetunion.sharepoint.com",
    spSitePath: "PHTheNetwork",
    filePath: "/General/Kopia pliku Lista - SIDUSIS - PE≈ÅNA - od 08-2025 - kopia do mapy.xlsx",
    dataSheet: "Dane",
    logSheet: "AuditLog"
  };
  const LS_KEY_DS = "sidusis_ds_key";
  const QUICK_CHIP_KEY = 'phdash_last_chip';
  let INITIAL_CHIP_APPLIED = false;

  /* ========== LISTS / STATUS RULES (SLA) ========== */
  const DEFAULT_LISTS = {
    ph: [], phAliases: {}, phUsers: {},
    status: ["Wycena Inwestycji","Oferta wys≈Çana","Odmowa klienta","Akceptacja klienta","Poza Zasiƒôgiem","KPO","MOICO","Duplikat","SEEV"],
    statusAliases: {
      "zapytanie o wycenƒô":"Wycena Inwestycji","zapytanie o wycene":"Wycena Inwestycji","wycena inwestycji":"Wycena Inwestycji",
      "oferta wys≈Çana":"Oferta wys≈Çana","odmowa klienta":"Odmowa klienta","akceptacja klienta":"Akceptacja klienta",
      "poza zasiƒôgiem":"Poza Zasiƒôgiem","kpo":"KPO","duplikat":"Duplikat","moico":"MOICO","seev":"SEEV"
    },
    statusColors: {
      "Wycena Inwestycji":"#607D8B","Oferta wys≈Çana":"#2196F3","Odmowa klienta":"#F44336",
      "Akceptacja klienta":"#4CAF50","Poza Zasiƒôgiem":"#000000","KPO":"#FF9800",
      "MOICO":"#8E24AA","Duplikat":"#9E9E9E","SEEV":"#00BCD4"
    },
    excluded: ["KPO","Poza Zasiƒôgiem","MOICO","Duplikat","SEEV"],
    rejectionReasons: ["Zbyt droga instalacja","Drogi abonament","Lepsza oferta konkurencji","Brak mo≈ºliwo≈õci technicznych","Nieaktualny kontakt","Inne"]
  };

  let LISTS = DEFAULT_LISTS;
  let PH_LIST = [], PH_ALIASES = {}, STATUS_LIST = [], STATUS_COLOR_MAP = {}, EXCLUDED_STATUSES = new Set();
  let STATUS_RULES = {}; // { Status: { slaDays: n, startField: "createdAt"|"LastTouchAt"|"NextContactAt" } }

  function normLower(s){ return String(s||"").toLowerCase().trim(); }

  async function loadLists(){
    try{
      const r = await fetch("assets/lists.json?v="+Date.now(), {cache:"no-store"});
      if(r.ok){ LISTS = { ...DEFAULT_LISTS, ...(await r.json()) }; }
    }catch(e){ console.warn("lists.json fallback", e); LISTS = DEFAULT_LISTS; }

    PH_LIST = Array.isArray(LISTS.ph) ? LISTS.ph.slice() : [];
    PH_ALIASES = Object.fromEntries(Object.entries(LISTS.phAliases||{}).map(([k,v])=>[normLower(k), v]));
    STATUS_LIST = Array.isArray(LISTS.status) ? LISTS.status.slice() : DEFAULT_LISTS.status;
    STATUS_COLOR_MAP = { ...DEFAULT_LISTS.statusColors, ...(LISTS.statusColors||{}) };
    EXCLUDED_STATUSES = new Set(Array.isArray(LISTS.excluded)? LISTS.excluded : DEFAULT_LISTS.excluded);

    // dropdown status√≥w
    const grid = document.getElementById("fltStatusGrid");
    grid.innerHTML = STATUS_LIST.map(s=>`<label><input type="checkbox" value="${s}"> ${s}</label>`).join("");
    updateStatusBtnLabel();
  }
  async function loadStatusRules(){
    try{
      const r = await fetch("assets/status_rules.json?v="+Date.now(), {cache:"no-store"});
      if(r.ok){ STATUS_RULES = await r.json(); }
    }catch(e){ console.warn("status_rules.json not found ‚Äì using defaults"); }
  }
  function canonStatus(s){
    const k = normLower(s);
    return (LISTS.statusAliases && LISTS.statusAliases[k]) ? LISTS.statusAliases[k] : (s||"");
  }
  function canonPH(s){
    const raw = String(s||"").trim();
    const a = PH_ALIASES[normLower(raw)] || raw;
    return a;
  }

  // rola: mened≈ºer = UPN lub cz≈Çonkostwo w grupie "SalesManagers" (je≈õli claims dostƒôpne)
  function isManager(){
    try{
      const upn = String(account?.username||"").toLowerCase();
      if(upn === "adaniel@internetunion.pl") return true;
      const claims = account?.idTokenClaims || {};
      const arr = []
        .concat(Array.isArray(claims.memberOf)?claims.memberOf:(claims.memberOf?[claims.memberOf]:[]))
        .concat(Array.isArray(claims.groups)?claims.groups:(claims.groups?[claims.groups]:[]))
        .concat(Array.isArray(claims.roles)?claims.roles:(claims.roles?[claims.roles]:[]));
      return arr.some(v=>String(v||"").toLowerCase().includes("salesmanagers"));
    }catch{ return false; }
  }

  /* ========== STATE ========== */
  let account=null, siteId=null, fileId=null;
  let rows=[], frows=[];
  let phDueOverride = null; // override: klikniƒôcie kafelka lub wymuszenie zakresu PH+‚â§dzi≈õ
  const $ = s=>document.querySelector(s);
  const dsSelect = $("#dsSelect");
  const who=$("#who"), statusbar=$("#statusbar"), errorBar=$("#errorBar");
  const tbody=$("#tbody"), countInfo=$("#countInfo");
  const kpiUnassigned=$("#kpiUnassigned"), kpiNewPrev=$("#kpiNewPrev"), prevRangeLabel=$("#prevRangeLabel"), kpiMyDue=$("#kpiMyDue"), myNameLabel=$("#myNameLabel");

  function setStatus(msg){ statusbar.textContent = String(msg||""); }
  function showError(msg){ errorBar.textContent=String(msg||""); errorBar.style.display='block'; setTimeout(()=>errorBar.style.display='none', 8000); }

  function toNum(v){ if(v==null) return NaN; const s=String(v).replace(",", ".").replace(/[^\d.\-+Ee]/g,"").trim(); return parseFloat(s); }
  function toDate(v){
    if(v==null || v==="") return null;
    if(typeof v==="number"){ const d = new Date(Date.UTC(1899,11,30)); d.setUTCDate(d.getUTCDate()+Math.floor(v)); return d; }
    const s=String(v).trim(); const d1 = new Date(s); if(!isNaN(d1)) return d1;
    const m = s.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
    if(m){ const [_,dd,mm,yy]=m; return new Date(Number(yy.length===2?("20"+yy):yy), Number(mm)-1, Number(dd)); }
    return null;
  }
  function fmtDateLocal(d){ if(!d) return ""; const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), dd=("0"+d.getDate()).slice(-2); return `${y}-${m}-${dd}`; }
  function todayLocal(){ const now = new Date(); return new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
  function prevWeekRange(){
    const d = todayLocal();
    const end = new Date(d); end.setDate(d.getDate()-1); end.setHours(23,59,59,999);
    const start = new Date(d); start.setDate(d.getDate()-7); start.setHours(0,0,0,0);
    return {start,end};
  }

  /* ========== DATASOURCES ========== */
  let DS = {}; let CURRENT_DS_KEY = "default";
  async function loadDatasources(){
    DS = { default: { title:"Domy≈õlne (CONFIG)", spHost:CONFIG.spHost, spSitePath:CONFIG.spSitePath, filePath:CONFIG.filePath } };
    try{
      const r = await fetch("assets/datasources.json?v="+Date.now(), {cache:"no-store"});
      if(r.ok){ for(const it of (await r.json()||[])){ if(it?.key && it?.spHost && it?.spSitePath && it?.filePath){ DS[it.key] = { title: it.title || it.key, spHost: it.spHost, spSitePath: it.spSitePath, filePath: it.filePath }; } } }
    }catch(e){ console.warn("datasources.json missing/invalid", e); }
    dsSelect.innerHTML = "";
    for(const [k,v] of Object.entries(DS)){ const opt = document.createElement("option"); opt.value = k; opt.textContent = v.title + " ‚Äî " + v.filePath.split("/").pop(); dsSelect.appendChild(opt); }
    const saved = localStorage.getItem(LS_KEY_DS); if(saved && DS[saved]) CURRENT_DS_KEY = saved; dsSelect.value = CURRENT_DS_KEY; applyDatasource(CURRENT_DS_KEY);
    dsSelect.addEventListener("change", ()=>{ CURRENT_DS_KEY = dsSelect.value; localStorage.setItem(LS_KEY_DS, CURRENT_DS_KEY); applyDatasource(CURRENT_DS_KEY); siteId=null; fileId=null; setStatus("Zmieniono ≈∫r√≥d≈Ço. Kliknij ‚ÄûOd≈õwie≈º‚Äù."); });
  }
  function applyDatasource(key){ const d = DS[key] || DS.default; CONFIG.spHost = d.spHost; CONFIG.spSitePath = d.spSitePath; CONFIG.filePath = d.filePath; }

  /* ========== MSAL / GRAPH ========== */
  try { await loadScriptSequential(MSAL_CDNS); } catch(e){ alert('MSAL nie za≈Çadowa≈Ç siƒô.'); console.error(e); return; }
  if (typeof msal === 'undefined' || !msal.PublicClientApplication){ alert('MSAL niedostƒôpny.'); return; }

  const msalApp = new msal.PublicClientApplication({
    auth: { clientId: CONFIG.clientId, authority: "https://login.microsoftonline.com/" + CONFIG.tenantId,
            redirectUri: window.location.origin + window.location.pathname },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
  });
  // DODANE zakresy do powiadomie≈Ñ
	const graphScopes = [
	  "openid","profile","offline_access",
	  "Files.ReadWrite.All","Sites.Read.All",
	  "Calendars.ReadWrite",              // je≈ºeli chcesz te≈º wpisy w kalendarzu
	  "Tasks.ReadWrite",                  // <-- Planner/To Do (delegated)
	  "Group.ReadWrite.All"               // <-- dostƒôp do plan√≥w/bucket√≥w
	];


  async function ensureLogin(){
    const accs = msalApp.getAllAccounts();
    if(accs.length){ account=accs[0]; who.textContent = "Zalogowano: " + (account.username||account.homeAccountId); return; }
    const r = await msalApp.loginPopup({ scopes: graphScopes });
    account = r.account; who.textContent = "Zalogowano: " + (account.username||account.homeAccountId);
  }
  async function getToken(){
    await ensureLogin();
    try{ const r=await msalApp.acquireTokenSilent({ scopes: graphScopes, account }); return r.accessToken; }
    catch{ const r=await msalApp.acquireTokenPopup({ scopes: graphScopes }); return r.accessToken; }
  }
  async function gfetch(method, url, body){
    const token = await getToken();
    const resp = await fetch(url, {
      method, headers: { "Authorization":"Bearer " + token, "Accept":"application/json", "Content-Type":"application/json" },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!resp.ok){ const txt=await resp.text().catch(()=>String(resp.status)); throw new Error(`${method} ${url} -> ${resp.status} ${txt}`); }
    return resp.status===204 ? null : resp.json();
  }
  async function getSiteId(){ if(siteId) return siteId; const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG.spHost}:/sites/${CONFIG.spSitePath}`; const js = await gfetch("GET", url); siteId = js.id; return siteId; }
  async function getFileItemId(){ if(fileId) return fileId; const sid = await getSiteId(); const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/root:${encodeURI(CONFIG.filePath)}`; const js = await gfetch("GET", url); fileId = js.id; return fileId; }
  async function usedRange(wsName){ const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]); const wsq = wsName.replace(/'/g,"''"); const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/usedRange(valuesOnly=true)`; return gfetch("GET", url); }
  async function patchRange(wsName, a1, values2d){ const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]); const wsq = wsName.replace(/'/g,"''"); const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${a1}')`; return gfetch("PATCH", url, { values: values2d }); }
  function colLetter(n){ let s="",x=n; while(x>0){x--; s=String.fromCharCode(65+(x%26))+s; x=Math.floor(x/26);} return s; }

  /* ========== PARSE ========== */
  function pickHeader(headers, tokens){ const lc = headers.map(h => String(h||"").toLowerCase()); for(const t of tokens){ const i = lc.findIndex(n => n.includes(t)); if(i>=0) return headers[i]; } return null; }

  function parseRows(values){
    if(!values || !values.length) return [];
    const headers = (values[0]||[]).map(h=>String(h||"").trim());
    const body = values.slice(1);
    const H = {
      created: headers[0],
      lat: pickHeader(headers,["szerokosc","szeroko≈õƒá","lat","latitude"]),
      lon: pickHeader(headers,["dlugosc","d≈Çugo≈õƒá","lon","longitude"]),
      tel: pickHeader(headers,["telefon","tel"]),
      mail: pickHeader(headers,["email","e-mail","mail"]),
      ph: pickHeader(headers,["ph"]),
      st: pickHeader(headers,["status"]),
      ulica: pickHeader(headers,["ulica","adres"]),
      nr: pickHeader(headers,["nr budynku","numer","nr","nr domu"]),
      msc: pickHeader(headers,["miejscowosc","miejscowo≈õƒá","miasto"]),
      nazwa: pickHeader(headers,["zglaszajacy","zg≈ÇaszajƒÖcy","nazwa","imiƒô","imie","nazwisko","klient","firma"]),
      adresPelny: pickHeader(headers,["adres_pelny","adres pelny","adres pe≈Çny"]),
      powod: pickHeader(headers,["powod","pow√≥d","pow√≥d odmowy","reason"]),
      notes: pickHeader(headers,["uwagi ph","uwagi","uwaga","notatki","note","notes"]),
      next: pickHeader(headers,["nextcontactat","nastƒôpny kontakt","nastepny kontakt"]),
      last: pickHeader(headers,["lasttouchat","ostatni kontakt"]),
      rSent: pickHeader(headers,["remindersentat"]),
      rId: pickHeader(headers,["remindertaskid"]),
      opt: pickHeader(headers,["optout"]),
      src: pickHeader(headers,["source"]),
      srcId: pickHeader(headers,["sourcerowid"]),
    };
    const get = (r, col) => { const idx=headers.indexOf(col); return idx>=0 ? r[idx] : ""; };

    let out = body.map((r, idx) => {
      let lat = toNum(get(r,H.lat)), lon = toNum(get(r,H.lon));
      let adr = get(r,H.adresPelny) || "";
      if(!adr){
        const u=String(get(r,H.ulica)||"").trim(), n=String(get(r,H.nr)||"").trim(), m=String(get(r,H.msc)||"").trim();
        adr = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
      }
      return {
        _row1: idx + 2,
        createdAt: toDate(get(r,H.created)),
        lat, lon, adres_pelny: adr||"",
        PH: canonPH(get(r,H.ph)),
        Status: canonStatus(String(get(r,H.st)||"")),
        telefon: String(get(r,H.tel)||""),
        email: String(get(r,H.mail)||""),
        nazwa: String(get(r,H.nazwa)||""),
        miejscowosc: String(get(r,H.msc)||""),
        PowodOdmowy: String(get(r,H.powod)||""),
        Uwagi: String(get(r,H.notes)||""),
        NextContactAt: toDate(get(r,H.next)),
        LastTouchAt: toDate(get(r,H.last)),
        ReminderSentAt: toDate(get(r,H.rSent)),
        ReminderTaskId: String(get(r,H.rId)||""),
        OptOut: String(get(r,H.opt)||""),
        Source: String(get(r,H.src)||""),
        SourceRowId: String(get(r,H.srcId)||"")
      };
    });

    // sanity wsp√≥≈Çrzƒôdnych
    const validLat=v=>isFinite(v)&&v>=-90&&v<=90, validLon=v=>isFinite(v)&&v>=-180&&v<=180;
    const okNormal=out.filter(o=>validLat(o.lat)&&validLon(o.lon)).length, okSwapped=out.filter(o=>validLat(o.lon)&&validLon(o.lat)).length;
    if(okSwapped>okNormal){ out = out.map(o=>({ ...o, lat:o.lon, lon:o.lat })); }
    return out;
  }

  /* ========== KPI / SLA / FILTRY / RENDER ========== */
  // Nieprzydzielone: brak PH (puste lub warianty 'brak'/'none'/'-'); wyklucz statusy z EXCLUDED_STATUSES
  function isUnassigned(rec){
    const st = (rec.Status||"").trim();
    const ph = String(rec.PH||"").trim();
    const phNorm = normLower(ph);
    const empty = !ph || phNorm==="brak" || phNorm==="none" || phNorm==="unassigned" || phNorm==="nieprzydzielone" || ph==="-";
    return empty && !EXCLUDED_STATUSES.has(st);
  }
  function inPrevWeek(rec){ if(!rec.createdAt) return false; const {start,end} = prevWeekRange(); return rec.createdAt >= start && rec.createdAt <= end; }
  function isDueForMe(rec, me){
    if((rec.PH||"").trim() !== (me||"").trim()) return false;
    const opt = String(rec.OptOut||"").toLowerCase(); if(opt==="1"||opt==="true"||opt==="x") return false;
    if(!rec.NextContactAt) return false; const d = todayLocal(); return rec.NextContactAt <= new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
  }
  // pilne: NextContactAt ‚â§ dzi≈õ i brak OptOut (bez w≈Ça≈õciciela)
  function isUrgentLead(rec){
    const opt = String(rec.OptOut||"").toLowerCase(); if(opt==="1"||opt==="true"||opt==="x") return false;
    if(!rec.NextContactAt) return false; const d = todayLocal();
    return rec.NextContactAt <= new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
  }

  function scoreKPIs(me){
    const unassigned = rows.filter(isUnassigned).length;
    const newPrev = rows.filter(r=>isUnassigned(r)&&inPrevWeek(r)).length;
    const myDue = rows.filter(r=>isDueForMe(r, me)).length;
    kpiUnassigned.textContent = unassigned;
    kpiUnassigned.className = "kpi " + (unassigned>50?"verybad":unassigned>10?"bad":"");
    kpiNewPrev.textContent = newPrev;
    const {start,end} = prevWeekRange();
    prevRangeLabel.textContent = "Zakres: " + fmtDateLocal(start) + (fmtDateLocal(start)!==fmtDateLocal(end) ? " ‚Äì " + fmtDateLocal(end) : "");
    kpiMyDue.textContent = myDue;
    kpiMyDue.className = "kpi " + (myDue===0?"good":myDue>10?"verybad":"bad");
  }

  // --------- rozpoznanie SLA
  function slaDeadline(rec){
    const rule = STATUS_RULES[rec.Status]; if(!rule || !rule.slaDays) return null;
    const start = rule.startField==="LastTouchAt" ? rec.LastTouchAt
                : rule.startField==="NextContactAt" ? rec.NextContactAt
                : rec.createdAt;
    if(!start) return null;
    const d = new Date(start); d.setDate(d.getDate()+Number(rule.slaDays||0)); d.setHours(23,59,59,999);
    return d;
  }
  function isSLAOverdue(rec){
    const dl = slaDeadline(rec); if(!dl) return false;
    const opt = String(rec.OptOut||"").toLowerCase(); if(opt==="1"||opt==="true"||opt==="x") return false;
    return new Date() > dl;
  }

  // wype≈Çnia scalony select Zakres wg roli u≈ºytkownika
  function updateManagerOwnerSelect(){
    const sel = document.getElementById("fltScopeUnified");
    if(!sel) return;
    const prev = sel.value; // zachowaj poprzedniƒÖ warto≈õƒá
    const boss = isManager();
    sel.innerHTML = "";
    const add = (label, value, disabled=false)=>{ const o=document.createElement('option'); o.value=value; o.textContent=label; if(disabled) o.disabled=true; sel.appendChild(o); };
    add("Tylko moje","my");
    add("Do kontaktu (‚â§ dzi≈õ)","due");
    add("Tylko nieprzydzielone","unassigned");
    if(boss){
      add("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ","__sep__", true); // separator
      const rowPH = Array.from(new Set(rows.map(r=>String(r.PH||'').trim()).filter(Boolean)));
      const list = Array.from(new Set([...(PH_LIST||[]), ...rowPH]));
      list.forEach(ph=> add("PH: "+ph, "ph:"+ph));
      add("Wszyscy PH","all_ph");
    }
    const allowed = Array.from(sel.options).map(o=>o.value);
    sel.value = allowed.includes(prev) ? prev : "my";
  }

  function parseDateInput(id, endOfDay=false){ const v=document.getElementById(id).value; return v ? new Date(v + (endOfDay? "T23:59:59" : "T00:00:00")) : null; }
  function getSelectedStatuses(){ return [...document.querySelectorAll('#fltStatusGrid input[type="checkbox"]')].filter(ch=>ch.checked).map(ch=>ch.value); }
  function updateStatusBtnLabel(){ const sel=getSelectedStatuses(); document.getElementById("fltStatusBtn").textContent = sel.length ? `Statusy: ${sel.length} wybrane ‚ñº` : 'Statusy: (wszystkie) ‚ñº'; }
  function setAllStatuses(checked){ document.querySelectorAll('#fltStatusGrid input[type="checkbox"]').forEach(ch=>ch.checked=checked); updateStatusBtnLabel(); }

  // ---------- QUICK CHIPS ----------
  function buildQuickChips(){
    const box = document.getElementById('quickChips'); if(!box) return;
    const boss = isManager();
    const chips = [
      { id:'my_due', label:'Moje zaleg≈Çe' },
      { id:'my_all', label:'Moje wszystkie' },
      { id:'unassigned_recent', label:'Nieprzydzielone' },
    ];
    if(boss) chips.push({ id:'allph_due', label:'Wszyscy PH ‚Äî zaleg≈Çe' });
    box.innerHTML = chips.map(c=>`<button class="quick-chip" data-id="${c.id}">${c.label}</button>`).join('');
    // dynamiczny chip dla override PH
    if(phDueOverride){ const b=document.createElement('button'); b.className='quick-chip'; b.dataset.id='ph_due'; b.textContent='PH zaleg≈Çe'; box.appendChild(b); }
  }

  function setDateInput(id, d){ const el=document.getElementById(id); if(!el) return; el.value = d? fmtDateLocal(d): ''; }

  function applyChip(id, save=true){
    const sel = document.getElementById('fltScopeUnified');
    // reset status√≥w (pusty = brak filtra) i wyszukiwarki
    setAllStatuses(false);
    const q = document.getElementById('fltQuery'); if(q) q.value='';
    // wyczy≈õƒá daty domy≈õlnie
    ['fltCreatedFrom','fltCreatedTo','fltNextFrom','fltNextTo'].forEach(k=> setDateInput(k, null));
    const today = todayLocal();
    if(id==='my_due'){
      phDueOverride=null; if(sel) sel.value='due';
    }else if(id==='my_all'){
      phDueOverride=null; if(sel) sel.value='my';
    }else if(id==='unassigned_recent' || id==='unassigned' || id==='unassigned_all'){
      phDueOverride=null; if(sel) sel.value='unassigned';
      // brak daty: wszystkie nieprzydzielone
      ['fltCreatedFrom','fltCreatedTo','fltNextFrom','fltNextTo'].forEach(k=> setDateInput(k, null));
    }else if(id==='allph_due'){
      phDueOverride=null; if(sel) sel.value='all_ph'; setDateInput('fltNextTo', today);
    }else if(id==='ph_due'){
      // tylko pod≈õwietlenie ‚Äì zakres utrzymuje phDueOverride
    }
    if(save) localStorage.setItem(QUICK_CHIP_KEY, id);
    updateQuickChipsActive(id);
    applyFilters(); renderTable();
  }

  function updateQuickChipsActive(currentId){
    const box=document.getElementById('quickChips'); if(!box) return;
    // zarzƒÖdzaj chipem ph_due
    let phChip = box.querySelector('.quick-chip[data-id="ph_due"]');
    if(phDueOverride){ if(!phChip){ phChip=document.createElement('button'); phChip.className='quick-chip'; phChip.dataset.id='ph_due'; phChip.textContent='PH zaleg≈Çe'; box.appendChild(phChip); } }
    else{ if(phChip) phChip.remove(); }
    [...box.querySelectorAll('.quick-chip')].forEach(b=> b.classList.toggle('active', b.dataset.id===currentId));
  }

  function applyFilters(){
    const scope = (document.getElementById("fltScopeUnified")?.value)||"my";
    const q = (document.getElementById("fltQuery").value||"").toLowerCase().trim();
    const me = (account && (account.name||"")) || "";
    const WANT_ST = getSelectedStatuses();
    const cFrom=parseDateInput("fltCreatedFrom"), cTo=parseDateInput("fltCreatedTo",true);
    const nFrom=parseDateInput("fltNextFrom"),   nTo=parseDateInput("fltNextTo",true);

    frows = rows.filter(r=>{
      // podstawowy zakres
      let pass=true;
      if(phDueOverride){ pass = (r.PH||"") === phDueOverride && isUrgentLead(r); }
      else if(scope==="due") pass = isDueForMe(r, me);
      else if(scope==="my") pass = (r.PH||"").trim() === (me||"").trim();
      else if(scope==="unassigned") pass = isUnassigned(r);
      else if(scope==="all_ph") pass = !isUnassigned(r);
      else if(String(scope||"").startsWith("ph:")) { const trg = String(scope).slice(3); pass = (r.PH||"") === trg; }
      if(!pass) return false;

      if(WANT_ST.length && !WANT_ST.includes(r.Status||"")) return false;
      if(cFrom && (!r.createdAt || r.createdAt < cFrom)) return false;
      if(cTo   && (!r.createdAt || r.createdAt > cTo))   return false;
      if(nFrom || nTo){
        const nc = r.NextContactAt;
        if(nFrom && (!nc || nc < nFrom)) return false;
        if(nTo   && (!nc || nc > nTo))   return false;
      }
      if(q){
        const hay=[r.miejscowosc||"",r.adres_pelny||"",r.nazwa||"",r.telefon||"",r.email||""].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    // sortowanie: je≈õli wskazano kolumnƒô ‚Äì u≈ºyj jej; w przeciwnym razie domy≈õlnie SLA -> Next -> Created
    const today = todayLocal();
    if(SORT.key){
      const key = SORT.key, dir = SORT.dir;
      frows.sort((a,b)=>{
        if(key==='Status'){
          const av=String(a.Status||''), bv=String(b.Status||'');
          const cmp = av.localeCompare(bv, 'pl', {sensitivity:'base'});
          return cmp*dir || ((a.createdAt?.getTime?.()||0)-(b.createdAt?.getTime?.()||0));
        }
        const av=a[key], bv=b[key];
        const at = av? (av.getTime? av.getTime(): new Date(av).getTime()): Infinity;
        const bt = bv? (bv.getTime? bv.getTime(): new Date(bv).getTime()): Infinity;
        return (at-bt)*dir || (String(a.Status||'').localeCompare(String(b.Status||'')));
      });
    } else {
      frows.sort((a,b)=>{
        const oa = isSLAOverdue(a)?0:1, ob = isSLAOverdue(b)?0:1;
        if(oa!==ob) return oa-ob;
        const da = a.NextContactAt ? (a.NextContactAt - today) : 9e15;
        const db = b.NextContactAt ? (b.NextContactAt - today) : 9e15;
        if(da!==db) return da - db;
        const ca = a.createdAt ? a.createdAt.getTime() : 0;
        const cb = b.createdAt ? b.createdAt.getTime() : 0;
        return ca - cb;
      });
    }
  }

  function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function colorForStatus(st){ return STATUS_COLOR_MAP[st] || "#9E9E9E"; }

  // Sortowanie
  let SORT = { key: null, dir: 1 }; // key: 'createdAt' | 'NextContactAt' | 'Status'
  function setSort(key){
    if(SORT.key===key){ SORT.dir = -SORT.dir; } else { SORT.key = key; SORT.dir = 1; }
    // ikony sortowania w nag≈Ç√≥wkach
    document.querySelectorAll('#tbl thead th').forEach(th=>{
      const k = th.dataset.sortKey; if(!k){ return; }
      const label = th.dataset.label || th.textContent.trim();
      th.dataset.label = label; th.dataset.sortKey = k; th.style.cursor='pointer';
      if(!th.querySelector('.thicon')){ th.innerHTML = `<span class="thlbl">${label}</span> <span class="thicon">‚áÖ</span>`; }
      const icon = th.querySelector('.thicon');
      icon.textContent = (SORT.key===k) ? (SORT.dir>0? '‚ñ≤':'‚ñº') : '‚áÖ';
    });
    applyFilters();
    renderTable();
  }
  function initSortHeaders(){
    const ths = document.querySelectorAll('#tbl thead th');
    const map = [ {idx:0,key:'createdAt'}, {idx:3,key:'Status'}, {idx:4,key:'NextContactAt'}, {idx:6,key:'PH'} ];
    map.forEach(({idx,key})=>{ const th=ths[idx]; if(!th) return; th.dataset.sortKey=key; th.dataset.label=th.textContent.trim(); th.style.cursor='pointer'; th.innerHTML = `<span class="thlbl">${th.dataset.label}</span> <span class="thicon">‚áÖ</span>`; th.addEventListener('click', ()=>setSort(key)); });
  }

  // szablony maili ‚Äì jak wcze≈õniej
  function mailTemplates(rec){
    const nazwa=rec.nazwa||""; let adres=(rec.adres_pelny||"").trim(); const tel=rec.telefon||""; const email=rec.email||"";
    const subj_inv=`Zapytanie o wycenƒô - ${adres} - SIDUSIS`;
    const subj_cli=`Internet ≈õwiat≈Çowodowy - The Network - ${adres}`;
    const body_inv=`Proszƒô o wycenƒô pod≈ÇƒÖczenia klienta:\nNazwa: ${nazwa}\nAdres: ${adres}\nTelefon: ${tel}\nE-mail: ${email}\n`;
    const body_cli=`Dzie≈Ñ dobry ${nazwa},\n\nSerdecznie dziƒôkujemy za przes≈Çane zg≈Çoszenie. Wr√≥cƒô z informacjƒÖ.\n`;
    const body_std=`Dzie≈Ñ dobry,\n\nW odpowiedzi na zg≈Çoszenie ‚Äì oferta standardowa‚Ä¶\n`;
    const body_dev=`Dzie≈Ñ dobry,\n\nW odpowiedzi na zg≈Çoszenie ‚Äì oferta deweloperska‚Ä¶\n`;
    return { INV:{to:"inwestycje@internetunion.pl",subject:subj_inv,body:body_inv}, CLI:{to:email,subject:subj_cli,body:body_cli}, STD:{to:email,subject:subj_cli,body:body_std}, DEV:{to:email,subject:subj_cli,body:body_dev} };
  }
  function composeAndSend(to,subject,body){
    const base="mailto:"+encodeURIComponent(to||"")+"?subject="+encodeURIComponent(subject||"");
    const full=base+"&body="+encodeURIComponent(body||"");
    if(full.length<=1500){ location.href=full; }
    else if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(body||"").then(()=>{ location.href=base; alert("Tre≈õƒá zbyt d≈Çuga ‚Äì skopiowano do schowka. Wklej w oknie poczty (Ctrl+V)."); }); }
    else{ location.href=base; }
  }

  function renderTable(){
    tbody.innerHTML = "";
    for(const rec of frows.slice(0,800)){
      const tr = document.createElement("tr");

      const overdue = isSLAOverdue(rec);
      const over = rec.NextContactAt && rec.NextContactAt < todayLocal();
      const dueToday = rec.NextContactAt && fmtDateLocal(rec.NextContactAt)===fmtDateLocal(todayLocal());
      const badgeClass = overdue ? "pill red" : (over ? "pill amber" : (dueToday ? "pill amber" : "pill"));
      const stColor = colorForStatus(rec.Status);
      const dl = slaDeadline(rec);

      tr.innerHTML = `
        <td class="small muted">${rec.createdAt?fmtDateLocal(rec.createdAt):""}</td>
        <td>
          <div><strong>${esc(rec.nazwa||"")}</strong> <span class="pill" style="border-color:#2a355f;background:var(--panel-2)">${esc(rec.PH||"-")}</span></div>
          <div class="muted small">${esc(rec.adres_pelny||"")}</div>
          <div class="small">
            <span class="${badgeClass}">
              ${rec.NextContactAt?("Kontakt: "+fmtDateLocal(rec.NextContactAt)):"brak terminu"}
              ${dl?` ‚Ä¢ SLA: ${fmtDateLocal(dl)}`:""}
            </span>
          </div>
        </td>
        <td class="small">${esc(rec.email||"")}<br/>${esc(rec.telefon||"")}</td>
        <td><select class="selStatus" style="border-left:4px solid ${stColor}">${["",...STATUS_LIST].map(st=>`<option ${st===(rec.Status||"")?"selected":""}>${esc(st)}</option>`).join("")}</select></td>
        <td><input type="date" class="inpNext" value="${rec.NextContactAt?fmtDateLocal(rec.NextContactAt):""}" /></td>
        <td style="text-align:center"><input type="checkbox" class="chkOpt" ${(["1","true","TRUE","x","X"].includes(String(rec.OptOut||"")))?"checked":""} /></td>
        <td class="small">${esc(rec.PH||"")}</td>
        <td><textarea class="taUwagi" rows="2" style="width:220px">${esc(rec.Uwagi||"")}</textarea></td>
        <td class="small">
          <div class="row-actions" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
            <button class="btn btn-compact" data-mail="INV">INV</button>
            <button class="btn btn-compact" data-mail="CLI">CLI</button>
            <button class="btn btn-compact" data-mail="STD">STD</button>
            <button class="btn btn-compact" data-mail="DEV">DEV</button>
          </div>
          <div class="row-actions" style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn btn-primary btnSave">Zapisz</button>
            <button class="btn btn-ghost btnTouch">Dotknij</button>
          </div>
        </td>
      `;

      tr.querySelectorAll('button[data-mail]').forEach(b=>{
        b.addEventListener('click',()=>{ const t=mailTemplates(rec)[b.getAttribute('data-mail')]; composeAndSend(t.to,t.subject,t.body); });
      });
      tr.querySelector(".selStatus").addEventListener("change", e=> e.currentTarget.style.borderLeftColor = colorForStatus(e.currentTarget.value||""));

      tr.querySelector(".btnSave").addEventListener("click", async ()=>{
        try{
          const newSt = tr.querySelector(".selStatus").value || "";
          const newNext = tr.querySelector(".inpNext").value ? new Date(tr.querySelector(".inpNext").value+"T00:00:00") : null;
          const newOpt = tr.querySelector(".chkOpt").checked ? "1" : "";
          const newUw = tr.querySelector(".taUwagi").value || "";
          await saveFields(rec, { Status:newSt, NextContactAt:newNext, OptOut:newOpt, Uwagi:newUw });
          rec.Status=newSt; rec.NextContactAt=newNext; rec.OptOut=newOpt; rec.Uwagi=newUw;
          setStatus("Zapisano zmiany."); scoreKPIs((account && account.name)||"");
        }catch(e){ showError("B≈ÇƒÖd zapisu: " + (e.message||e)); }
      });

      tr.querySelector(".btnTouch").addEventListener("click", async ()=>{
        try{ const now = new Date(); await saveFields(rec, { LastTouchAt: now }); rec.LastTouchAt = now; setStatus("Zapisano LastTouchAt = teraz."); }
        catch(e){ showError("B≈ÇƒÖd zapisu: " + (e.message||e)); }
      });

      tbody.appendChild(tr);
    }
    countInfo.textContent = `Widoczne: ${frows.length} / Wszystkich: ${rows.length}`;
  }

  /* ========== ZAPIS + AUDITLOG ========== */
  const AUDIT_HEADERS = ["ts","user","action","itemId","adres_pelny","old","new","note"];
  async function ensureAuditHeaders(){ const used = await usedRange(CONFIG.logSheet); const have = (used.values && used.values[0]) ? used.values[0].map(v=>String(v||"").trim()) : []; const need = AUDIT_HEADERS.some((h,i)=> (have[i]||"") !== h); if (need){ const a1 = `A1:${colLetter(AUDIT_HEADERS.length)}1`; await patchRange(CONFIG.logSheet, a1, [AUDIT_HEADERS]); } }
  async function getNextLogRow(){ const used = await usedRange(CONFIG.logSheet); const values = used.values || []; return Math.max(2, values.length + 1); }
  async function appendLog(row){ await ensureAuditHeaders(); const next = await getNextLogRow(); const a1 = `A${next}:${colLetter(AUDIT_HEADERS.length)}${next}`; await patchRange(CONFIG.logSheet, a1, [row]); }

  async function saveFields(rec, patchObj){
    const used = await usedRange(CONFIG.dataSheet);
    const vals = used.values || []; if(!vals.length) throw new Error("Arkusz pusty.");
    const headers = (vals[0]||[]).map(h=>String(h||"").trim());
    function needCol(title){ let idx = headers.findIndex(h=>String(h).toLowerCase().trim()===title.toLowerCase()); if(idx<0){ idx = headers.length; headers.push(title); } return idx; }
    const idxStatus = needCol("Status"), idxNext=needCol("NextContactAt"), idxLast=needCol("LastTouchAt"), idxOpt=needCol("OptOut");
    const idxUwagi = (()=>{ let i = headers.findIndex(h=>normLower(h).includes("uwagi")); if(i<0){ i = headers.length; headers.push("Uwagi"); } return i; })();
    const idxRSent=needCol("ReminderSentAt"), idxRTask=needCol("ReminderTaskId");

    let row1 = Number(rec._row1)||-1; if(row1<0) throw new Error("Brak wska≈∫nika wiersza.");
    const toA1 = (idx)=> `${colLetter(idx+1)}${row1}`;

    const old = { Status: rec.Status, NextContactAt: rec.NextContactAt, LastTouchAt: rec.LastTouchAt, OptOut: rec.OptOut, Uwagi: rec.Uwagi, ReminderSentAt: rec.ReminderSentAt, ReminderTaskId: rec.ReminderTaskId };
    const neu = { ...old, ...patchObj };

    if(headers.length !== (vals[0]||[]).length){ await patchRange(CONFIG.dataSheet, `A1:${colLetter(headers.length)}1`, [headers]); }

    const writes = [];
    if("Status" in patchObj)       writes.push({ a1: toA1(idxStatus), val: [[ String(neu.Status||"") ]] });
    if("NextContactAt" in patchObj)writes.push({ a1: toA1(idxNext),   val: [[ neu.NextContactAt? fmtDateLocal(neu.NextContactAt): "" ]] });
    if("LastTouchAt" in patchObj)  writes.push({ a1: toA1(idxLast),   val: [[ neu.LastTouchAt? fmtDateLocal(neu.LastTouchAt): "" ]] });
    if("OptOut" in patchObj)       writes.push({ a1: toA1(idxOpt),    val: [[ String(neu.OptOut||"") ]] });
    if("Uwagi" in patchObj)        writes.push({ a1: toA1(idxUwagi),  val: [[ String(neu.Uwagi||"") ]] });
    if("ReminderSentAt" in patchObj) writes.push({ a1: toA1(idxRSent), val: [[ neu.ReminderSentAt? fmtDateLocal(neu.ReminderSentAt): "" ]] });
    if("ReminderTaskId" in patchObj) writes.push({ a1: toA1(idxRTask), val: [[ String(neu.ReminderTaskId||"") ]] });
    for(const w of writes){ await patchRange(CONFIG.dataSheet, w.a1, w.val); }

    const now = new Date().toISOString();
    const upn = (account && (account.username||account.homeAccountId)) || "";
    const logOld = [ old.Status||"", old.NextContactAt?fmtDateLocal(old.NextContactAt):"", old.LastTouchAt?fmtDateLocal(old.LastTouchAt):"", old.OptOut||"", (old.Uwagi||"").slice(0,150) ].join("|");
    const logNew = [ neu.Status||"", neu.NextContactAt?fmtDateLocal(neu.NextContactAt):"", neu.LastTouchAt?fmtDateLocal(neu.LastTouchAt):"", neu.OptOut||"", (neu.Uwagi||"").slice(0,150) ].join("|");
    await appendLog([ now, upn, "UpdatePHDashboard", "", rec.adres_pelny||"", logOld, logNew, "" ]);
  }

  /* ========== POWIADOMIENIA (Planner / Outlook / Teams) ========== */
  let NOTIFY_CFG = null;
  async function loadNotifyCfg(){
    try{
      const r = await fetch("assets/notify.json?v="+Date.now(), {cache:"no-store"});
      if(r.ok){ NOTIFY_CFG = await r.json(); }
    }catch(e){ console.warn("notify.json not found ‚Äì notifications disabled"); }
  }

  async function createCalendarEvent(rec, deadline){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Warsaw";
    const body = {
      subject: `SLA PRZEKROCZONE ‚Ä¢ ${rec.Status} ‚Ä¢ ${rec.miejscowosc||""} ‚Ä¢ ${rec.nazwa||""}`,
      body: { contentType:"Text", content: `Adres: ${rec.adres_pelny||""}\nPH: ${rec.PH||""}\nStatus: ${rec.Status}\nSLA: ${fmtDateLocal(deadline)}\n` },
      start: { dateTime: fmtDateLocal(deadline)+"T09:00:00", timeZone: tz },
      end:   { dateTime: fmtDateLocal(deadline)+"T09:30:00", timeZone: tz }
    };
    const ev = await gfetch("POST","https://graph.microsoft.com/v1.0/me/events", body);
    return ev?.id || "";
  }

  async function createPlannerTask(rec, deadline){
    if(!NOTIFY_CFG?.planner?.planId || !NOTIFY_CFG?.planner?.bucketId) return "";
    const body = {
      planId: NOTIFY_CFG.planner.planId,
      bucketId: NOTIFY_CFG.planner.bucketId,
      title: `SLA ‚Ä¢ ${rec.Status} ‚Ä¢ ${rec.miejscowosc||""} ‚Ä¢ ${rec.nazwa||""}`,
      assignments: {},  // przypisanie opcjonalnie po UPN
      dueDateTime: deadline.toISOString()
    };
    const t = await gfetch("POST","https://graph.microsoft.com/v1.0/planner/tasks", body).catch(()=>null);
    return t?.id || "";
  }

  async function sendTeamsDM(rec, deadline){
    if(!NOTIFY_CFG?.teams?.userId) return "";
    const body = { body: { content: `SLA **${rec.Status}** przekroczone dla **${rec.nazwa||""}** (${rec.adres_pelny||""}). Termin: ${fmtDateLocal(deadline)}` } };
    const chat = await gfetch("POST",`https://graph.microsoft.com/v1.0/users/${NOTIFY_CFG.teams.userId}/chats`, { chatType:"oneOnOne", members:[] }).catch(()=>null);
    if(!chat?.id) return "";
    await gfetch("POST",`https://graph.microsoft.com/v1.0/chats/${chat.id}/messages`, body).catch(()=>null);
    return chat.id;
  }

  async function notifyIfNeeded(rec){
    if(!isSLAOverdue(rec)) return;
    if(rec.ReminderSentAt) return; // ju≈º powiadomiony
    const deadline = slaDeadline(rec); if(!deadline) return;

    let taskId = "";
    try{
      if(NOTIFY_CFG?.mode==="planner") taskId = await createPlannerTask(rec, deadline);
      else if(NOTIFY_CFG?.mode==="teams") taskId = await sendTeamsDM(rec, deadline);
      else taskId = await createCalendarEvent(rec, deadline); // domy≈õlnie Outlook
      await saveFields(rec, { ReminderSentAt: new Date(), ReminderTaskId: taskId });
    }catch(e){ console.warn("notify failed", e); }
  }

  /* ========== ≈ÅADOWANIE / START ========== */
  function scoreAndRender(){
    const me = (account && (account.name||"")) || "";
    myNameLabel.textContent = me ? ("Przypisane do: " + me) : "";
    updateManagerOwnerSelect();
    buildQuickChips();
    scoreKPIs(me);
    applyFilters();
    renderTable();
  }

  async function loadData(){
    setStatus("≈Åadowanie list / regu≈Ç / ≈∫r√≥de≈Ç‚Ä¶");
    await Promise.all([loadLists(), loadStatusRules(), loadNotifyCfg(), loadDatasources()]);

    setStatus("≈Åadowanie danych z Excela‚Ä¶");
    const used = await usedRange(CONFIG.dataSheet);
    const values = used.values || [];
    if(!values.length){ rows=[]; frows=[]; setStatus("Arkusz ‚ÄûDane‚Äù pusty."); renderTable(); scoreKPIs((account&&account.name)||""); return; }

    rows = parseRows(values);
    scoreAndRender();

    // uruchom powiadomienia SLA dla widocznych rekord√≥w
    for(const r of rows){ notifyIfNeeded(r); }
    setStatus("Gotowe.");
  }

  // przyciski
  document.getElementById("btnLogin").addEventListener("click", async ()=>{ try{ await ensureLogin(); setStatus("Zalogowano."); updateManagerOwnerSelect(); }catch(e){ showError("Logowanie nieudane: " + (e.message||e)); } });
  document.getElementById("btnLogout").addEventListener("click", async ()=>{
    try{ const acc = msalApp.getAllAccounts()[0]; if(acc){ await msalApp.logoutPopup({ account: acc }); }
      account=null; who.textContent=""; setStatus("Wylogowano."); }catch(e){ showError("Wylogowanie nieudane: " + (e.message||e)); }
  });
  document.getElementById("btnReload").addEventListener("click", async ()=>{ try{ await ensureLogin(); await loadData(); }catch(e){ showError(e.message||e); } });
  document.getElementById("btnApply").addEventListener("click", ()=>{ phDueOverride=null; scoreAndRender(); });
  // zmiana unified scope usuwa ewentualny override
  (function(){ const s=document.getElementById('fltScopeUnified'); if(s){ s.addEventListener('change', ()=>{ phDueOverride=null; }); }})();
  // quick chips click
  (function(){ const box=document.getElementById('quickChips'); if(box){ box.addEventListener('click', (e)=>{ const b=e.target.closest('.quick-chip'); if(!b) return; applyChip(b.dataset.id,true); }); }})();

  // dropdown status√≥w
  const dd = document.getElementById('ddStatus');
  document.getElementById('fltStatusBtn').addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.toggle('open'); });
  document.getElementById('stAll').addEventListener('click', ()=> setAllStatuses(true));
  document.getElementById('stClear').addEventListener('click', ()=> setAllStatuses(false));
  document.getElementById('fltStatusMenu').addEventListener('change', updateStatusBtnLabel);
  document.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); });

  // start
  initSortHeaders();
  await loadLists();
  await loadStatusRules();
  await loadNotifyCfg();
  await loadDatasources();
  // zastosuj ostatni chip (je≈õli zapisany)
  const savedChip = localStorage.getItem(QUICK_CHIP_KEY);
  if(savedChip){ applyChip(savedChip, false); }
  msalApp.handleRedirectPromise().catch(e=>console.warn('MSAL redirect:', e));
  setStatus("Kliknij ‚ÄûZaloguj‚Äù, a potem ‚ÄûOd≈õwie≈º‚Äù.");
})();
</script>
</body>
</html>
