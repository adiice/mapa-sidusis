<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>SIDUSIS â€“ mapa leadÃ³w (ONLINE: MSAL + Graph + Excel na SharePoint)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body { height:100%; margin:0; font-family:system-ui, Segoe UI, Roboto, Arial; }
  #map { height:100%; }
  .toolbar {
    position: fixed; top: 12px; right: 12px; z-index: 10000;
    background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px 12px; box-shadow:0 4px 20px rgba(0,0,0,.08);
    max-width: 640px;
  }
  .toolbar .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toolbar button { font:13px/1.2 inherit; padding:8px 10px; border-radius:10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
  .toolbar .hint, .toolbar .small { font-size:12px; color:#666; }
  .statusbar { margin-top:8px; padding:8px; background:#f9fafb; border:1px dashed #cbd5e1; border-radius:10px; font-size:12px; white-space:pre-wrap; }
  .legend {
    position: fixed; left: 12px; bottom: 16px; z-index: 10000;
    background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px 12px; box-shadow:0 4px 20px rgba(0,0,0,.08);
    font-size:12px; line-height:1.35;
  }
  .legend .title { font-weight:700; margin:4px 0; }
  .pill { display:inline-block; width:10px; height:10px; vertical-align:middle; margin-right:6px; border:1px solid #999; }
  .status-pill { border-radius:50%; }
  .popup h4 { margin:0 0 6px; font-size:14px; }
  .popup .row { display:flex; gap:6px; align-items:center; margin:8px 0; flex-wrap:wrap; }
  .popup select { border:1px solid #ccc; border-radius:8px; padding:6px 8px; font-size:13px; }
  .popup button { border:1px solid #bbb; border-radius:8px; padding:6px 10px; background:#f6f6f6; cursor:pointer; font-size:13px; }
  .popup .meta { font-size:12px; color:#555; margin:6px 0; }
  .popup .actions a { display:block; margin:4px 0; text-decoration:none; }
  .error {
    position: fixed; inset: 0 0 auto 0; top:0; background:#fff3f3; border-bottom:1px solid #e99; color:#900; padding:10px 12px; z-index: 11000;
    font-size:13px; display:none;
  }
</style>

<!-- Leaflet (mapa) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Loader z fallbackiem dla MSAL -->
<script>
  function loadScriptSequential(urls) {
    return new Promise((resolve, reject) => {
      let i = 0;
      const tryNext = () => {
        if (i >= urls.length) return reject(new Error('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ msal-browser z Å¼adnego CDN.'));
        const s = document.createElement('script');
        s.src = urls[i++];
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => tryNext();
        document.head.appendChild(s);
      };
      tryNext();
    });
  }

  // 3 ÅºrÃ³dÅ‚a MSAL â€“ jeÅ›li korporacyjnie blokuje alcdn, wejdzie jsDelivr / unpkg
  const MSAL_CDNS = [
    'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
    'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
  ];
</script>
</head>

<body>
<div id="map"></div>

<div class="toolbar">
  <div class="row">
    <strong>SIDUSIS â€“ Mapa leadÃ³w (ONLINE)</strong>
    <span class="small" id="who"></span>
  </div>
  <div class="row">
    <button id="btnLogin">Zaloguj</button>
    <button id="btnLogout">Wyloguj</button>
    <button id="btnReload">OdÅ›wieÅ¼ dane z Excelem</button>
  </div>
  <div class="hint">Po zalogowaniu: kliknij pinezkÄ™ â†’ wybierz PH/Status â†’ â€Zapiszâ€ (zapis do Excela na SharePoint) â€¢ PoniÅ¼ej status.</div>
  <div class="statusbar" id="statusbar">Nie zalogowano.</div>
</div>

<div class="legend" id="legend"></div>
<div class="error" id="errorBar"></div>

<script>
(async function main(){
/* =========================== KONFIG (Twoje dane) =========================== */
const CONFIG = {
  // Entra ID (Azure AD)
  clientId: "2c5a0274-30c0-4efa-b13c-7ce1e0768cf9",
  tenantId: "e44d0310-65ed-4096-a024-dac77110765a",

  // SharePoint + Excel
  spHost: "internetunion.sharepoint.com",
  spSitePath: "PHTheNetwork", // bez "/sites/"
  filePath: "/General/Kopia pliku Lista - SIDUSIS - PEÅNA - od 08-2025 - kopia do mapy.xlsx",

  // Arkusze w skoroszycie
  dataSheet: "Dane",
  logSheet: "AuditLog",
};


  /* =========================== USTAWIENIA UI/MAPY =========================== */
  const PH_LIST = ["Adrian Daniel","Robert KaÅºmierczak","Mariusz Kielczyk","Inga KaÅºmierczak","Jacek Trybuchowski","Tomasz JÃ³zefowicz"];
  const STATUS_LIST = ["Zapytanie o wycenÄ™","Oferta wysÅ‚ana","Odmowa klienta","Akceptacja klienta","Poza ZasiÄ™giem","KPO"];
  const PH_COLORS = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
  const PH_COLOR_MAP = Object.fromEntries(PH_LIST.map((ph,i)=>[ph,PH_COLORS[i%PH_COLORS.length]]));
  const STATUS_COLOR_MAP = {"Zapytanie o wycenÄ™":"#607D8B","Oferta wysÅ‚ana":"#2196F3","Odmowa klienta":"#F44336","Akceptacja klienta":"#4CAF50","Poza ZasiÄ™giem":"#000000","KPO":"#FF9800"};
  const DEFAULT_PH_COLOR="#455A64", DEFAULT_STATUS_COLOR="#9E9E9E";

  /* =========================== STAN / UTYLITY =========================== */
  let account=null, siteId=null, fileId=null;
  let rows=[]; // dane z Excela
  let map, layer, renderer;

  const $ = s=>document.querySelector(s);
  const statusbar=$("#statusbar");
  const who=$("#who");
  const errorBar=$("#errorBar");

  const esc = s => String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  function setStatus(lines){ statusbar.textContent = Array.isArray(lines) ? lines.join("\n") : String(lines||""); }
  function showError(msg){ errorBar.textContent = msg; errorBar.style.display='block'; setTimeout(()=>{ errorBar.style.display='none'; }, 7000); }
  function toNum(v){ if(v==null) return NaN; const s=String(v).replace(",", ".").replace(/[^\d\.\-+Ee]/g,"").trim(); return parseFloat(s); }
  // --- dopasowanie adresÃ³w i tolerancja wspÃ³Å‚rzÄ™dnych ---
function normAddr(s){
  return String(s||"")
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')   // bez ogonkÃ³w
    .toLowerCase()
    .replace(/\bul\.?\s*/g,'')                        // usuÅ„ "ul." / "ul "
    .replace(/[.,]/g,' ')                             // przecinki/kropki -> spacja
    .replace(/\s+/g,' ')                              // wielokrotne spacje
    .trim();
}
const near = (a,b,tol=1e-5) => isFinite(a)&&isFinite(b)&&Math.abs(a-b)<=tol;

  function colLetter(n){ let s="",x=n; while(x>0){x--; s=String.fromCharCode(65+(x%26))+s; x=Math.floor(x/26);} return s; }
  function findIdx(headers, name){ const lc=headers.map(v=>String(v||"").trim().toLowerCase()); return lc.indexOf(String(name).toLowerCase()); }

  /* =========================== MAPA =========================== */
  function initMap(){
    if(map) map.remove();
    map=L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
    map.createPane('points'); map.getPane('points').style.zIndex = 650;
    renderer = L.canvas({ padding:0.5 });
    layer=L.layerGroup([], {pane:'points'}).addTo(map);
  }
  function fitToData(){
    const pts=rows.filter(r=>isFinite(r.lat)&&isFinite(r.lon));
    if(!pts.length){ map.setView([52,19],6); return; }
    const fg=L.featureGroup(pts.map(p=>L.circleMarker([p.lat,p.lon])));
    map.fitBounds(fg.getBounds().pad(0.2));
  }
  function renderLegend(){
    const box=$("#legend"); let html="";
    html+=`<div class="title">PH (kolor wypeÅ‚nienia)</div>`;
    for(const ph of PH_LIST){ const col=PH_COLOR_MAP[ph]||DEFAULT_PH_COLOR; html+=`<div><span class="pill" style="background:${col}"></span>${esc(ph)}</div>`; }
    html+=`<div style="margin:6px 0;border-top:1px solid #ddd"></div>`;
    html+=`<div class="title">Status (kolor obrysu)</div>`;
    for(const [st,col] of Object.entries(STATUS_COLOR_MAP)){ html+=`<div><span class="pill status-pill" style="background:${col};border-color:${col}"></span>${esc(st)}</div>`; }
    box.innerHTML=html;
  }
  function buildPopup(rec){
    const phOpts = ['<option value="">(brak)</option>'].concat(PH_LIST.map(ph=>`<option ${ph===rec.PH?'selected':''}>${esc(ph)}</option>`)).join("");
    const stOpts = ['<option value="">(brak)</option>'].concat(STATUS_LIST.map(st=>`<option ${st===rec.Status?'selected':''}>${esc(st)}</option>`)).join("");

    const actions=`
      <div class="actions" style="margin-top:8px">
        <a href="#" data-mail="INV">ğŸ“© WyÅ›lij proÅ›bÄ™ o wycenÄ™ (Inwestycje)</a>
        <a href="#" data-mail="CLI">âœ‰ï¸ WyÅ›lij wiadomoÅ›Ä‡ do klienta</a>
        <a href="#" data-mail="STD">ğŸ“„ WyÅ›lij standardowÄ… ofertÄ™</a>
        <a href="#" data-mail="DEV">ğŸ—ï¸ WyÅ›lij ofertÄ™ deweloperskÄ…</a>
        <a href="tel:${encodeURIComponent(rec.telefon||'')}">ğŸ“ ZadzwoÅ„ do klienta</a>
      </div>`;

    return `<div class="popup">
      <h4>${esc(rec.nazwa||'')}</h4>
      ${esc(rec.adres_pelny||'')}<br/>
      <div class="meta"><b>Email:</b> ${esc(rec.email||'')} &nbsp; <b>Telefon:</b> ${esc(rec.telefon||'')}</div>

      <div class="row">
        <label>PH:</label>
        <select id="phSel">${phOpts}</select>
        <label>Status:</label>
        <select id="stSel">${stOpts}</select>
        <button id="savePHST">Zapisz</button>
      </div>

      <div class="meta"><b>Aktualnie:</b> PH = <b>${esc(rec.PH||'-')}</b>, Status = <b>${esc(rec.Status||'-')}</b></div>
      ${actions}
    </div>`;
  }
  function addOnePoint(rec){
    const marker = L.circleMarker([rec.lat,rec.lon],{
      renderer, pane:'points',
      radius:9, color: STATUS_COLOR_MAP[(rec.Status||"").trim()] || DEFAULT_STATUS_COLOR,
      weight:3, fill:true, fillColor: PH_COLOR_MAP[(rec.PH||"").trim()] || DEFAULT_PH_COLOR, fillOpacity:1
    });

    marker.bindPopup(buildPopup(rec));
    marker.on('popupopen', e=>{
      const el=e.popup.getElement()?.querySelector('.leaflet-popup-content');
      if(!el) return;

      el.querySelector('#savePHST')?.addEventListener('click', async ()=>{
        const ph = el.querySelector('#phSel')?.value || "";
        const st = el.querySelector('#stSel')?.value || "";
        try{
          setStatus("Zapis do Excelaâ€¦");
          await savePhStatus(rec, ph, st);
          rec.PH = ph; rec.Status = st;
          marker.setStyle({
            fillColor: PH_COLOR_MAP[(rec.PH||"").trim()] || DEFAULT_PH_COLOR,
            color: STATUS_COLOR_MAP[(rec.Status||"").trim()] || DEFAULT_STATUS_COLOR
          });
          marker.setPopupContent(buildPopup(rec));
          marker.openPopup();
          setStatus("Zapisano.");
        }catch(err){
          console.error(err);
          showError("BÅ‚Ä…d zapisu: " + err.message);
          setStatus("BÅ‚Ä…d zapisu.");
        }
      });

      el.querySelectorAll('a[data-mail]').forEach(a=>{
        a.addEventListener('click', ev=>{
          ev.preventDefault();
          const kind=a.getAttribute('data-mail');
          const t=mailTemplates(rec)[kind];
          composeAndSend(t.to, t.subject, t.body);
        });
      });
    });

    layer.addLayer(marker);
  }
  function rebuild(){
    initMap(); renderLegend();
    let placed=0;
    rows.forEach(rec=>{
      if(!isFinite(rec.lat)||!isFinite(rec.lon)) return;
      try{ addOnePoint(rec); placed++; }catch(err){ console.error("Render error for",rec,err); }
    });
    fitToData();
    const sample = rows.slice(0,2).map(r=>`(${r.lat.toFixed(5)}, ${r.lon.toFixed(5)})`).join(" ; ");
    const txt=statusbar.textContent + `\nUmieszczono na mapie: ${placed}\nPrzykÅ‚adowe wspÃ³Å‚rzÄ™dne: ${sample||"â€”"}`;
    setStatus(txt);
  }

// ==================== MAIL â€“ formatowanie + szablony ====================
function mailTemplates(rec){
  const nazwa  = rec.nazwa || "";
  const miasto = (rec.miejscowosc || "").trim();
  let   adres  = (rec.adres_pelny || "").trim();

  // 1) Normalizacja "ul." i biaÅ‚ych znakÃ³w
  adres = adres.replace(/\s+/g, " ");
  // jeÅ›li adres zaczyna siÄ™ od "ul. ul." lub "UL ul" -> zrÃ³b jednÄ… "ul. "
  adres = adres.replace(/^\s*(ul\.?\s*){2,}/i, "ul. ");
  // ujednoliÄ‡ poczÄ…tek: "ul" / "UL" -> "ul. "
  adres = adres.replace(/^\s*ul\b\.?/i, "ul. ");

  // 2) JeÅ›li miasto juÅ¼ jest na koÅ„cu adresu, nie dopisuj go drugi raz
  const reEsc = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  const cityAtEnd = miasto
    ? new RegExp(`(?:,\\s*)?\\b${reEsc(miasto)}\\b$`, "i")
    : null;

  // wersja do tematu/wiersza "Adres:" bez powtÃ³rzonego miasta
  const adresBezMiasta = miasto && cityAtEnd.test(adres)
    ? adres.replace(cityAtEnd, "").replace(/,\s*$/,"").trim()
    : adres;

  // Do tematu: adres + ewentualnie ", miasto" gdy brakuje go w adresie
  const cityPartForSubject = miasto && !cityAtEnd?.test(adres) ? `, ${miasto}` : "";

  // Tematy
  const subj_inv = `Zapytanie o wycenÄ™ - ${adresBezMiasta}${cityPartForSubject} - SIDUSIS`;
  const subj_cli = `Internet Å›wiatÅ‚owodowy - The Network - ${adresBezMiasta}${cityPartForSubject}`;
  const subj_std = subj_cli;
  const subj_dev = subj_cli;

  // TreÅ›ci
  const tel   = rec.telefon || "";
  const email = rec.email || "";

  const body_inv =
`ProszÄ™ o wycenÄ™ podÅ‚Ä…czenia klienta:
Nazwa: ${nazwa}
Miasto: ${miasto}
Adres: ${adresBezMiasta}
Telefon: ${tel}
E-mail: ${email}
`;

  const body_cli =
`DzieÅ„ dobry ${nazwa},

Serdecznie dziÄ™kujemy za przesÅ‚anie zgÅ‚oszenia za poÅ›rednictwem platformy SIDUSIS.

Informujemy, Å¼e zapytanie dotyczÄ…ce moÅ¼liwoÅ›ci podÅ‚Ä…czenia Internetu w lokalizacji ${adresBezMiasta}${cityPartForSubject} zostaÅ‚o przekazane do DziaÅ‚u Inwestycji celem przygotowania indywidualnej wyceny.

OdpowiedÅº przeÅ›lÄ™ nie pÃ³Åºniej niÅ¼ w ciÄ…gu 3 dni roboczych.

W przypadku jakichkolwiek pytaÅ„ â€“ pozostajÄ™ do dyspozycji.

Z wyrazami szacunku,
`;

  const body_std =
`DzieÅ„ dobry,

W odpowiedzi na przesÅ‚ane zapytanie poniÅ¼ej przesyÅ‚am ofertÄ™ na podÅ‚Ä…czenie Prywatnego ÅšwiatÅ‚owodu The Network:

Jednorazowy koszt instalacji wynosi 2500 zÅ‚ (moÅ¼liwoÅ›Ä‡ rozÅ‚oÅ¼enia na 10 rÃ³wnych pÅ‚atnoÅ›ci po 250 zÅ‚)
- PÅ‚atnoÅ›Ä‡ po uruchomieniu usÅ‚ugi - Brak zaliczki / przedpÅ‚aty.

Abonament miesiÄ™czny zaleÅ¼ny jest od prÄ™dkoÅ›ci Å‚Ä…cza:
300/300Mbs - 125 zÅ‚
1000/1000Mbs - 150 zÅ‚
TV 82 - 10 zÅ‚ (Telewizja po Å‚Ä…czu internetowym)
TV 177 â€“ 69 zÅ‚ (Telewizja po Å‚Ä…czu internetowym)
lista kanaÅ‚Ã³w: https://thenetwork.pl/telewizja/

- ÅšwiatÅ‚owÃ³d wprowadzany jest do pierwszego moÅ¼liwego punktu w domu,
- W miejscu, do ktÃ³rego zostanie doprowadzony Å›wiatÅ‚owÃ³d niezbÄ™dne jest zasilanie dla urzÄ…dzenia optycznego ONU.
- Infrastruktura wewnÄ™trzna / w tym urzÄ…dzenie Wi-Fi / pozostaje w gestii wÅ‚aÅ›ciciela posesji.
Umowa zawierana jest na 24 miesiÄ…ce.

W przypadku akceptacji warunkÃ³w proszÄ™ o uzupeÅ‚nienie poniÅ¼szych danych celem przygotowania umowy.

Nazwisko i ImiÄ™: ..............................
Adres: ...........................
PESEL: .................
E-mail: ......................
Tel.: ........................
Pakiet TV: ...................
PrÄ™dkoÅ›Ä‡: ...................

Jakie sÄ… nastÄ™pne kroki?

Po otrzymaniu danych przygotujemy umowÄ™ on-line, ktÃ³ra zostanie wysÅ‚ana w oddzielnej wiadomoÅ›ci.
NastÄ™pnie po zaakceptowaniu umowy ZostanÄ… PaÅ„stwo wpisani na listÄ™ do realizacji dla wykonawcy. 
Po wykonaniu przyÅ‚Ä…cza domowego oraz poÅ‚Ä…czeniu go z gÅ‚Ã³wnÄ… magistralÄ… Biuro ObsÅ‚ugi Klienta kontaktuje siÄ™ z PaÅ„stwem celem ustalenia dogodnego terminu uruchomienia usÅ‚ugi.

Ostatni etap to wizyta technika, podczas ktÃ³rej zostaje uruchomiona usÅ‚uga. 
Po tej wizycie w Panelu Klienta pojawi siÄ™ pierwsza faktura.

W przypadku dodatkowych pytaÅ„ bÄ…dÅº wÄ…tpliwoÅ›ci proszÄ™ o kontakt.
`;

  const body_dev =
`DzieÅ„ dobry,

W odpowiedzi na przesÅ‚ane zapytanie poniÅ¼ej przesyÅ‚am ofertÄ™ na podÅ‚Ä…czenie Prywatnego ÅšwiatÅ‚owodu The Network:

Jednorazowy koszt instalacji wynosi 1 zÅ‚

Abonament miesiÄ™czny zaleÅ¼ny jest od prÄ™dkoÅ›ci Å‚Ä…cza:
300/300Mbs - 89 zÅ‚
1000/1000Mbs - 114 zÅ‚
TV 82 - 10 zÅ‚ (Telewizja po Å‚Ä…czu internetowym)
TV 177 â€“ 69 zÅ‚ (Telewizja po Å‚Ä…czu internetowym)
lista kanaÅ‚Ã³w: https://thenetwork.pl/telewizja/

- ÅšwiatÅ‚owÃ³d wprowadzany jest do pierwszego moÅ¼liwego punktu w domu,
- W miejscu, do ktÃ³rego zostanie doprowadzony Å›wiatÅ‚owÃ³d niezbÄ™dne jest zasilanie dla urzÄ…dzenia optycznego ONU.
- Infrastruktura wewnÄ™trzna / w tym urzÄ…dzenie Wi-Fi / pozostaje w gestii wÅ‚aÅ›ciciela posesji.
Umowa zawierana jest na 24 miesiÄ…ce.

W przypadku akceptacji warunkÃ³w proszÄ™ o uzupeÅ‚nienie poniÅ¼szych danych celem przygotowania umowy.

Nazwisko i ImiÄ™: ..............................
Adres: ...........................
PESEL: .................
E-mail: ......................
Tel.: ........................
Pakiet TV: ...................
PrÄ™dkoÅ›Ä‡: ...................

Jakie sÄ… nastÄ™pne kroki?

Biuro ObsÅ‚ugi Klienta przygotowuje umowÄ™ on-line, ktÃ³ra zostanie wysÅ‚ana w oddzielnej wiadomoÅ›ci.
NastÄ™pnie po zaakceptowaniu umowy Biuro ObsÅ‚ugi Klienta kontaktuje siÄ™ z PaÅ„stwem celem ustalenia dogodnego terminu uruchomienia usÅ‚ugi.

Ostatni etap to wizyta technika, podczas ktÃ³rej zostaje uruchomiona usÅ‚uga. 
Po tej wizycie w Panelu Klienta pojawi siÄ™ pierwsza faktura.

W przypadku dodatkowych pytaÅ„ bÄ…dÅº wÄ…tpliwoÅ›ci proszÄ™ o kontakt.
`;

  return {
    INV: { to: "inwestycje@internetunion.pl", subject: subj_inv, body: body_inv },
    CLI: { to: rec.email || "", subject: subj_cli, body: body_cli },
    STD: { to: rec.email || "", subject: subj_std, body: body_std },
    DEV: { to: rec.email || "", subject: subj_dev, body: body_dev }
  };
}

  function composeAndSend(to, subject, body){
    const base = "mailto:"+encodeURIComponent(to||"")+"?subject="+encodeURIComponent(subject||"");
    const full = base + "&body=" + encodeURIComponent(body||"");
    if(full.length <= 1500){
      window.location.href = full;
    } else if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(body||"").then(()=>{ window.location.href = base; alert("TreÅ›Ä‡ zbyt dÅ‚uga â€“ skopiowano do schowka. Wklej w oknie poczty (Ctrl+V)."); });
    } else {
      window.location.href = base;
      alert("TreÅ›Ä‡ zbyt dÅ‚uga â€“ wklej rÄ™cznie.");
    }
  }

  /* =========================== ZAÅADUJ MSAL (z fallbackiem) =========================== */
  try {
    await loadScriptSequential(MSAL_CDNS);
  } catch (e) {
    alert('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ msal-browser (alcdn/jsDelivr/unpkg). Skontaktuj siÄ™ z DT, aby odblokowaÄ‡ co najmniej jedno z tych CDN.');
    console.error(e);
    return;
  }
  if (typeof msal === 'undefined' || !msal.PublicClientApplication) {
    alert('MSAL nie jest dostÄ™pny w przeglÄ…darce.');
    return;
  }

  /* =========================== MSAL / GRAPH =========================== */
  const msalApp = new msal.PublicClientApplication({
    auth: {
      clientId: CONFIG.clientId,
      authority: "https://login.microsoftonline.com/" + CONFIG.tenantId,
      // Uwaga: to *musi* dokÅ‚adnie odpowiadaÄ‡ wpisowi w Entra ID (Redirect URIs dla SPA)
      redirectUri: window.location.origin + window.location.pathname
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
  });
  const graphScopes = ["openid","profile","offline_access","Files.ReadWrite.All","Sites.Read.All"];

  async function ensureLogin(){
    const accs = msalApp.getAllAccounts();
    if(accs.length){ account=accs[0]; who.textContent = "Zalogowano: " + (account.username||account.homeAccountId); return; }
    const r = await msalApp.loginPopup({ scopes: graphScopes });
    account = r.account; who.textContent = "Zalogowano: " + (account.username||account.homeAccountId);
  }
  async function getToken(){
    await ensureLogin();
    try{
      const r=await msalApp.acquireTokenSilent({ scopes: graphScopes, account });
      return r.accessToken;
    }catch{
      const r=await msalApp.acquireTokenPopup({ scopes: graphScopes });
      return r.accessToken;
    }
  }
  async function gfetch(method, url, body){
    const token = await getToken();
    const resp = await fetch(url, {
      method,
      headers: {
        "Authorization":"Bearer " + token,
        "Accept":"application/json",
        "Content-Type":"application/json"
      },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!resp.ok){
      const txt=await resp.text().catch(()=>String(resp.status));
      throw new Error(`${method} ${url} -> ${resp.status} ${txt}`);
    }
    return resp.status===204 ? null : resp.json();
  }
  async function getSiteId(){
    if(siteId) return siteId;
    const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG.spHost}:/sites/${CONFIG.spSitePath}`;
    const js = await gfetch("GET", url);
    siteId = js.id; return siteId;
  }
  async function getFileItemId(){
    if(fileId) return fileId;
    const sid = await getSiteId();
    const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/root:${encodeURI(CONFIG.filePath)}`;
    const js = await gfetch("GET", url);
    fileId = js.id; return fileId;
  }
async function usedRange(wsName){
  const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
  const wsq = wsName.replace(/'/g,"''");
  const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/usedRange(valuesOnly=true)`;
  return gfetch("GET", url);
}

async function patchRange(wsName, a1, values2d){
  const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
  const wsq = wsName.replace(/'/g,"''");
  const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${a1}')`;
  return gfetch("PATCH", url, { values: values2d });
}
  async function writeCell(wsName, row1, col1, value){
    const a1 = colLetter(col1) + row1;
    return patchRange(wsName, a1, [[ value ]]);
  }
  async function appendLog(row){
    const used = await usedRange(CONFIG.logSheet);
    const rowsV = used.values || [];
    const next = rowsV.length + 1;
    const cols = Math.max(row.length, (rowsV[0]||[]).length || row.length);
    const a1 = `A${next}:${colLetter(cols)}${next}`;
    return patchRange(CONFIG.logSheet, a1, [row]);
  }

  function pickHeader(headers, tokens){
    const lc=headers.map(h=>String(h||"").toLowerCase());
    for(const t of tokens){
      const i = lc.findIndex(n=>n.includes(t));
      if(i>=0) return headers[i];
    }
    return null;
  }
  function parseRows(values){
    if(!values || !values.length) return [];
    const headers = (values[0]||[]).map(h=>String(h||"").trim());
    const body = values.slice(1);

    const H = {
      lat:  pickHeader(headers,["lat","latitude","szerokoÅ›Ä‡","szerokosc"]),
      lon:  pickHeader(headers,["lon","longitude","dÅ‚ugoÅ›Ä‡","dlugosc"]),
      tel:  pickHeader(headers,["telefon","tel"]),
      mail: pickHeader(headers,["email","e-mail","mail"]),
      ph:   pickHeader(headers,["ph"]),
      st:   pickHeader(headers,["status"]),
      ulica:pickHeader(headers,["ulica","adres"]),
      nr:   pickHeader(headers,["nr budynku","numer","nr","nr domu"]),
      msc:  pickHeader(headers,["miejscowoÅ›Ä‡","miejscowosc","miasto"]),
      nazwa:pickHeader(headers,["zgÅ‚aszajÄ…cy","zglaszajacy","nazwa","imiÄ™","imie","nazwisko","klient","firma"]),
      adresPelny: pickHeader(headers,["adres_pelny","adres peÅ‚ny","adres pelny"]),
    };
    const get = (r, col) => { const idx=headers.indexOf(col); return idx>=0 ? r[idx] : ""; };

    let out = body.map(r=>{
      let lat = toNum(get(r,H.lat));
      let lon = toNum(get(r,H.lon));
      let adr = get(r,H.adresPelny) || "";
      if(!adr){
        const u=String(get(r,H.ulica)||"").trim();
        const n=String(get(r,H.nr)||"").trim();
        const m=String(get(r,H.msc)||"").trim();
        adr = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
      }
      return {
        lat, lon, adres_pelny: adr||"",
        PH: String(get(r,H.ph)||""),
        Status: String(get(r,H.st)||""),
        telefon: String(get(r,H.tel)||""),
        email: String(get(r,H.mail)||""),
        nazwa: String(get(r,H.nazwa)||""),
        miejscowosc: String(get(r,H.msc)||""),
      };
    });

    const validLat=v=>isFinite(v)&&v>=-90&&v<=90;
    const validLon=v=>isFinite(v)&&v>=-180&&v<=180;
    const okNormal = out.filter(o=>validLat(o.lat)&&validLon(o.lon)).length;
    const okSwapped= out.filter(o=>validLat(o.lon)&&validLon(o.lat)).length;
    if(okSwapped>okNormal){ out = out.map(o=>({ ...o, lat:o.lon, lon:o.lat })); }
    out = out.filter(o=>validLat(o.lat)&&validLon(o.lon));
    return out;
  }
  async function loadDataFromExcel(){
    setStatus("Åadowanie danych z Excela (Graph)â€¦");
    const used = await usedRange(CONFIG.dataSheet);
    const values = used.values || [];
    if(!values.length){ setStatus("Arkusz pusty."); rows=[]; return; }
    rows = parseRows(values);
    setStatus(`ZaÅ‚adowano ${rows.length} wierszy z arkusza â€${CONFIG.dataSheet}â€.`);
  }
  async function savePhStatus(rec, newPH, newStatus){
  // 1) Pobierz zakres arkusza
  const used = await usedRange(CONFIG.dataSheet);
  const vals = used.values || [];
  if(!vals.length) throw new Error("Arkusz pusty.");
  const headers = (vals[0]||[]).map(h=>String(h||"").trim());
  const body = vals.slice(1);

  // 2) Ustal kolumny (adres/ulica/nr/miasto/lat/lon + PH/Status)
  function pickHeader(headers, tokens){
    const lc=headers.map(h=>String(h||"").toLowerCase());
    for(const t of tokens){
      const i=lc.findIndex(n=>n.includes(t));
      if(i>=0) return headers[i];
    }
    return null;
  }
  const H = {
    adresPelny: pickHeader(headers,["adres_pelny","adres peÅ‚ny","adres pelny"]),
    ulica:      pickHeader(headers,["ulica","adres"]),
    nr:         pickHeader(headers,["nr budynku","numer","nr","nr domu"]),
    msc:        pickHeader(headers,["miejscowoÅ›Ä‡","miejscowosc","miasto"]),
    lat:        pickHeader(headers,["lat","latitude","szerokoÅ›Ä‡","szerokosc","punkt (y)","y"]),
    lon:        pickHeader(headers,["lon","longitude","dÅ‚ugoÅ›Ä‡","dlugosc","punkt (x)","x"]),
    ph:         pickHeader(headers,["ph"]),
    st:         pickHeader(headers,["status"])
  };

  // 3) Upewnij siÄ™, Å¼e sÄ… kolumny PH/Status (dodaj gÅ‚Ã³wki jeÅ›li brak)
  let idxPH = headers.findIndex(h=>String(h).toLowerCase().trim()==="ph");
  if(idxPH<0){ idxPH = headers.length; headers.push("PH");
    await patchRange(CONFIG.dataSheet, `A1:${colLetter(headers.length)}1`, [headers]);
  }
  let idxST = headers.findIndex(h=>String(h).toLowerCase().trim()==="status");
  if(idxST<0){ idxST = headers.length; headers.push("Status");
    await patchRange(CONFIG.dataSheet, `A1:${colLetter(headers.length)}1`, [headers]);
  }

  // 4) ZnajdÅº wiersz (najpierw po znormalizowanym adresie, potem fallback po lat/lon)
  const wantAddr = normAddr(rec.adres_pelny||"");
  let row1=-1, oldPH="", oldST="";

  for(let r=0; r<body.length; r++){
    const row = body[r]||[];

    // a) adres w wierszu
    let adrRow = "";
    if(H.adresPelny){
      const i = headers.indexOf(H.adresPelny);
      adrRow = String(row[i]||"");
    }else{
      const u = H.ulica ? String(row[headers.indexOf(H.ulica)]||"").trim() : "";
      const n = H.nr    ? String(row[headers.indexOf(H.nr)]||"").trim()    : "";
      const m = H.msc   ? String(row[headers.indexOf(H.msc)]||"").trim()   : "";
      adrRow = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
    }

    if(wantAddr && normAddr(adrRow) === wantAddr){
      row1 = r+2;  // +1 nagÅ‚Ã³wek, +1 1-based
    } else if(H.lat && H.lon && isFinite(rec.lat) && isFinite(rec.lon)){
      const iLat = headers.indexOf(H.lat);
      const iLon = headers.indexOf(H.lon);
      const latR = toNum(row[iLat]); const lonR = toNum(row[iLon]);
      if(near(latR, rec.lat) && near(lonR, rec.lon)){
        row1 = r+2;
      }
    }

    if(row1>0){
      oldPH = idxPH>=0 ? String(row[idxPH]||"") : "";
      oldST = idxST>=0 ? String(row[idxST]||"") : "";
      break;
    }
  }

  if(row1<0){
    throw new Error("Nie znaleziono pozycji w Excelu (dopasowanie po adresie i/lub wspÃ³Å‚rzÄ™dnych).");
  }

  // 5) Zapis i log
  await writeCell(CONFIG.dataSheet, row1, idxPH+1, newPH||"");
  await writeCell(CONFIG.dataSheet, row1, idxST+1, newStatus||"");

  const now = new Date().toISOString();
  const upn = (account && (account.username||account.homeAccountId)) || "";
  await appendLog([ now, upn, "UpdatePHStatus", "", rec.adres_pelny||"", `${oldPH}|${oldST}`, `${newPH}|${newStatus}`, "" ]);
}


  /* =========================== UI: przyciski =========================== */
  $("#btnLogin").addEventListener('click', async ()=>{
    try{ await ensureLogin(); setStatus("Zalogowano."); }catch(err){ showError("Logowanie nieudane: " + err.message); }
  });
  $("#btnLogout").addEventListener('click', async ()=>{
    try{
      const acc = msalApp.getAllAccounts()[0];
      if(acc){ await msalApp.logoutPopup({ account: acc }); }
      account=null; who.textContent=""; setStatus("Wylogowano.");
    }catch(err){ showError("Wylogowanie nieudane: " + err.message); }
  });
  $("#btnReload").addEventListener('click', async ()=>{
    try{
      await ensureLogin();
      await getSiteId();
      await getFileItemId();
      await loadDataFromExcel();
      rebuild();
    }catch(err){ console.error(err); showError(err.message); }
  });

  /* =========================== START =========================== */
  initMap(); renderLegend(); setStatus("Kliknij â€Zalogujâ€, a potem â€OdÅ›wieÅ¼ dane z Excelemâ€.");
  msalApp.handleRedirectPromise().catch(e=>console.warn('MSAL redirect:', e));
})();
</script>
</body>
</html>
