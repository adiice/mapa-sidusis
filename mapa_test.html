<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Mapa LeadÃ³w - The Network</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
  html, body { height:100%; margin:0; font-family:system-ui, Segoe UI, Roboto, Arial; }
  #map { height:100%; }
  .toolbar {
    position: fixed; top: 12px; right: 12px; z-index: 10000;
    background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px 12px; box-shadow:0 4px 20px rgba(0,0,0,.08);
    max-width: 680px;
  }
  .toolbar .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toolbar button { font:13px/1.2 inherit; padding:8px 10px; border-radius:10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
  .toolbar .hint, .toolbar .small { font-size:12px; color:#666; }
  .statusbar { margin-top:8px; padding:8px; background:#f9fafb; border:1px dashed #cbd5e1; border-radius:10px; font-size:12px; white-space:pre-wrap; }

  .legend {
    position: fixed; left: 12px; bottom: 16px; z-index: 10000;
    background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px 12px; box-shadow:0 4px 20px rgba(0,0,0,.08);
    font-size:12px; line-height:1.35;
  }
  .legend .title { font-weight:700; margin:4px 0; }
  .pill { display:inline-block; width:10px; height:10px; vertical-align:middle; margin-right:6px; border:1px solid #999; }
  .status-pill { border-radius:50%; }

  .popup h4 { margin:0 0 6px; font-size:14px; }
  .popup .row { display:flex; gap:6px; align-items:center; margin:8px 0; flex-wrap:wrap; }
  .popup select { border:1px solid #ccc; border-radius:8px; padding:6px 8px; font-size:13px; }
  .popup button { border:1px solid #bbb; border-radius:8px; padding:6px 10px; background:#f6f6f6; cursor:pointer; font-size:13px; }
  .popup .meta { font-size:12px; color:#555; margin:6px 0; }
  .popup .actions a { display:block; margin:4px 0; text-decoration:none; }

  .error {
    position: fixed; inset: 0 0 auto 0; top:0; background:#fff3f3; border-bottom:1px solid #e99; color:#900; padding:10px 12px; z-index: 11000;
    font-size:13px; display:none;
  }

  .mini-filter{
    position: fixed; left:12px; top:12px; z-index:10001;
    display:flex; gap:6px; align-items:flex-end; flex-wrap:wrap;
    background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px 12px; box-shadow:0 4px 20px rgba(0,0,0,.08);
    font-size:13px;
  }
  .mini-filter .f{ display:flex; flex-direction:column; }
  .mini-filter input,.mini-filter select{ padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; font:inherit; }
  .mini-filter button{ padding:7px 10px; border:1px solid #cbd5e1; border-radius:8px; background:#eef2ff; cursor:pointer; }
  .mini-filter label{ font-size:12px; color:#64748b; margin-bottom:4px; }

  .dot{ width:18px; height:18px; border-radius:50%; border:3px solid #999; box-sizing:border-box; background:#777; }
  .dot.badge::after{
    content:"!"; position:absolute; top:-6px; right:-6px;
    width:14px; height:14px; font-size:10px; color:#fff; background:#ef4444;
    border-radius:50%; display:flex; align-items:center; justify-content:center;
    border:1px solid rgba(0,0,0,.2);
  }

  .collapsible { display: inline-block; box-sizing: border-box; }
  .collapsible .toggle{
    position:absolute; top:6px; right:6px; width:24px; height:24px;
    border:1px solid #cbd5e1; border-radius:999px; background:#f8fafc; cursor:pointer;
    line-height:22px; font-size:14px; display:flex; align-items:center; justify-content:center;
  }
  .collapsible.is-collapsed{ display:inline-block !important; padding:6px; min-width:28px; min-height:28px; width:auto; height:auto; }
  .collapsible.is-collapsed .toggle{ position: static; }
  .collapsible.is-collapsed > :not(.toggle){ display:none !important; }

  .credit{
    position:fixed; right:10px; bottom:8px; z-index:9999;
    background:#ffffffd9; backdrop-filter: blur(4px);
    border:1px solid #e5e7eb; border-radius:999px;
    padding:6px 10px; font-size:12px; color:#374151;
  }

  .missingBox{
    position: fixed; left: 12px; bottom: 12px; z-index: 10002;
    background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.08);
    min-width: 260px; max-width: 420px;
  }
  .missingBox .hd{ padding:10px 12px; font-weight:600; border-bottom:1px solid #eee; }
  .missingBox .bd{ padding:8px 12px; max-height:220px; overflow:auto; font-size:12px; }
  .missingBox .toggle{ position:absolute; top:6px; right:6px; width:24px; height:24px; border:1px solid #cbd5e1; border-radius:999px; background:#f8fafc; cursor:pointer; }
  .missingBox.collapsed .bd{ display:none; }
</style>

<!-- Leaflet + MarkerCluster -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Loader z fallbackiem dla MSAL -->
<script>
  function loadScriptSequential(urls) {
    return new Promise((resolve, reject) => {
      let i = 0;
      const tryNext = () => {
        if (i >= urls.length) return reject(new Error('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ msal-browser z Å¼adnego CDN.'));
        const s = document.createElement('script');
        s.src = urls[i++]; s.async = true;
        s.onload = () => resolve();
        s.onerror = () => tryNext();
        document.head.appendChild(s);
      };
      tryNext();
    });
  }
  const MSAL_CDNS = [
    'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
    'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
  ];
</script>
</head>

<body>
<div id="map"></div>

<!-- Panel narzÄ™dziowy -->
<div class="toolbar collapsible" id="toolbarBox">
  <button class="toggle" id="tgToolbar" title="ZwiÅ„/rozwiÅ„">â¯…</button>
  <div class="row">
    <strong>SIDUSIS â€“ Mapa leadÃ³w (ONLINE)</strong>
    <span class="small" id="who"></span>
  </div>
  <div class="row">
    <button id="btnLogin">Zaloguj</button>
    <button id="btnLogout">Wyloguj</button>
    <button id="btnReload">OdÅ›wieÅ¼ dane z Excelem</button>
  </div>
  <div class="hint">Po zalogowaniu: kliknij pinezkÄ™ â†’ wybierz PH/Status â†’ â€Zapiszâ€ (zapis do Excela na SharePoint) â€¢ PoniÅ¼ej status.</div>
  <div class="statusbar" id="statusbar">Nie zalogowano.</div>
</div>

<!-- Mini-filtry -->
<div class="mini-filter collapsible" id="filtersBox">
  <button class="toggle" id="tgFilters" title="ZwiÅ„/rozwiÅ„">â¯…</button>
  <div class="f">
    <label>PH</label>
    <select id="mfPH"><option value="">(wszyscy)</option></select>
  </div>
  <div class="f">
    <label>Status</label>
    <select id="mfStatus"><option value="">(wszystkie)</option></select>
  </div>
  <div class="f">
    <label>Miasto / ulica (zawiera)</label>
    <input id="mfSearch" placeholder="np. PoznaÅ„ lub PiÅ‚sudskiego" />
  </div>
  <div class="f">
    <label>Zakres od</label>
    <input type="date" id="mfFrom">
  </div>
  <div class="f">
    <label>â€¦do</label>
    <input type="date" id="mfTo">
  </div>
  <div class="f">
    <button id="mfApply">Filtruj</button>
  </div>
</div>

<div class="legend collapsible" id="legend">
  <button class="toggle" id="tgLegend" title="ZwiÅ„/rozwiÅ„">â¯…</button>
  <div class="legend-body"></div>
</div>

<!-- Panel brakÃ³w geolokalizacji (tylko dla adaniel@...) -->
<div class="missingBox collapsed" id="missingBox" style="display:none">
  <button class="toggle" id="tgMissing" title="ZwiÅ„/rozwiÅ„">â¯ˆ</button>
  <div class="hd">Brak geolokalizacji <span id="missingCount">(0)</span></div>
  <div class="bd">
    <ol id="missingList" style="margin:0 0 8px 18px; padding-left:0;"></ol>
  </div>
</div>

<div class="error" id="errorBar"></div>

<script>
(async function main(){
  /* =========================== KONFIG =========================== */
  const CONFIG = {
    clientId: "2c5a0274-30c0-4efa-b13c-7ce1e0768cf9",
    tenantId: "e44d0310-65ed-4096-a024-dac77110765a",
    spHost: "internetunion.sharepoint.com",
    spSitePath: "PHTheNetwork",
    filePath: "/General/Kopia pliku Lista - SIDUSIS - PEÅNA - od 08-2025 - kopia do mapy.xlsx",
    dataSheet: "Dane",
    logSheet: "AuditLog"
  };

  /* =========================== LISTY =========================== */
  const DEFAULT_LISTS = {
    ph: [
      "Adrian Daniel","Robert KaÅºmierczak","Mariusz Kielczyk","Inga KaÅºmierczak","Jacek Trybuchowski","Tomasz JÃ³zefowicz"
    ],
    phAliases: {
      "ad":"Adrian Daniel","rk":"Robert KaÅºmierczak","mk":"Mariusz Kielczyk",
      "ik":"Inga KaÅºmierczak","jt":"Jacek Trybuchowski","tj":"Tomasz JÃ³zefowicz"
    },
    status: ["Wycena Inwestycji","Oferta wysÅ‚ana","Odmowa klienta","Akceptacja klienta","Poza ZasiÄ™giem","KPO","MOICO","Duplikat","SEEV"],
    statusAliases: {
      "zapytanie o wycenÄ™":"Wycena Inwestycji","zapytanie o wycene":"Wycena Inwestycji","wycena inwestycji":"Wycena Inwestycji",
      "oferta wysÅ‚ana":"Oferta wysÅ‚ana","odmowa klienta":"Odmowa klienta","akceptacja klienta":"Akceptacja klienta",
      "poza zasiÄ™giem":"Poza ZasiÄ™giem","kpo":"KPO","duplikat":"Duplikat","moico":"MOICO","seev":"SEEV"
    },
    statusColors: {
      "Wycena Inwestycji":"#607D8B","Oferta wysÅ‚ana":"#2196F3","Odmowa klienta":"#F44336",
      "Akceptacja klienta":"#4CAF50","Poza ZasiÄ™giem":"#000000","KPO":"#FF9800",
      "MOICO":"#8E24AA","Duplikat":"#9E9E9E","SEEV":"#00BCD4"
    },
    excluded: ["KPO","Poza ZasiÄ™giem","MOICO","Duplikat","SEEV"],
    rejectionReasons: [
      "Zbyt droga instalacja","Drogi abonament","Lepsza oferta konkurencji",
      "Brak moÅ¼liwoÅ›ci technicznych","Nieaktualny kontakt","Inne"
    ]
  };

  const normStr = s => String(s||"").toLowerCase().replace(/\s+/g," ").trim();

  let LISTS = DEFAULT_LISTS;
  let PH_LIST = [], STATUS_LIST = [], REJECTION_REASONS = [];
  let STATUS_COLOR_MAP = {};
  let EXCLUDED_STATUSES = new Set();
  let PH_ALIASES = {};
  let PH_COLOR_MAP = {};

  function buildPhColorMap(phList){
    const palette = ['#1abc9c','#3498db','#9b59b6','#e67e22','#e74c3c','#2ecc71','#16a085','#2980b9','#8e44ad','#d35400','#c0392b','#27ae60','#7f8c8d'];
    const map = {}; phList.forEach((ph,i)=>{ map[ph] = palette[i % palette.length]; });
    return map;
  }

  async function loadLists(){
    try{
      const resp = await fetch('assets/lists.json?v=' + Date.now(), {cache:'no-store'});
      if(resp.ok){ LISTS = { ...DEFAULT_LISTS, ...(await resp.json()) }; }
    }catch(e){ console.warn('lists.json â€“ fallback na domyÅ›lne:', e); LISTS = DEFAULT_LISTS; }

    PH_LIST = Array.isArray(LISTS.ph) ? LISTS.ph.slice() : [];
    PH_ALIASES = Object.fromEntries(Object.entries(LISTS.phAliases||{}).map(([k,v])=>[normStr(k), v]));
    STATUS_LIST = Array.isArray(LISTS.status) ? LISTS.status.slice() : [];
    STATUS_COLOR_MAP = { ...DEFAULT_LISTS.statusColors, ...(LISTS.statusColors||{}) };
    REJECTION_REASONS = Array.isArray(LISTS.rejectionReasons) ? LISTS.rejectionReasons.slice() : DEFAULT_LISTS.rejectionReasons.slice();
    EXCLUDED_STATUSES = new Set(Array.isArray(LISTS.excluded) ? LISTS.excluded : DEFAULT_LISTS.excluded);
    const phColors = LISTS.phColors || {};
    PH_COLOR_MAP = { ...buildPhColorMap(PH_LIST), ...phColors };
  }

  function canonStatus(s){
    const k = normStr(s);
    return (LISTS.statusAliases && LISTS.statusAliases[k]) ? LISTS.statusAliases[k] : (s||"");
  }
  function canonPH(s){
    const raw = String(s||"").trim();
    const a = PH_ALIASES[normStr(raw)] || raw;
    return PH_LIST.includes(a) ? a : "";
  }

  /* =========================== STAN/UTIL =========================== */
  let account=null, siteId=null, fileId=null;
  let rows=[]; let frows=[];
  let map, cluster;

  // brak geolokalizacji (lista) + straÅ¼nik uÅ¼ytkownika
  let missingRows = [];
  const isPrivileged = () => (account?.username || "").toLowerCase() === "adaniel@internetunion.pl";

  const $ = s=>document.querySelector(s);
  const statusbar=$("#statusbar"); const who=$("#who"); const errorBar=$("#errorBar");

  const esc = s => String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const DEFAULT_STATUS = "Kliknij â€Zalogujâ€, a potem â€OdÅ›wieÅ¼ dane z Excelemâ€.";
  function setStatus(msg, opts={}){ const {append=false,autoClearMs=0}=opts; statusbar.textContent = append ? (statusbar.textContent?(statusbar.textContent+"\n"):"") + (Array.isArray(msg)?msg.join("\n"):String(msg||"")) : (Array.isArray(msg)?msg.join("\n"):String(msg||"")); if(autoClearMs>0){ setTimeout(()=>statusbar.textContent="",autoClearMs);} }
  function showError(msg){
    const raw = String(msg||"");
    const friendly = (/\b429\b/.test(raw)) ? 'Serwer poprosiÅ‚ o przerwÄ™ (429). SprÃ³buj ponownie za chwilÄ™.' : raw;
    console.error(raw);
    errorBar.textContent = friendly;
    errorBar.style.display='block';
    setTimeout(()=>{ errorBar.style.display='none'; }, 8000);
  }
  function toNum(v){ if(v==null) return NaN; const s=String(v).replace(",", ".").replace(/[^\d\.\-+Ee]/g,"").trim(); return parseFloat(s); }
  function colLetter(n){ let s="",x=n; while(x>0){x--; s=String.fromCharCode(65+(x%26))+s; x=Math.floor(x/26);} return s; }
  const normAddr = s => normStr(s).replace(/^\s*(ul\.?\s*){2,}/i,"ul. ").replace(/^\s*ul\b\.?/i,"ul. ");
  const near = (a,b,eps=0.0005)=> isFinite(a)&&isFinite(b)&&Math.abs(a-b)<=eps;

  function toDate(v){
    if(v==null || v==="") return null;
    if(typeof v==="number"){ const d = new Date(Date.UTC(1899,11,30)); d.setUTCDate(d.getUTCDate()+Math.floor(v)); return d; }
    const s=String(v).trim(); const d1 = new Date(s); if(!isNaN(d1)) return d1;
    const m = s.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
    if(m){ const [_,dd,mm,yy]=m; return new Date(Number(yy.length===2?("20"+yy):yy), Number(mm)-1, Number(dd)); }
    return null;
  }

  // === Daty lokalne i formatowanie ===
  function todayLocal(){ const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); }
  function addDays(d, days){ const base = new Date(d.getFullYear(), d.getMonth(), d.getDate()); base.setDate(base.getDate() + (Number(days)||0)); return base; }
  function fmtYMD(d){ if(!d) return ""; const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }

  // === ReguÅ‚y NextContactAt (w tle) ===
  let STATUS_RULES = null; // { [status]: { nextDays:number, nextFrom:'createdAt'|'LastTouchAt'|'today' } }
  async function loadStatusRules(){
    try{
      const resp = await fetch('assets/status_rules.json?v=' + Date.now(), { cache:'no-store' });
      if(resp.ok){ STATUS_RULES = await resp.json(); }
    }catch(e){ console.warn('status_rules.json â€“ fallback na domyÅ›lne:', e); }
  }

  function computeNextContactAt(rec, newStatus){
    const status = String(newStatus || rec?.Status || '').trim();
    const NO_REM = new Set([ 'Odmowa klienta', 'Poza ZasiÄ™giem', 'KPO', 'Akceptacja klienta' ]);
    if(!status) return { nextAt: null, reasonText: 'brak statusu (bez terminu)' };
    if(NO_REM.has(status)) return { nextAt: null, reasonText: `${status} (bez terminu)` };

    const FALLBACK = {
      'Wycena Inwestycji': { nextDays: 3, nextFrom: 'today' },
      'Oferta wysÅ‚ana':    { nextDays: 7, nextFrom: 'today' },
      'Zapytanie o wycenÄ™':{ nextDays: 2, nextFrom: 'today' }
    };
    const rule = (STATUS_RULES && STATUS_RULES[status]) || FALLBACK[status];
    if(!rule){ return { nextAt: null, reasonText: `${status} (bez terminu)` }; }

    let base;
    switch(String(rule.nextFrom||'today')){
      case 'createdAt':   base = rec?.createdAt || todayLocal(); break;
      case 'LastTouchAt': base = rec?.LastTouchAt || todayLocal(); break;
      default:            base = todayLocal();
    }
    const nd = Number(rule.nextDays)||0;
    const nextAt = addDays(base, nd);
    return { nextAt, reasonText: `${status} (+${nd}d)` };
  }

  /* === UI collapsibles === */
  const UI_STATE_KEY = "uiCollapsed_v1";
  const UI_STATE = (()=>{ try{ return JSON.parse(localStorage.getItem(UI_STATE_KEY)) || {toolbar:false, filters:false, legend:false}; } catch{ return {toolbar:false, filters:false, legend:false}; } })();
  function saveUiState(){ localStorage.setItem(UI_STATE_KEY, JSON.stringify(UI_STATE)); }
  function attachToggle(boxId, btnId, key){
    const box = document.getElementById(boxId);
    const btn = document.getElementById(btnId);
    if(!box || !btn) return;
    box.classList.toggle('is-collapsed', !!UI_STATE[key]);
    btn.textContent = UI_STATE[key] ? "â¯ˆ" : "â¯…";
    btn.addEventListener('click', ()=>{
      const now = !box.classList.contains('is-collapsed');
      box.classList.toggle('is-collapsed', now);
      btn.textContent = now ? "â¯ˆ" : "â¯…";
      UI_STATE[key] = now; saveUiState();
    });
  }

  /* =========================== MAPA =========================== */
  function initMap(){
    if(map) map.remove();
    map = L.map('map', { updateWhenZooming:false, updateWhenIdle:true, inertia:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);

    const radiusFn = z => (z<=8?30:z<=10?26:z<=12?22:z<=14?18:14);
    cluster = L.markerClusterGroup({
      maxClusterRadius: radiusFn,
      disableClusteringAtZoom: 17,
      chunkedLoading: true,
      showCoverageOnHover: false,
      spiderfyOnEveryZoom: false
    });
    map.addLayer(cluster);
  }
  function fitToData(arr){
    let minLat=90, maxLat=-90, minLon=180, maxLon=-180, has=false;
    for(const r of arr){
      if(!isFinite(r.lat)||!isFinite(r.lon)) continue;
      has=true;
      if(r.lat<minLat) minLat=r.lat; if(r.lat>maxLat) maxLat=r.lat;
      if(r.lon<minLon) minLon=r.lon; if(r.lon>maxLon) maxLon=r.lon;
    }
    if(!has){ map.setView([52,19],6); return; }
    map.fitBounds([[minLat,minLon],[maxLat,maxLon]], { padding:[20,20] });
  }
  function renderLegend(){
    const body = document.querySelector("#legend .legend-body");
    let html="";
    html+=`<div class="title">PH (kolor wypeÅ‚nienia)</div>`;
    for(const ph of PH_LIST){ const col=PH_COLOR_MAP[ph]||"#455A64"; html+=`<div><span class="pill" style="background:${col}"></span>${esc(ph)}</div>`; }
    html+=`<div style="margin:6px 0;border-top:1px solid #ddd"></div>`;
    html+=`<div class="title">Status (kolor obrysu)</div>`;
    for(const st of STATUS_LIST){ const col = STATUS_COLOR_MAP[st] || "#9E9E9E"; html+=`<div><span class="pill status-pill" style="background:${col};border-color:${col}"></span>${esc(st)}</div>`; }
    body.innerHTML = html;
  }
  const DEFAULT_PH_COLOR="#455A64", DEFAULT_STATUS_COLOR="#9E9E9E";
  function makeIcon(rec){
    const fill = PH_COLOR_MAP[(rec.PH||"").trim()] || DEFAULT_PH_COLOR;
    const stroke = STATUS_COLOR_MAP[(rec.Status||"").trim()] || DEFAULT_STATUS_COLOR;
    const needsBadge = !(rec.PH||"").trim() || !(rec.Status||"").trim();
    const html = `<div class="dot ${needsBadge?'badge':''}" style="background:${fill};border-color:${stroke}"></div>`;
    return L.divIcon({ className:'', html, iconSize:[18,18], iconAnchor:[9,9] });
  }

  function buildPopup(rec){
    const phOpts = ['<option value="">(brak)</option>'].concat(PH_LIST.map(ph=>`<option ${ph===rec.PH?'selected':''}>${esc(ph)}</option>`)).join("");
    const stOpts = ['<option value="">(brak)</option>'].concat(STATUS_LIST.map(st=>`<option ${st===rec.Status?'selected':''}>${esc(st)}</option>`)).join("");
    const reasonOpts = ['<option value="">(wybierz powÃ³d)</option>'].concat(REJECTION_REASONS.map(r=>`<option ${r===(rec.PowodOdmowy||'')?'selected':''}>${esc(r)}</option>`)).join("");

    const actions=`
      <div class="actions" style="margin-top:8px">
        <a href="#" data-quick="me">ğŸ‘¤ Przypisz mnie</a>
        <a href="#" data-mail="INV">ğŸ“© WyÅ›lij proÅ›bÄ™ o wycenÄ™ (Inwestycje)</a>
        <a href="#" data-mail="CLI">âœ‰ï¸ WyÅ›lij wiadomoÅ›Ä‡ do klienta</a>
        <a href="#" data-mail="STD">ğŸ“„ WyÅ›lij standardowÄ… ofertÄ™</a>
        <a href="#" data-mail="DEV">ğŸ—ï¸ WyÅ›lij ofertÄ™ deweloperskÄ…</a>
        <a href="tel:${encodeURIComponent(rec.telefon||'')}">ğŸ“ ZadzwoÅ„ do klienta</a>
      </div>`;

    const showReason = (rec.Status||"").trim()==="Odmowa klienta";
    const reasonInfo = rec.PowodOdmowy ? (', PowÃ³d = <b>' + esc(rec.PowodOdmowy) + '</b>') : '';

    const nextInfo = rec.NextContactAt ? fmtYMD(rec.NextContactAt) : 'â€”';
    return `<div class="popup">
  <h4>${esc(rec.nazwa||'')}</h4>
  ${esc(rec.adres_pelny||'')}<br/>
  <div class="meta"><b>Email:</b> ${esc(rec.email||'')} &nbsp; <b>Telefon:</b> ${esc(rec.telefon||'')}</div>

  <div class="row">
    <label>PH:</label>
    <select id="phSel">${phOpts}</select>
    <label>Status:</label>
    <select id="stSel">${stOpts}</select>
    <button id="savePHST">Zapisz</button>
  </div>

  <div class="row" id="reasonRow" style="display:${showReason ? 'flex' : 'none'}">
    <label>PowÃ³d odmowy:</label>
    <select id="reasonSel" style="min-width:240px">${reasonOpts}</select>
  </div>

  <div class="meta"><b>Aktualnie:</b> PH = <b>${esc(rec.PH||'-')}</b>, Status = <b>${esc(rec.Status||'-')}</b>${reasonInfo}</div>
  <div class="meta"><b>Nast. kontakt:</b> ${nextInfo}</div>
  <div class="row" id="notesRow">
    <label style="align-self:flex-start;">Uwagi PH:</label>
    <textarea id="noteText" rows="3" style="flex:1;min-width:280px">${esc(rec.Uwagi||"")}</textarea>
    <button id="saveNote">Zapisz uwagi</button>
  </div>
  ${rec.Uwagi ? '<div class="meta"><b>Ostatnie uwagi:</b> ' + esc(rec.Uwagi) + '</div>' : ''}
  ${actions}
</div>`;
  }

  function addOneMarker(rec){
    const m = L.marker([rec.lat, rec.lon], { icon: makeIcon(rec) });
    m.bindPopup("", { maxWidth: 420 });

    m.on('popupopen', e=>{
      e.popup.setContent(buildPopup(rec));
      const el = e.popup.getElement()?.querySelector('.leaflet-popup-content');
      if(!el) return;

      const stSel = el.querySelector('#stSel');
      const reasonRow = el.querySelector('#reasonRow');
      stSel?.addEventListener('change', ()=>{
        const st = (stSel.value || '').trim();
        reasonRow.style.display = (st === "Odmowa klienta") ? 'flex' : 'none';
      });

      el.querySelector('#savePHST')?.addEventListener('click', async ()=>{
        const ph = el.querySelector('#phSel')?.value || "";
        const st = el.querySelector('#stSel')?.value || "";
        const reason = (st === "Odmowa klienta") ? (el.querySelector('#reasonSel')?.value || "") : "";
        if(st === "Odmowa klienta" && !reason){ alert("Wybierz PowÃ³d odmowy."); return; }
        try{
          setStatus("Zapis do Excelaâ€¦");
          const res = await savePhStatus(rec, ph, st, reason);
          rec.PH = ph; rec.Status = st; rec.PowodOdmowy = reason;
          rec.LastTouchAt = res?.lastTouchAt || todayLocal();
          rec.NextContactAt = res?.nextContactAt || null;
          m.setIcon(makeIcon(rec));
          m.setPopupContent(buildPopup(rec));
          m.openPopup();
          const hasNext = !!rec.NextContactAt;
          setStatus("Zapisano." + (hasNext ? " (+ NextContactAt)" : ""), { autoClearMs: 2500 });
        }catch(err){ showError("BÅ‚Ä…d zapisu: " + (err.message||err)); setStatus("BÅ‚Ä…d zapisu."); }
      });

      el.querySelectorAll('a[data-quick]').forEach(a=>{
        a.addEventListener('click', ev=>{
          ev.preventDefault();
          if(a.getAttribute('data-quick')==="me"){
            const phSel = el.querySelector('#phSel');
            const me = (account && (account.name||"")) || "";
            if(me && PH_LIST.includes(me)) phSel.value = me;
            else if(PH_LIST.length){ phSel.value = PH_LIST[0]; }
          }
        });
      });

      const noteBtn = el.querySelector('#saveNote');
      if(noteBtn){
        noteBtn.addEventListener('click', async ()=>{
          const text = (el.querySelector('#noteText')?.value || "").trim();
          try{
            setStatus("ZapisujÄ™ uwagiâ€¦");
            await saveUwagi(rec, text);
            rec.Uwagi = text;
            m.setPopupContent(buildPopup(rec));
            m.openPopup();
            setStatus("Zapisano uwagi.", { autoClearMs: 2000 });
          }catch(err){ showError("BÅ‚Ä…d zapisu uwag: " + (err.message||err)); setStatus("BÅ‚Ä…d zapisu."); }
        });
      }

      el.querySelectorAll('a[data-mail]').forEach(a=>{
        a.addEventListener('click', ev=>{
          ev.preventDefault();
          const key = a.getAttribute('data-mail');
          const t = mailTemplates(rec)[key];
          if (!t) { alert("Nie mogÄ™ przygotowaÄ‡ tego maila."); return; }
          if (!t.to) { alert("Brak adresu e-mail odbiorcy."); return; }
          composeAndSend(t.to, t.subject, t.body);
        });
      });
    });

    cluster.addLayer(m);
  }

  function rebuild(){
    cluster.clearLayers();
    let placed=0;
    frows.forEach(rec=>{
      if(!isFinite(rec.lat)||!isFinite(rec.lon)) return;
      try{ addOneMarker(rec); placed++; }catch(err){ console.error("Render error for",rec,err); }
    });
    fitToData(frows);
    const sample = frows.slice(0,2).map(r=>`(${r.lat.toFixed(5)}, ${r.lon.toFixed(5)})`).join(" ; ");
    setStatus([`Widocznych na mapie: ${placed}`, `PrzykÅ‚adowe wspÃ³Å‚rzÄ™dne: ${sample||"â€”"}`]);
  }

  /* ==================== MAIL â€“ szablony ==================== */
  function mailTemplates(rec){
    const nazwa  = rec.nazwa || "";
    const miasto = (rec.miejscowosc || "").trim();
    let   adres  = (rec.adres_pelny || "").trim();
    const tel    = rec.telefon || "";
    const email  = rec.email || "";

    adres = adres.replace(/\s+/g, " ").replace(/^\s*(ul\.?\s*){2,}/i, "ul. ").replace(/^\s*ul\b\.?/i, "ul. ");

    const reEsc = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const reCityAtEnd = miasto ? new RegExp(`(?:,\\s*)?\\b${reEsc(miasto)}\\b$`, "i") : null;
    const hasCityAtEnd = miasto && reCityAtEnd.test(adres);

    const adresBezMiasta = hasCityAtEnd ? adres.replace(reCityAtEnd,"").replace(/,\s*$/,"").trim() : adres;
    const adresZMiastem  = hasCityAtEnd ? adres : (miasto ? `${adres}, ${miasto}` : adres);
    const cityPartForSubject = miasto ? `, ${miasto}` : "";

    const subj_inv = `Zapytanie o wycenÄ™ - ${adresZMiastem} - SIDUSIS`;
    const subj_cli = `Internet Å›wiatÅ‚owodowy - The Network - ${adresZMiastem}`;
    const subj_std = subj_cli;
    const subj_dev = subj_cli;

    const body_inv =
`ProszÄ™ o wycenÄ™ podÅ‚Ä…czenia klienta:
Nazwa: ${nazwa}
Miasto: ${miasto}
Adres: ${adresBezMiasta}
Telefon: ${tel}
E-mail: ${email}
SzerokoÅ›Ä‡ geograficzna: ${isFinite(rec.lat)?rec.lat:""}
DÅ‚ugoÅ›Ä‡ geograficzna: ${isFinite(rec.lon)?rec.lon:""}
`;

    const body_cli =
`DzieÅ„ dobry ${nazwa},

Serdecznie dziÄ™kujemy za przesÅ‚anie zgÅ‚oszenia za poÅ›rednictwem platformy SIDUSIS.
Informujemy, Å¼e zapytanie dotyczÄ…ce moÅ¼liwoÅ›ci podÅ‚Ä…czenia Internetu w lokalizacji ${adresBezMiasta}${cityPartForSubject} zostaÅ‚o przekazane do DziaÅ‚u Inwestycji celem przygotowania indywidualnej wyceny.
OdpowiedÅº przeÅ›lÄ™ nie pÃ³Åºniej niÅ¼ w ciÄ…gu 3 dni roboczych.

W przypadku jakichkolwiek pytaÅ„ â€“ pozostajÄ™ do dyspozycji.
`;

    const body_std =
`DzieÅ„ dobry,

W odpowiedzi na przesÅ‚ane zapytanie poniÅ¼ej przesyÅ‚am ofertÄ™ na podÅ‚Ä…czenie Prywatnego ÅšwiatÅ‚owodu The Network:

Jednorazowy koszt instalacji wynosi 2500 zÅ‚ (moÅ¼liwoÅ›Ä‡ rozÅ‚oÅ¼enia na 10 rÃ³wnych pÅ‚atnoÅ›ci po 250 zÅ‚)- PÅ‚atnoÅ›Ä‡ po uruchomieniu usÅ‚ugi - Brak zaliczki / przedpÅ‚aty.
Abonament miesiÄ™czny zaleÅ¼ny jest od prÄ™dkoÅ›ci Å‚Ä…cza:
300/300Mbs - 125 zÅ‚
1000/1000Mbs - 150 zÅ‚
TV 82 - 10 zÅ‚
TV 177 â€“ 69 zÅ‚
lista kanaÅ‚Ã³w: https://thenetwork.pl/telewizja/

- ÅšwiatÅ‚owÃ³d wprowadzany jest do pierwszego moÅ¼liwego punktu w domu,
- W miejscu, do ktÃ³rego zostanie doprowadzony Å›wiatÅ‚owÃ³d niezbÄ™dne jest zasilanie dla urzÄ…dzenia optycznego ONU.
- Infrastruktura wewnÄ™trzna pozostaje w gestii wÅ‚aÅ›ciciela posesji (sieÄ‡ LAN oraz wifi).
Umowa zawierana jest na 24 miesiÄ…ce.

Celem przygotowania umowy proszÄ™ o przesÅ‚anie poniÅ¼szych danych:

Nazwisko i Imie ..............................
adres...........................
PESEL: .................
mail......................
TEL................................
Pakiet TV: ............................
PrÄ™dkoÅ›Ä‡: ................................

Jakie sÄ… nastÄ™pne kroki?
Po otrzymaniu danych przygotujemy umowÄ™ on-line, ktÃ³ra zostanie wysÅ‚ana w oddzielnej wiadomoÅ›ci.
NastÄ™pnie po zaakceptowaniu umowy ZostanÄ… PaÅ„stwo wpisani na listÄ™ do realizacji dla wykonawcy. Po wykonaniu przyÅ‚Ä…cza domowego oraz poÅ‚Ä…czeniu go z gÅ‚Ã³wnÄ… magistralÄ… Biuro ObsÅ‚ugi Klienta kontaktuje siÄ™ z PaÅ„stwem celem ustalenia dogodnego terminu uruchomienia usÅ‚ugi.
Ostatni etap to wizyta technika, podczas ktÃ³rej zostaje uruchomiona usÅ‚uga. Po tej wizycie w Panelu Klienta pojawi siÄ™ pierwsza faktura.

W przypadku dodatkowych pytaÅ„ bÄ…dÅº wÄ…tpliwoÅ›ci proszÄ™ o kontakt.
`;

    const body_dev =
`DzieÅ„ dobry,

W odpowiedzi na przesÅ‚ane zapytanie poniÅ¼ej przesyÅ‚am ofertÄ™ na podÅ‚Ä…czenie Prywatnego ÅšwiatÅ‚owodu The Network:
Jednorazowy koszt instalacji wynosi 1 zÅ‚
Abonament miesiÄ™czny zaleÅ¼ny jest od prÄ™dkoÅ›ci Å‚Ä…cza:
300/300Mbs - 89 zÅ‚
1000/1000Mbs - 114 zÅ‚
TV 82 - 10 zÅ‚ (Telewizja po Å‚Ä…czu internetowym)
TV 177 â€“ 69 zÅ‚ (Telewizja po Å‚Ä…czu internetowym)
lista kanaÅ‚Ã³w: 
https://thenetwork.pl/telewizja/

- ÅšwiatÅ‚owÃ³d wprowadzany jest do pierwszego moÅ¼liwego punktu w domu,
- W miejscu, do ktÃ³rego zostanie doprowadzony Å›wiatÅ‚owÃ³d niezbÄ™dne jest zasilanie dla urzÄ…dzenia optycznego ONU.
- Infrastruktura wewnÄ™trzna pozostaje w gestii wÅ‚aÅ›ciciela posesji (sieÄ‡ LAN oraz wifi).
Umowa zawierana jest na 24 miesiÄ…ce.

Celem przygotowania umowy proszÄ™ o przesÅ‚anie poniÅ¼szych danych:

Nazwisko i Imie ..............................
adres...........................
PESEL: .................
mail......................
TEL................................
Pakiet TV: ............................
PrÄ™dkoÅ›Ä‡: ................................

Jakie sÄ… nastÄ™pne kroki?
Biuro ObsÅ‚ugi Klienta przygotowuje umowÄ™ on-line, ktÃ³ra zostanie wysÅ‚ana w oddzielnej wiadomoÅ›ci.
NastÄ™pnie po zaakceptowaniu umowy Biuro ObsÅ‚ugi Klienta kontaktuje siÄ™ z PaÅ„stwem celem ustalenia dogodnego terminu uruchomienia usÅ‚ugi.
Ostatni etap to wizyta technika, podczas ktÃ³rej zostaje uruchomiona usÅ‚uga. Po tej wizycie w Panelu Klienta pojawi siÄ™ pierwsza faktura.

W przypadku dodatkowych pytaÅ„ bÄ…dÅº wÄ…tpliwoÅ›ci proszÄ™ o kontakt.
`;

    return {
      INV: { to: "inwestycje@internetunion.pl", subject: subj_inv, body: body_inv },
      CLI: { to: email, subject: subj_cli, body: body_cli },
      STD: { to: email, subject: subj_std, body: body_std },
      DEV: { to: email, subject: subj_dev, body: body_dev }
    };
  }
  function composeAndSend(to, subject, body){
    const base = "mailto:"+encodeURIComponent(to||"")+"?subject="+encodeURIComponent(subject||"");
    const full = base + "&body=" + encodeURIComponent(body||"");
    if(full.length <= 1500){
      window.location.href = full;
    } else if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(body||"").then(()=>{ window.location.href = base; alert("TreÅ›Ä‡ zbyt dÅ‚uga â€“ skopiowano do schowka. Wklej w oknie poczty (Ctrl+V)."); });
    } else {
      window.location.href = base;
      alert("TreÅ›Ä‡ zbyt dÅ‚uga â€“ wklej rÄ™cznie.");
    }
  }

  /* =========================== ZAÅADUJ MSAL =========================== */
  try { await loadScriptSequential(MSAL_CDNS); }
  catch(e){ console.warn('MSAL script load failed (alcdn/jsDelivr/unpkg).', e); }
  if (typeof msal === 'undefined' || !msal.PublicClientApplication){ console.warn('MSAL not available at startup.'); }

  /* =========================== MSAL / GRAPH =========================== */
  let authInProgress = false;
  let msalApp = null;
  if (typeof msal !== 'undefined' && msal.PublicClientApplication){ msalApp = new msal.PublicClientApplication({
    auth: {
      clientId: CONFIG.clientId,
      authority: "https://login.microsoftonline.com/" + CONFIG.tenantId,
      redirectUri: "https://adiice.github.io/mapa-sidusis/mapa.html"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
    system: { loggerOptions: { loggerCallback: (l, m)=>console.log("[MSAL]", m) } }
  }); }
  const graphScopes = ["openid","profile","offline_access","Files.ReadWrite.All","Sites.Read.All"];

  // ================== Excel Workbook session + utilities ==================
  let workbookSessionId = null;
  let sessionCreatedAt = 0;

  function sleep(ms){ return new Promise(res=>setTimeout(res, Math.max(0, ms|0))); }
  function randomJitter(min=120,max=320){ return Math.floor(min + Math.random() * (max-min)); }

  async function ensureWorkbookSession(){
    const TWO_HOURS = 2 * 60 * 60 * 1000;
    const fresh = workbookSessionId && (Date.now() - sessionCreatedAt) < TWO_HOURS;
    if (fresh) return workbookSessionId;
    const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const token = await getToken();
    const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/createSession`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ persistChanges: true })
    });
    if(!resp.ok){
      const t = await resp.text().catch(()=>String(resp.status));
      throw new Error(`createSession failed ${resp.status} ${t}`);
    }
    const js = await resp.json();
    workbookSessionId = js && (js.id || js.sessionId || js.value || js);
    sessionCreatedAt = Date.now();
    return workbookSessionId;
  }

  // 429/5xx retry with Retry-After and backoff
  async function withGraphRetry(exec){
    let attempt = 0; let backoff = 800;
    while(true){
      const resp = await exec();
      const st = resp.status|0;
      if (st===429 || st===503 || st===504){
        attempt++;
        if(attempt>=3) return resp;
        let ra = resp.headers.get('Retry-After') || resp.headers.get('retry-after');
        let waitMs = 0;
        const n = parseInt(ra||'', 10);
        if(!isNaN(n) && n>0){ waitMs = n*1000; }
        else { waitMs = backoff; backoff = Math.min(6400, backoff*2); }
        await sleep(waitMs + randomJitter(80,150));
        continue;
      }
      return resp;
    }
  }

  // Single-writer queue for Excel writes
  const writeQueue = [];
  let writeActive = false;
  function queueWrite(fn){
    return new Promise((resolve, reject)=>{ writeQueue.push({fn,resolve,reject}); pumpQueue(); });
  }
  async function pumpQueue(){
    if(writeActive) return;
    const job = writeQueue.shift();
    if(!job) return;
    writeActive = true;
    try{ const res = await job.fn(); await sleep(randomJitter(150,320)); job.resolve(res); }
    catch(e){ job.reject(e); }
    finally{ writeActive=false; if(writeQueue.length) pumpQueue(); }
  }

  // ====== Sheet headers cache ======
  const SHEET_CACHE = { dataHeaders: null, dataHeaderIndex: {}, lastUsedRangeSnapshotTs: 0 };
  function buildHeaderIndex(headers){
    const map = {};
    const want = [ 'PH','Status','PowÃ³d odmowy','NextContactAt','LastTouchAt','Uwagi','ReminderTaskId','ReminderSentAt' ];
    for(const name of want){ const i = headers.indexOf(name); if(i>=0) map[name]=i; }
    return map;
  }
  function getHeaderIndex(name){
    if(!SHEET_CACHE.dataHeaderIndex) return -1;
    const v = SHEET_CACHE.dataHeaderIndex[name];
    return (typeof v==='number') ? v : -1;
  }

  async function ensureLogin(){
    // Lazy init MSAL if needed
    if(!msalApp){
      try { await loadScriptSequential(MSAL_CDNS); } catch(e){ console.warn('MSAL retry load failed:', e); }
      if (typeof msal !== 'undefined' && msal.PublicClientApplication){
        try{
          msalApp = new msal.PublicClientApplication({
            auth: { clientId: CONFIG.clientId, authority: "https://login.microsoftonline.com/" + CONFIG.tenantId, redirectUri: "https://adiice.github.io/mapa-sidusis/mapa.html" },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
            system: { loggerOptions: { loggerCallback: (l, m)=>console.log("[MSAL]", m) } }
          });
        }catch(e){ console.warn('MSAL init retry failed:', e); }
      }
      if(!msalApp){ showError('MSAL niedostÄ™pny. SprawdÅº poÅ‚Ä…czenie i sprÃ³buj ponownie.'); return; }
    }
    // jeÅ›li juÅ¼ mamy konto â€“ nic nie rÃ³b
    const accs = msalApp.getAllAccounts();
    if (accs.length) {
      account = accs[0];
      who.textContent = "Zalogowano: " + (account.username || account.homeAccountId);
      updateMissingPanel();
      return;
    }

    // nie otwieraj 2-giego popupu naraz
    if (authInProgress) return;
    authInProgress = true;
    try {
      const r = await msalApp.loginPopup({ scopes: graphScopes, prompt: "select_account" });
      account = r.account;
      who.textContent = "Zalogowano: " + (account.username || account.homeAccountId);
      updateMissingPanel();
    } finally {
      authInProgress = false;
    }
  }

  async function getToken(){
    if(!msalApp){ await ensureLogin(); }
    if(!msalApp){ throw new Error('MSAL niedostÄ™pny'); }
    // sprÃ³buj cicho, jeÅ›li nie wyjdzie â€“ popup tylko, gdy faktycznie wymagany
    const acc = msalApp.getAllAccounts()[0] || account;
    if (acc) account = acc;

    try {
      const r = await msalApp.acquireTokenSilent({ scopes: graphScopes, account });
      return r.accessToken;
    } catch (e) {
      // tylko wtedy prÃ³buj popup
      const needPopup =
        (e && (e.errorCode === "no_account_error" ||
               e.errorCode === "no_tokens_found" ||
               (e.errorCode && String(e.errorCode).includes("interaction_required"))));

      if (!needPopup) throw e;

      if (authInProgress) throw e; // poczekaj na trwajÄ…cÄ… interakcjÄ™

      authInProgress = true;
      try {
        const r = await msalApp.acquireTokenPopup({ scopes: graphScopes });
        account = r.account || account;
        return r.accessToken;
      } finally {
        authInProgress = false;
      }
    }
  }

  async function gfetch(method, url, body){
    const token = await getToken();
    try{ await ensureWorkbookSession(); }catch(e){ console.warn('ensureWorkbookSession failed:', e?.message||e); }
    const headers = { "Authorization":"Bearer " + token, "Accept":"application/json", "Content-Type":"application/json" };
    if(workbookSessionId){ headers["Workbook-Session-Id"] = workbookSessionId; }
    const resp = await withGraphRetry(()=> fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined }));
    if(!resp.ok){
      const txt=await resp.text().catch(()=>String(resp.status));
      throw new Error(`${method} ${url} -> ${resp.status} ${txt}`);
    }
    return resp.status===204 ? null : resp.json();
  }
  async function gBatch(requests){
    const token = await getToken();
    try{ await ensureWorkbookSession(); }catch(e){ console.warn('ensureWorkbookSession failed:', e?.message||e); }
    const headers = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
    if(workbookSessionId){ headers["Workbook-Session-Id"] = workbookSessionId; }
    const resp = await withGraphRetry(()=> fetch("https://graph.microsoft.com/v1.0/$batch", { method: "POST", headers, body: JSON.stringify({ requests }) }));
    const js = await resp.json();
    if (!resp.ok) {
      const msg = (js && js.error && js.error.message) ? js.error.message : JSON.stringify(js);
      throw new Error("Batch error: " + msg);
    }
    const bad = (js.responses || []).find(r => r.status < 200 || r.status >= 300);
    if (bad) throw new Error("Batch subrequest failed: " + bad.status + " " + JSON.stringify(bad.body||{}));
    return js;
  }
  async function getSiteId(){
    if(siteId) return siteId;
    const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG.spHost}:/sites/${CONFIG.spSitePath}`;
    const js = await gfetch("GET", url); siteId = js.id; return siteId;
  }
  async function getFileItemId(){
    if(fileId) return fileId;
    const sid = await getSiteId();
    const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/root:${encodeURI(CONFIG.filePath)}`;
    const js = await gfetch("GET", url); fileId = js.id; return fileId;
  }
  async function usedRange(wsName){
    const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const wsq = wsName.replace(/'/g,"''");
    const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/usedRange(valuesOnly=true)`;
    return gfetch("GET", url);
  }
  async function patchRange(wsName, a1, values2d){
    const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const wsq = wsName.replace(/'/g,"''");
    const url = `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='${a1}')`;
    return gfetch("PATCH", url, { values: values2d });
  }

  // Ensure required data headers exist (only on explicit reload)
  async function ensureDataHeaders(){
    const used = await usedRange(CONFIG.dataSheet);
    const headers = (used.values && used.values[0]) ? used.values[0].map(h=>String(h||"").trim()) : [];
    if(!headers.length){ return; }
    const required = [ 'PH','Status','PowÃ³d odmowy','NextContactAt','LastTouchAt','Uwagi','ReminderTaskId','ReminderSentAt' ];
    let changed = false;
    for(const name of required){ if(!headers.includes(name)){ headers.push(name); changed = true; } }
    if(changed){ await patchRange(CONFIG.dataSheet, `A1:${colLetter(headers.length)}1`, [headers]); }
    SHEET_CACHE.dataHeaders = headers;
    SHEET_CACHE.dataHeaderIndex = buildHeaderIndex(headers);
    SHEET_CACHE.lastUsedRangeSnapshotTs = Date.now();
  }

  /* ===== AuditLog ===== */
  const AUDIT_HEADERS = ["ts","user","action","itemId","adres_pelny","old","new","note"];

  async function ensureAuditHeaders(){
    const used = await usedRange(CONFIG.logSheet);
    const have = (used.values && used.values[0]) ? used.values[0].map(v=>String(v||"").trim()) : [];
    const need = AUDIT_HEADERS.some((h,i)=> (have[i]||"") !== h);
    if (need){
      const a1 = `A1:${colLetter(AUDIT_HEADERS.length)}1`;
      await patchRange(CONFIG.logSheet, a1, [AUDIT_HEADERS]);
    }
  }
  async function getNextLogRow(){
    const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const wsq = CONFIG.logSheet.replace(/'/g,"''");
    let next = 2;
    try{
      const used = await usedRange(CONFIG.logSheet);
      next = Math.max(2, (used.values||[]).length + 1);
      const probe = await gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='A${next-1}')?$select=values`);
      const prevVal = (((probe||{}).values||[])[0]||[])[0];
      if (prevVal && String(prevVal).trim() !== ""){
        const scan = await gfetch("GET", `https://graph.microsoft.com/v1.0/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsq}')/range(address='A1:A50000')?$select=values`);
        const col = (scan.values||[]).map(r => String((r||[])[0] ?? "").trim());
        let last = 1; for (let i=col.length-1;i>=0;i--){ if(col[i] !== ""){ last = i+1; break; } }
        next = Math.max(2, last + 1);
      }
    }catch(e){ console.warn("getNextLogRow:", e); }
    return next;
  }
  async function appendLog(row){
    await ensureAuditHeaders();
    const next = await getNextLogRow();
    const a1 = `A${next}:${colLetter(AUDIT_HEADERS.length)}${next}`;
    await patchRange(CONFIG.logSheet, a1, [row]);
  }

  /* =========================== DANE z Excela =========================== */
  function pickHeader(headers, tokens){
    const lc = headers.map(h => String(h||"").toLowerCase());
    for(const t of tokens){ const i = lc.findIndex(n => n.includes(t)); if(i>=0) return headers[i]; }
    return null;
  }

  // parse zwraca zarÃ³wno prawidÅ‚owe jak i brakujÄ…ce
  function parseRows(values){
    if(!values || !values.length) return { valid:[], missing:[] };
    const headers = (values[0]||[]).map(h=>String(h||"").trim());
    const body = values.slice(1);
    const H = {
      created: headers[0],
      lat:  pickHeader(headers,["lat","latitude","szerokoÅ›Ä‡","szerokosc"]),
      lon:  pickHeader(headers,["lon","longitude","dÅ‚ugoÅ›Ä‡","dlugosc"]),
      tel:  pickHeader(headers,["telefon","tel"]),
      mail: pickHeader(headers,["email","e-mail","mail"]),
      ph:   pickHeader(headers,["ph"]),
      st:   pickHeader(headers,["status"]),
      ulica:pickHeader(headers,["ulica","adres"]),
      nr:   pickHeader(headers,["nr budynku","numer","nr","nr domu"]),
      msc:  pickHeader(headers,["miejscowoÅ›Ä‡","miejscowosc","miasto"]),
      nazwa:pickHeader(headers,["zgÅ‚aszajÄ…cy","zglaszajacy","nazwa","imiÄ™","imie","nazwisko","klient","firma"]),
      adresPelny: pickHeader(headers,["adres_pelny","adres peÅ‚ny","adres pelny"]),
      powod: pickHeader(headers,["powÃ³d","powod","reason","powÃ³d odmowy","powod odmowy"]),
      notes: pickHeader(headers,["uwagi ph","uwagi","uwaga","notatki","note","notes"]),
      next:  pickHeader(headers,["nextcontactat","nastÄ™pny kontakt","nastepny kontakt","nast. kontakt","nast kontakt"]),
      last:  pickHeader(headers,["lasttouchat","ostatni kontakt","last touch","ostatni kontakt at"])
    };
    const get = (r, col) => { const idx=headers.indexOf(col); return idx>=0 ? r[idx] : ""; };

    let all = body.map((r, idx) => {
      let lat = toNum(get(r,H.lat));
      let lon = toNum(get(r,H.lon));
      let adr = get(r,H.adresPelny) || "";
      if(!adr){
        const u = String(get(r,H.ulica)||"").trim();
        const n = String(get(r,H.nr)||"").trim();
        const m = String(get(r,H.msc)||"").trim();
        adr = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
      }
      return {
        _row1: idx + 2,
        createdAt: toDate(get(r,H.created)),
        lat, lon, adres_pelny: adr||"",
        PH: canonPH(get(r,H.ph)),
        Status: canonStatus(String(get(r,H.st)||"")),
        telefon: String(get(r,H.tel)||""),
        email: String(get(r,H.mail)||""),
        nazwa: String(get(r,H.nazwa)||""),
        miejscowosc: String(get(r,H.msc)||""),
        PowodOdmowy: String(get(r,H.powod)||""),
        Uwagi: String(get(r,H.notes)||""),
        NextContactAt: toDate(get(r,H.next)) || null,
        LastTouchAt: toDate(get(r,H.last)) || null
      };
    });

    const validLat=v=>isFinite(v)&&v>=-90&&v<=90;
    const validLon=v=>isFinite(v)&&v>=-180&&v<=180;
    const okNormal = all.filter(o=>validLat(o.lat)&&validLon(o.lon)).length;
    const okSwapped= all.filter(o=>validLat(o.lon)&&validLon(o.lat)).length;
    if(okSwapped>okNormal){ all = all.map(o=>({ ...o, lat:o.lon, lon:o.lat })); }

    const valid = all.filter(o=>validLat(o.lat)&&validLon(o.lon));
    const missing = all.filter(o=>!(validLat(o.lat)&&validLon(o.lon)));
    return { valid, missing };
  }

  async function loadDataFromExcel(){
    setStatus("Åadowanie danych z Excela (Graph)â€¦");
    const used = await usedRange(CONFIG.dataSheet);
    const values = used.values || [];
    if(values.length){
      const headers = (values[0]||[]).map(h=>String(h||"").trim());
      SHEET_CACHE.dataHeaders = headers;
      SHEET_CACHE.dataHeaderIndex = buildHeaderIndex(headers);
      SHEET_CACHE.lastUsedRangeSnapshotTs = Date.now();
    }
    if(!values.length){ setStatus("Arkusz pusty."); rows=[]; frows=[]; missingRows=[]; updateMissingPanel(); return; }

    const parsed = parseRows(values);
    rows = parsed.valid;
    missingRows = parsed.missing;

    fillMiniFilters();
    frows = rows.slice();
    setStatus(`ZaÅ‚adowano ${rows.length} wierszy z arkusza â€${CONFIG.dataSheet}â€.`);
    updateMissingPanel();
  }

  /* =========================== FILTRY =========================== */
  function fillMiniFilters(){
    const phSel=$("#mfPH"); const stSel=$("#mfStatus");
    phSel.innerHTML = `<option value="">(wszyscy)</option>` + PH_LIST.map(ph=>`<option>${esc(ph)}</option>`).join("");
    stSel.innerHTML = `<option value="">(wszystkie)</option>` + STATUS_LIST.map(st=>`<option>${esc(st)}</option>`).join("");
  }
  function applyMiniFilters(){
    const wantPH = $("#mfPH").value.trim();
    const wantST = $("#mfStatus").value.trim();
    const query  = ($("#mfSearch").value || "").trim().toLowerCase();
    const dFrom  = $("#mfFrom").value ? new Date($("#mfFrom").value+"T00:00:00") : null;
    const dTo    = $("#mfTo").value   ? new Date($("#mfTo").value  +"T23:59:59") : null;

    frows = rows.filter(r=>{
      if(wantPH && (r.PH||"").trim() !== wantPH) return false;
      if(wantST && (r.Status||"").trim() !== wantST) return false;
      if(query){
        const inCity = String(r.miejscowosc||"").toLowerCase().includes(query);
        const inAddr = String(r.adres_pelny||"").toLowerCase().includes(query);
        if(!inCity && !inAddr) return false;
      }
      if (dFrom || dTo){
        if(!r.createdAt) return false;
        const t = r.createdAt;
        if(dFrom && t < dFrom) return false;
        if(dTo   && t > dTo)   return false;
      }
      return true;
    });
  }

  /* =========================== ZAPISY ($batch) =========================== */
  async function savePhStatus(rec, newPH, newStatus, newReason){
    const used = await usedRange(CONFIG.dataSheet);
    const vals = used.values || [];
    if(!vals.length) throw new Error("Arkusz pusty.");
    const headers = (vals[0]||[]).map(h=>String(h||"").trim());
    const body = vals.slice(1);

    const H = {
      adresPelny: pickHeader(headers,["adres_pelny","adres peÅ‚ny","adres pelny"]),
      ulica:      pickHeader(headers,["ulica","adres"]),
      nr:         pickHeader(headers,["nr budynku","numer","nr","nr domu"]),
      msc:        pickHeader(headers,["miejscowoÅ›Ä‡","miejscowosc","miasto"]),
      lat:        pickHeader(headers,["lat","latitude","szerokoÅ›Ä‡","szerokosc","punkt (y)","y"]),
      lon:        pickHeader(headers,["lon","longitude","dÅ‚ugoÅ›Ä‡","dlugosc","punkt (x)","x"]),
      ph:         pickHeader(headers,["ph"]),
      st:         pickHeader(headers,["status"]),
      reason:     pickHeader(headers,["powÃ³d","powod","reason","powÃ³d odmowy","powod odmowy"]),
      next:       pickHeader(headers,["nextcontactat","nastÄ™pny kontakt","nastepny kontakt","nast. kontakt","nast kontakt"]),
      last:       pickHeader(headers,["lasttouchat","ostatni kontakt","last touch","ostatni kontakt at"])
    };

    // Indeksy kolumn z cache (bez edycji naglowkow w trakcie zapisu)
    let idxPH  = getHeaderIndex('PH');
    let idxST  = getHeaderIndex('Status');
    let idxRS = -1;
    if(newStatus==="Odmowa klienta"){ idxRS = getHeaderIndex('Pow\u00F3d odmowy'); if(idxRS<0){ setStatus('Brakuje kolumny Powod odmowy - odswiez dane (przycisk u gory).'); return; } }
    let idxNEXT = getHeaderIndex('NextContactAt');
    let idxLAST = getHeaderIndex('LastTouchAt');
    if(idxPH<0 || idxST<0 || idxNEXT<0 || idxLAST<0){ const miss = [ [idxPH,'PH'],[idxST,'Status'],[idxNEXT,'NextContactAt'],[idxLAST,'LastTouchAt'] ].filter(x=>x[0]<0).map(x=>x[1]).join(', '); setStatus(`Brakuje kolumny ${miss} - odswiez dane (przycisk u gory).`); return; }
    // ZnajdÅº wiersz rekordu i odczytaj dotychczasowe wartoÅ›ci
    let row1 = Number(rec._row1) || -1, oldPH="", oldST="", oldNext="";
    if(row1>0){
      const row = body[row1-2] || [];
      oldPH = idxPH>=0 ? String(row[idxPH]||"") : "";
      oldST = idxST>=0 ? String(row[idxST]||"") : "";
      oldNext = idxNEXT>=0 ? String(row[idxNEXT]||"") : "";
    }else{
      const wantAddr = normAddr(rec.adres_pelny||"");
      for(let r=0; r<body.length; r++){
        const row = body[r]||[]; let adrRow = "";
        if(H.adresPelny){
          const i = headers.indexOf(H.adresPelny);
          adrRow = String(row[i]||"");
        }else{
          const u = H.ulica ? String(row[headers.indexOf(H.ulica)]||"").trim() : "";
          const n = H.nr    ? String(row[headers.indexOf(H.nr)]||"").trim()    : "";
          const m = H.msc   ? String(row[headers.indexOf(H.msc)]||"").trim()   : "";
          adrRow = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
        }
        if(wantAddr && normAddr(adrRow) === wantAddr){ row1 = r+2; }
        else if(H.lat && H.lon && isFinite(rec.lat) && isFinite(rec.lon)){
          const iLat = headers.indexOf(H.lat); const iLon = headers.indexOf(H.lon);
          const latR = toNum(row[iLat]); const lonR = toNum(row[iLon]);
          if(near(latR, rec.lat) && near(lonR, rec.lon)){ row1 = r+2; }
        }
        if(row1>0){
          oldPH = idxPH>=0 ? String(row[idxPH]||"") : "";
          oldST = idxST>=0 ? String(row[idxST]||"") : "";
          oldNext = idxNEXT>=0 ? String(row[idxNEXT]||"") : "";
          break;
        }
      }
      if(row1<0) throw new Error("Nie znaleziono pozycji w Excelu (dopasowanie po adresie i/lub wspÃ³Å‚rzÄ™dnych).");
      rec._row1 = row1;
    }

    // Przygotuj adresy A1 do zapisu
    const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const wsqData = CONFIG.dataSheet.replace(/'/g,"''");

    const a1PH     = `${colLetter(idxPH+1)}${row1}`;
    const a1ST     = `${colLetter(idxST+1)}${row1}`;
    const a1REASON = (idxRS>=0) ? `${colLetter(idxRS+1)}${row1}` : null;
    const a1NEXT   = `${colLetter(idxNEXT+1)}${row1}`;
    const a1LAST   = `${colLetter(idxLAST+1)}${row1}`;

    // Audit row
    await ensureAuditHeaders();
    const nextLog = await getNextLogRow();
    const logA1   = `A${nextLog}:${colLetter(AUDIT_HEADERS.length)}${nextLog}`;
    const now     = new Date().toISOString();
    const upn     = (account && (account.username||account.homeAccountId)) || "";
    const nowLocal = todayLocal();

    // Wylicz NextContactAt wg reguÅ‚
    const comp = computeNextContactAt(rec, newStatus);
    const statusChanged = String(oldST||"").trim() !== String(newStatus||"").trim();
    const hadNextBefore = !!String(oldNext||"").trim();
    const willWriteNext = statusChanged || !hadNextBefore;
    const nextCellValue = willWriteNext ? (comp.nextAt ? fmtYMD(comp.nextAt) : "") : null; // null => bez zmian
    const noteNextText  = willWriteNext ? (nextCellValue||'â€”') : (hadNextBefore ? oldNext : 'â€”');

    const logRow  = [ now, upn, "UpdatePHStatus", "", rec.adres_pelny||"", `${oldPH}|${oldST}`, `${newPH}|${newStatus}|${newReason||""}`, `NextContactAt=${noteNextText}; LastTouchAt=${fmtYMD(nowLocal)}; rule: ${comp.reasonText}` ];

    // Batch PATCH
    const requests = [
      { id: "ph", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqData}')/range(address='${a1PH}')`, headers: { "Content-Type": "application/json" }, body: { values: [[ newPH || "" ]] } },
      { id: "st", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqData}')/range(address='${a1ST}')`, headers: { "Content-Type": "application/json" }, body: { values: [[ newStatus || "" ]] } }
    ];
    if (a1REASON){
      requests.push({ id: "reason", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqData}')/range(address='${a1REASON}')`, headers: { "Content-Type": "application/json" }, body: { values: [[ newReason || "" ]] } });
    }
    // LastTouchAt zawsze dziÅ›
    requests.push({ id: "last", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqData}')/range(address='${a1LAST}')`, headers: { "Content-Type": "application/json" }, body: { values: [[ fmtYMD(nowLocal) ]] } });
    // NextContactAt wg reguÅ‚ (tylko gdy zmiana statusu lub byÅ‚o puste)
    if(nextCellValue!==null){
      requests.push({ id: "next", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqData}')/range(address='${a1NEXT}')`, headers: { "Content-Type": "application/json" }, body: { values: [[ nextCellValue ]] } });
    }
    const wsqLog = CONFIG.logSheet.replace(/'/g,"''");
    requests.push({ id: "log", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqLog}')/range(address='${logA1}')`, headers: { "Content-Type": "application/json" }, body: { values: [ logRow ] } });

    await queueWrite(()=> gBatch(requests));
    return { lastTouchAt: nowLocal, nextContactAt: (nextCellValue!==null ? (comp.nextAt || null) : (rec.NextContactAt || null)), wroteNext: (nextCellValue!==null) };
  }

  async function saveUwagi(rec, newNotes){
    const used = await usedRange(CONFIG.dataSheet);
    const vals = used.values || [];
    if(!vals.length) throw new Error("Arkusz pusty.");
    const headers = (vals[0]||[]).map(h=>String(h||"").trim());
    const body = vals.slice(1);

    const H = {
      adresPelny: pickHeader(headers,["adres_pelny","adres peÅ‚ny","adres pelny"]),
      ulica:      pickHeader(headers,["ulica","adres"]),
      nr:         pickHeader(headers,["nr budynku","numer","nr","nr domu"]),
      msc:        pickHeader(headers,["miejscowoÅ›Ä‡","miejscowosc","miasto"]),
      lat:        pickHeader(headers,["lat","latitude","szerokoÅ›Ä‡","szerokosc","punkt (y)","y"]),
      lon:        pickHeader(headers,["lon","longitude","dÅ‚ugoÅ›Ä‡","dlugosc","punkt (x)","x"]),
      notes:      pickHeader(headers,["uwagi ph","uwagi","uwaga","notatki","note","notes"])
    };

    let idxNotes = getHeaderIndex('Uwagi'); if(idxNotes < 0){ setStatus('Brakuje kolumny Uwagi - odswiez dane (przycisk u gory).'); return; }

    let row1 = Number(rec._row1) || -1, oldNotes = "";
    if(row1 > 0){
      const row = body[row1-2] || [];
      oldNotes = String(row[idxNotes]||"");
    }else{
      const wantAddr = normAddr(rec.adres_pelny||"");
      for(let r=0; r<body.length; r++){
        const row = body[r]||[]; let adrRow = "";
        if(H.adresPelny){ const i = headers.indexOf(H.adresPelny); adrRow = String(row[i]||""); }
        else{
          const u = H.ulica ? String(row[headers.indexOf(H.ulica)]||"").trim() : "";
          const n = H.nr    ? String(row[headers.indexOf(H.nr)]||"").trim()    : "";
          const m = H.msc   ? String(row[headers.indexOf(H.msc)]||"").trim()   : "";
          adrRow = (u && n && m) ? `ul. ${u} ${n}, ${m}` : (u+" "+n).trim() || m;
        }
        if(wantAddr && normAddr(adrRow) === wantAddr){ row1 = r+2; }
        else if(H.lat && H.lon && isFinite(rec.lat) && isFinite(rec.lon)){
          const iLat = headers.indexOf(H.lat); const iLon = headers.indexOf(H.lon);
          const latR = toNum(row[iLat]); const lonR = toNum(row[iLon]);
          if(near(latR, rec.lat) && near(lonR, rec.lon)){ row1 = r+2; }
        }
        if(row1 > 0){ oldNotes = String(row[idxNotes]||""); break; }
      }
      if(row1 < 0) throw new Error("Nie znaleziono pozycji w Excelu (dopasowanie po adresie i/lub wspÃ³Å‚rzÄ™dnych).");
      rec._row1 = row1;
    }

    const [sid, iid] = await Promise.all([getSiteId(), getFileItemId()]);
    const wsqData = CONFIG.dataSheet.replace(/'/g,"''");
    const a1NOTE  = `${colLetter(idxNotes+1)}${row1}`;

    await ensureAuditHeaders();
    const nextLog = await getNextLogRow();
    const logA1   = `A${nextLog}:${colLetter(AUDIT_HEADERS.length)}${nextLog}`;
    const now     = new Date().toISOString();
    const upn     = (account && (account.username||account.homeAccountId)) || "";
    const logRow  = [ now, upn, "UpdateUwagi", "", rec.adres_pelny||"", oldNotes, newNotes||"", "" ];

    const requests = [
      { id: "notes", method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${wsqData}')/range(address='${a1NOTE}')`, headers: { "Content-Type": "application/json" }, body: { values: [[ newNotes || "" ]] } },
      { id: "log",   method: "PATCH", url: `/sites/${sid}/drive/items/${iid}/workbook/worksheets('${CONFIG.logSheet.replace(/'/g,"''")}')/range(address='${logA1}')`, headers: { "Content-Type": "application/json" }, body: { values: [ logRow ] } }
    ];
    await queueWrite(()=> gBatch(requests));
  }

  /* Panel brakÃ³w â€“ odÅ›wieÅ¼anie i zwijanie */
  function updateMissingPanel(){
    const box = document.getElementById("missingBox");
    if(!box) return;
    if(!isPrivileged() || !missingRows.length){
      box.style.display = "none";
      return;
    }
    document.getElementById("missingCount").textContent = `(${missingRows.length})`;
    const list = document.getElementById("missingList");
    list.innerHTML = missingRows.slice(0,300).map(r =>
      `<li>${esc(r.nazwa||"-")} â€” ${esc(r.adres_pelny||"")} ${r.miejscowosc?("("+esc(r.miejscowosc)+")"):""}</li>`
    ).join("");
    box.style.display = "";
    const tg = document.getElementById("tgMissing");
    tg.onclick = () => {
      const collapsed = box.classList.toggle("collapsed");
      tg.textContent = collapsed ? "â¯ˆ" : "â¯…";
    };
  }

  /* =========================== UI =========================== */
  $("#btnLogin").addEventListener('click', async ()=>{ try{ await ensureLogin(); setStatus("Zalogowano."); updateMissingPanel(); }catch(err){ showError("Logowanie nieudane: " + (err.message||err)); } });
  $("#btnLogout").addEventListener('click', async ()=>{
    try{ const acc = msalApp ? msalApp.getAllAccounts()[0] : null; if(acc){ await msalApp.logoutPopup({ account: acc }); }
      account=null; who.textContent=""; setStatus("Wylogowano."); updateMissingPanel(); }catch(err){ showError("Wylogowanie nieudane: " + (err.message||err)); }
  });
  $("#btnReload").addEventListener('click', async ()=>{
    try{
      await ensureLogin();
      await getSiteId(); await getFileItemId();
      await ensureDataHeaders();
      await loadLists();  await loadStatusRules(); renderLegend();
      await loadDataFromExcel(); applyMiniFilters(); rebuild();
    } catch(err){ showError(err.message||err); }
  });

  $("#mfApply").addEventListener('click', ()=>{ applyMiniFilters(); rebuild(); });

  /* =========================== START =========================== */
  await loadLists();
  await loadStatusRules();
  initMap();
  renderLegend();
  attachToggle("toolbarBox","tgToolbar","toolbar");
  attachToggle("filtersBox","tgFilters","filters");
  attachToggle("legend","tgLegend","legend");
  setStatus(DEFAULT_STATUS);
  window.addEventListener('unhandledrejection', e=>showError(e.reason?.message||e.reason||"BÅ‚Ä…d"));
  (msalApp && msalApp.handleRedirectPromise ? msalApp.handleRedirectPromise().catch(e=>console.warn('MSAL redirect:', e)) : void 0);
})();
</script>
<div class="credit">Autor: Adrian Daniel</div>
</body>
</html>